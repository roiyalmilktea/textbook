<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>2018実践II</title>
<link rel="stylesheet" type="text/css" href="./files/manual.css">
<script language="javascript" src="./files/css.js"></script>
	
	<script type="text/javascript" src="./js/jquery-1.4.2.js"></script>
	<script type="text/javascript" src="./syntaxhighlighter/scripts/shCore.js"></script>
	<script type="text/javascript" src="./syntaxhighlighter/scripts/shBrushPhp.js"></script>
	<script type="text/javascript" src="./syntaxhighlighter/scripts/shBrushSql.js"></script>
	<script type="text/javascript" src="./syntaxhighlighter/scripts/shBrushXml.js"></script>
	<script type="text/javascript" src="./syntaxhighlighter/scripts/shBrushCss.js"></script>
	<link type="text/css" rel="stylesheet" href="./syntaxhighlighter/styles/shCoreDefault.css"/>
	<script type="text/javascript">SyntaxHighlighter.all();</script>  
</head>

<body>
<h1>PHPとMySQLによるWebアプリケーションの基礎</h1>
<form>
  <div class="ar"> 
		<input type="button" value="標準" onClick="css_print()">
		<input type="button" value="拡大" onClick="css_presen()">
  </div>
</form>

<h2>chapter 6 BBS</h2>
<h3>6.1　簡単なBBS（タイプ１）</h3>
<p>簡単な電子掲示板（BBS:Bulletin Board System)を作成することにより，以下のWebアプリケーションの基礎技術を習得します． 
</p> 
<p>・フォームによるデータの送信<br>
    ・サーバによるデータの受信<br>
    ・受信したデータのデータベースへの保存<br>
    ・データベースのデータの一覧表示<br>
    ・データベースのデータの検索表示 </p>

<h4>6.1.1　データベースの作成</h4>
<p>BBSの記事は，もっとも基本的な以下の５項目のみを含む簡単なものとします．これをタイプ１BBSと呼ぶこととします．</p> 
  <table border="1" cellpadding="0" cellspacing="0" class="print">
    <tbody><tr class="print"> 
      <td class="print">フィールド名</td>
      <td class="print">型</td>
      <td class="print">長さ</td>
      <td class="print">説明</td>
      <td class="print">備考</td>
    </tr>
    <tr> 
      <td class="print">message_id</td>
      <td class="print">INTEGER</td>
      <td class="print">　</td>
      <td class="print">記事番号</td>
      <td class="print">主キー：自動入力</td>
    </tr>
    <tr> 
      <td class="print">name</td>
      <td class="print">CHAR</td>
      <td class="print">64</td>
      <td class="print">投稿者氏名</td>
      <td class="print">ブラウザから入力</td>
    </tr>
    <tr> 
      <td class="print">title</td>
      <td class="print">VARCHAR</td>
      <td class="print">255</td>
      <td class="print">タイトル</td>
      <td class="print">ブラウザから入力</td>
    </tr>
    <tr> 
      <td class="print">message</td>
      <td class="print">TEXT</td>
      <td class="print">　</td>
      <td class="print">記事本文</td>
      <td class="print">ブラウザから入力</td>
    </tr>
    <tr> 
      <td class="print">date</td>
      <td class="print">DATETIME</td>
      <td class="print">　</td>
      <td class="print">投稿日時</td>
      <td class="print">自動入力</td>
    </tr>
  </tbody></table>
<p>データベース名を「db_bbs」とすします．上記のテーブル名を「tbl_bbs1」とします．</p><p>テーブル作成用のSQL文は次のようになります．</p> 
  <pre class="brush:sql;">
CREATE TABLE tbl_bbs1
(
 message_id INTEGER,
 name    CHAR(64),
 title   VARCHAR(255),
 message  TEXT,
 date    DATETIME,
 PRIMARY KEY(message_id)
) ENGINE = MYISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci
</pre>

<p>以下，「db_bbs」データベースおよび「tbl_bbs1」テーブルは，コマンドクライアントｍｙｓｑｌか，GUIのｐｈｐMyAdminで作成してあるものとします．</p>
 
  <img src="./files/chap6_02.jpg" width="600">


<h4>6.1.2　記事入力フォームの表示</h4>
<p>ブラウザからは，BBSの１件の記事につき，「氏名」，「タイトル」および「記事」をフォームオブジェクト（&lt;form&gt;タグ）により入力することとします．POSTメソッドを使い，「送信」ボタンを押すとこれらの入力データをサーバ側の「main01.html」ファイルに送信することとします．TEXT要素の場合は，「type="text"」属性は省略可能です．</p> 
  <p class="command-print">&lt;input　type="text" name="名前"&gt;は，&lt;input 
    name="名前"&gt;と省略可能</p>
<p>各要素に初期値を設定しない場合は，「ｖａｌｕｅ="値"」属性は省略可能です．</p> 
  <p class="command-print">&lt;input name="名前"&gt;　　　　　　　 　：初期値を設定しない場合<br>
    <br>
    &lt;input name="名前" value="値"&gt;　：初期値を設定する場合</p>
<p>サンプルリストを「main01.html」に示します．</p> 
  <pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
BBS1&lt;br&gt;
&lt;form method="post" action="main01.php"&gt;
  氏名&lt;input name="name" size="30"&gt;&lt;br&gt;
タイトル&lt;input name="title" size="60"&gt;&lt;br&gt;
  記事&lt;textarea name="message" rows="5" cols="60"&gt;&lt;/textarea&gt;&lt;br&gt;
    &lt;input type=submit name="command" value="送信"&gt;&lt;br&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>アクセスした結果，以下のように表示されます．</p>

<img src="./files/1050101.png" width="600">

<h4>6.1.3　データの受信</h4>
<p>ブラウザからのデータはPOSTメソッドで，「meia01.ｐｈｐファイルに送信されるので，POSTメソッドで受信します．</p> 
  <p class="command-print">&lt;input name="名前" value="値"&gt;<br>
    <br>
    の入力フォームで，ＰＯＳＴメソッドで送信されたデータの値は，<br>
    <br>
    $_POST_['名前'] <br>
    <br>
    で受信する． $_POST[ ]は，PHPで定義されたスーパグローバル変数と呼ばれる連想配列です．</p>
  <p class="caution-print">PHPでは，POSTメソッドで入力フォームの値を送信すると，入力フォームのname属性の値をそのまま変数として使用できるようにする環境設定方法もあります．<br>
    　　 （例） &lt;input name="message"&gt;の場合，受信側ファイル（action属性で指定されたファイル）では，<br>
    　　　　　 変数$messageが自動的に定義され，$message変数に自動的に入力フォームで入力した値が<br>
    　　　　　 受信され代入される．<br>
    ただ，環境設定が定かでないない場合もありますので，できるだけ$_POST['名前']を使って，明示的に変数を定義し，データを受信することを勧めます．<br>
    　　（例） &lt;input name="message"&gt;の場合，<br>
    　　　　　　　$message = $_POST['message'] ;<br>
    　　　　　とします．受信する側の変数名は自由に定義できますので，<br>
    　　　　　　　 $str = $_POST['message'] ;<br>
    　　　　　のように変更することもできます． </p>

<p>このような送信されてきた値の受信処理は，静的なHTMLファイルでは実行できないので，ここではPHP言語スクリプト（以下PHPと呼ぶ）を使うこととします．PHPのスクリプト（ソースプログラム）は，HTMLファイルの中に簡単に混在して記述することが可能です．HTMLの記述からPHPのスクリプトに移る場合は，「&lt;?PHP」の文字列を使います．これをデリミタといいます．逆にPHPのスクリプトからHTMLのスクリプトに移るには，「?&gt;」の文字列を使います．HTMLファイル内にPHPのスクリプトを記述した場合は，拡張子はもはや「.html」でなく，「.php」に変更する必要があります．</p>
 
  <p class="caution-print">　文字列中に変数の値を挿入したい場合は，変数名を「{　}」で囲みます．かつ文字列全体を「"」（ダブルクオーテーション）で囲む必要があります．「'」（シングルクオーテーション）で囲むと，変数名の値が評価されて挿入されるのではなく，変数名がそのまま挿入されますから，十分注意が必要です．</p>
<p>「main01.php」ファイルでは，POSTメソッドで受信したデータを，確認のためにブラウザに表示するようにしています．</p> 
  <pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

 // データの受信
 $str_name   = $_POST['name'];
 $str_title  = $_POST['title'];
 $str_message = $_POST['message'];

 // 受信データの表示（仮）
 print "  氏名：[{$str_name}]&lt;br&gt;\n";
 print "タイトル：[{$str_title}]&lt;br&gt;\n";
 print "  記事：[{$str_message}]&lt;br&gt;\n";


?&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>「main01.html」ファイルにたとえば，以下のように文字を記入します．</p>

<img src="./files/1050102.png" width="600">

<p>「送信」ボタンをクリックすると，結果は次のようになります．</p>
 
<img src="./files/1050103.png" width="600">

<h4>6.1.4　入力フォームを記述したファイルと受信処理をするファイルを一つのファイルにまとめる</h4>
<p>上記の例では，入力フォームをブラウザに表示しデータをサーバに送信するファイルmain01.htmlと，ブラウザから送信されてえきたデータを受信し，受信データを表示するファイルmain01.phpを別々のファイルとしていました．</p> 
  <table border="0">
    <tbody><tr> 
      <td valign="top" class="print"> 
        <table border="1" cellpadding="0" cellspacing="0">
          <tbody><tr> 
            <td>main01.html</td>
          </tr>
        </tbody></table>
        <br>
        ・データ入力<br>
        ・データ送信 </td>
      <td valign="top" class="print"> ============&gt;<br>
        データの送信<br>
        （POSTメソッド） </td>
      <td valign="top" class="print"> 
        <table border="1" cellspacing="0" cellpadding="0">
          <tbody><tr> 
            <td>main01.php</td>
          </tr>
        </tbody></table>
        <br>
        ・データ受信<br>
        ・データ表示 </td>
    </tr>
  </tbody></table>

<p>双方のファイルで処理する内容が大きく異なる場合は，このようにファイルを別々にすることは，設計方法として自然なのですが，双方のファイルで類似の処理をするような場合は，双方のファイルをまとめて一つのファイルにしておいた方が効率がいい場合もあります．たとえば，この後説明するように，受信したデータをブラウザに一覧表示しながら，同じ画面でさらに新たにデータを入力するような場合などです．ここでは，main01.htmlファイルとmain01.phpファイルを一つのファイルmain01a.phpにまとめて処理する場合のスクリプトの記述法について示します．</p>
 
  <table border="0">
    <tbody><tr> 
      <td valign="top" class="print"> 
        <table border="1" cellpadding="0" cellspacing="0">
          <tbody><tr> 
            <td>main01a.php</td>
          </tr>
        </tbody></table>
        <br>
        ・データ入力<br>
        ・データ送信 </td>
      <td valign="top" class="print"> 
        <div align="center"> ============&gt;<br>
          データの送信<br>
          （POSTメソッド） </div>
      </td>
      <td valign="top" class="print"> 
        <table border="1" cellspacing="0" cellpadding="0">
          <tbody><tr> 
            <td>main01a.php(自分自身のファイル）</td>
          </tr>
        </tbody></table>
        <p align="center"> ・データ受信<br>
          ・データ表示 </p>
      </td>
    </tr>
  </tbody></table>

<p>一般に，一つのファイルで異なる処理を実行する場合は，一連の処理の流れをいくつかの「状態」に分けて，「状態」ごとに条件分岐してそれぞれの処理を実行するようにします．ここでは，「状態」は大きく二つあります．つまり，ファイルに最初にアクセスした状態と，「送信」ボタンを押した後の状態です．これをどう識別するかが，スクリプトの設計上重要になりますが，上記の例では「送信」ボタンが押された状態では，$_POST['command']に「送信」という文字列が代入されおり，「送信」ボタンが押されていない最初の状態では，$_POST['command']の値は空（null）です．したがって，スクリプトの流れとしては，概略以下のようにすればいいことがわかります．</p>
 
  <div class="command-print"> ○$_POST['command']の値が「送信」の場合 
     ・データの受信処<br>
      ・受信データの表示 <br>
      ・入力フォームの表示 <br>
      ・データ入力<br>
      ・データ送信 
    ○$_POST['command']の値が「空」の場合 
     ・入力フォームの表示 <br>
      ・データ入力<br>
      ・データ送信 
  </div>
<p>これをif文で記述すると次のようになります．</p> 
  <div class="command-print"> if($_POST['command'] == "送信")<br>
    { 
     ・データの受信処<br>
      ・受信データの表示 <br>
      ・入力フォームの表示 <br>
      ・データ入力<br>
      ・データ送信 
    }<br>
    elseif( $_POST['command'] == "")<br>
    { 
     ・入力フォームの表示 <br>
      ・データ入力<br>
      ・データ送信 
    } </div>
<p>ただ，よくみると，・入力フォームの表示， ・データ入力， ・データ送信 の処理は両方の「状態」にあるので，簡略化して以下のように記述できます．</p> 
  <div class="command-print"> if($_POST['command'] == "送信")<br>
    { 
     ・データの受信処<br>
      ・受信データの表示 
    }<br>
    ・入力フォームの表示 <br>
    ・データ入力<br>
    ・データ送信 </div>
<p>以上のような，スクリプトの設計の考え方にもとづいた，ソースリストの例を「main01a.php」に示します．</p> 
   
    <p class="caution-print">読みやすく，デバグのしやすいプログラムを記述するためには，特に以下を心がけます．<br>
      <br>
      ・「{」ごとに字下げ</h4>（インデント）を行う．階層的な記述をこころがける．１回の字下げは２縲怩S文字くらい．<br>
      ・主な処理単位ごとに，コメント行</h4>を挿入し，どのような処理をしているかわかるようにする．<br>
      ・空白行</h4>を挿入し，わかりやすくする． <br>
      ・文字列型変数には，「str_」の接頭辞をつけて，数値型変数など他の型の変数と区別する．</p>
  
main01a.php
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

// 「送信」の場合
if($_POST['command'])&&$_POST['command'] == "送信")
{
 // データの受信
 $str_name   = $_POST['name'];
 $str_title  = $_POST['title'];
 $str_message = $_POST['message'];

 // 受信データの表示（仮）
 print "  氏名：[{$str_name}]&lt;br&gt;\n";
 print "タイトル：[{$str_title}]&lt;br&gt;\n";
 print "  記事：[{$str_message}]&lt;br&gt;\n";

}
?&gt;
BBS1&lt;br&gt;
&lt;form method="post" action="main01a.php"&gt;
  氏名&lt;input name="name" size="30"&gt;&lt;br&gt;
タイトル&lt;input name="title" size="60"&gt;&lt;br&gt;
  記事&lt;textarea name="message" rows="5" cols="60"&gt;&lt;/textarea&gt;&lt;br&gt;
    &lt;input type=submit name="command" value="送信"&gt;&lt;br&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>main01a.phpファイルにアクセスし，上記と同じ内容を記入し「送信」ボタンをクリックすると，以下のように表示されます．</p>
 
<img src="./files/1050104.png" width="600">


<h4>6.1.5　改行コードの改行タグへの変換</h4>
<p>「main01a.php」ファイルにアクセスした結果のブラウザ画面をみると，TEXTAREA要素に記述した「改行」が正しく反映されていないことがわかります．本来３行に分けて表示されるべきところが，１行にまとめて表示されています．これは，TEXTAREA要素内での改行コードは「\r\n」（Windowsの場合）であるのに対して，print文で出力される先のHTMLファイル内での改行は「&lt;br&gt;」タグつまり改行タグにより実行されることによります．つまり，HTMLファイル内では改行コード「\r\n」は無視されてしまいます．したがって，TEXTAREA要素内の文字列をHTMLファイル内に表示する場合は，改行コード「\r\n」を改行タグ「&lt;br&gt;」に変換する必要があります．これは，PHPの組み込み関数「preg_replace()」関数で実行することができます．</p>
 
  <p class="command-print">変換後全体文字列　=　preg_replace(置換対象文字列，置換後文字列<br>
    　　　　　　　　　　　　　　　　　　　　　 ，変換対象全文字列)<br>
    <br>
    　　　　置換対象文字列は，Perl互換正規表現文字列で記述．</p>
<p>サンプルリストを「main01b.php」に示します．</p> 
<p>&lt;form&gt;タグ内で，「action='ファイル名'」属性を省略することができます．この場合，ファイル名は自分自身のファイル名とみなされます．<br>
    以下，，「action='ファイル名'」属性は省略することとします．</p>
  <p class="caution-print">PHPには改行コードを改行タグに変換する組み込み関数「nl2br()」関数があります．ただし，「nl2br()」関数の場合は，改行コードはそのまま残されるの注意が必要です．<br>
  </p>
main01b.php
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

// 「送信」の場合
if(isset($_POST['command'])&&$_POST['command'] == "送信")
{
 // データの受信
 $str_name   = $_POST['name'];
 $str_title  = $_POST['title'];
 $str_message = $_POST['message'];

 // 改行コードを改行タグに変換
 $str_message 
   = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);

 // データの表示（仮）
 print "  氏名：[{$str_name}]&lt;br&gt;\n";
 print "タイトル：[{$str_title}]&lt;br&gt;\n";
 print "  記事：[{$str_message}]&lt;br&gt;\n";
}
?&gt;
BBS1&lt;br&gt;
&lt;form method="post"&gt;
  氏名&lt;input name="name" size="30"&gt;&lt;br&gt;
タイトル&lt;input name="title" size="60"&gt;&lt;br&gt;
  記事&lt;textarea name="message" rows="5" cols="60"&gt;&lt;/textarea&gt;&lt;br&gt;
    &lt;input type=submit name="command" value="送信"&gt;&lt;br&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
  </pre>

<p>「main01b.php」ファイルにアクセスし，上記と同じ内容を記入し，「送信」ボタンをクリックした結果は，以下のようになります．改行されているのがわかります．</p>
 
		<img src="./files/1050105.png" width="600">


<h4>6.1.6　表によるレイアウト</h4>
<p>「main01b.php」ファイルにアクセスした結果は，改行はされるのですが，改行後の左端が揃っていません．そこで，文字列の表示をテーブル（表）タグを使って，きれいに表示することとします．これを表によるレイアウトといいます．表によるレイアウトで，表の罫線をみせたくない場合は，「tableタグ」の「bordeer」属性の値を「0」（ゼロ）に設定します．サンプルリストを「main01c.php」に示します．ここでは受信データの表示と，入力フォームの表示の双方に表によるレイアウトを使用しています．</p>

<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

// 「送信」の場合
if(isset($_POST['command'])&&$_POST['command'] == "送信")
{
 // データの受信
 $str_name  = $_POST['name'];
 $str_title  = $_POST['title'];
 $str_message = $_POST['message'];

 // 改行コードを改行タグに変換
 $str_message 
   = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);

 // 受信データの表示（仮）
?&gt;
 &lt;p align=center&gt;
 &lt;table border="1" cellpadding="3" cellspacing="0"&gt;
 &lt;tr&gt;
  &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;?=$str_name?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;?=$str_title?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;&lt;td&gt;&lt;?=$str_message?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/table&gt;
&lt;/p&gt;
&lt;?php
}
?&gt;
&lt;p align=center&gt;
&lt;table border="0"&gt;
&lt;form method="post"&gt;
&lt;tr&gt;
 &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="30"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt;記事&lt;/td&gt;
 &lt;td&gt;&lt;textarea name="message" rows="5" cols="60"&gt;&lt;/textarea&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/form&gt;
&lt;/table&gt;
&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>「main01c.php」ファイルにアクセスし上記と同じ内容を記入し，「送信」ボタンをクリックした結果は，以下のようになります．「記事」欄がきれいに改行され表示されています．</p>
 
		<img src="./files/1050106.png" width="600">


<h4>6.1.7　投稿日時の取得</h4>
<p>投稿日時は，システム側で取得します．PHPの組み込み関数の「date()」関数と「time()」関数を使います．</p> 
<p><font color="#000000" class="command-print">$str_date = date("Y-m-d 
    H:i:s",time())</font></p>
<p>結果は「2006-11-23　13:45:00」のような文字列になります． </p>

<h4>6.1.8　記事番号の生成</h4>
<p>投稿記事の番号（記事番号）は，tbl_bbs1テーブルのmessage_idフィールドに保存することとします．新しい記事番号は，既存の記事番号の最大値＋１とすることとします．そこで，message_idフィールドの最大値を，変数「max_id」に保存する次のようなSQL文を実行します．</p>
 
<p><font color="#000000" class="command-print">"select max(message_id) 
    as max_id from tbl_bbs1;"</font></p>
<p>この変数「max_id」の値は，SQL文を実行した後のレコードセットの連想配列の「max_id」というキー値をもつ配列要素の値として参照することができます．記事が全くない状態では，この最大値はnullなので，初期値を「1」に設定します．</p>

<h4>6.1.9　記事データのテーブルへの保存</h4>
<p>以上で，一つの記事についてtbl_bbs1テーブルに保存するすべてのフィールドの値が確定するので，SQLのinsert文を用いてテーブルにデータを保存します．</p> 
  <p class="command-print"><font color="#000000">"insert into tbl_bbs1 
    "<br>
    　　　　　　. "(message_id,name,title,message,date)"<br>
    　　　　　　. "values("<br>
    　　　　　　. $new_id　　 . ",'"　. $str_name 　　. "','" <br>
    　　　　　　. $str_title　. "','" . $str_message . "','" 
    <br>
    　　　　　　. $str_date . "');";</font></p>

<p>文字列の場合は，変数を「'」で囲む必要があります．以上，投稿日時の取得，記事番号の生成および記事データの保存を実行するサンプルリストを「main01d.php」に示します．なお，レイアウトの表の幅を，みやすいように「width」属性で指定しています．また，表全体もブラウザの中央にくるように，pタグのスタイル属性でセンタリングしています．</p>  
main01e.php
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

// 「送信」の場合
if(isset($_POST['command'])&&$_POST['command'] == "送信")
{
 // データの受信
 $str_name   = $_POST['name'];
 $str_title  = $_POST['title'];
 $str_message = $_POST['message'];

 // 改行コードを改行タグに変換
 $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);

 // 現在日時の取得
 $str_date = date("Y-m-d H:i:s",time());

 // 「message_id」の生成
 // データベースへの接続
 // 「message_id」の生成
 // データベースへの接続
 $mysqli = new mysqli($hostname, $username, $password, $database);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 


 // tbl_bbs1テーブルのmessage_idの最大値の取得
 $str_sql 
   = "select max(message_id) as max_id from tbl_bbs1;";
 $rs = $mysqli->query($str_sql);

 $arr_record = array();
 $arr_record = $rs->fetch_assoc();
 $max_id = $arr_record['max_id'];

 if($max_id &gt; 0)
 {
  $new_id = $max_id + 1;
 }
 else
 {
  $new_id = 1;
 }

 // データのテーブルへの保存
 $str_sql = "insert into tbl_bbs1 "
      . "(message_id,name,title,message,date)"
      . "values("
      . $new_id   . ",'" . $str_name   . "','" 
      . $str_title . "','" . $str_message . "','" 
      . $str_date . "');";

 $mysqli->query($str_sql);

 // テーブルのデータの一覧取得
 $str_sql = "select * from tbl_bbs1 order by message_id desc;";

 $rs = $mysqli->query($str_sql);

 // データの表示
 while($arr_record = $rs->fetch_assoc())
 {
  $message_id = $arr_record['message_id'];
  $str_name  = $arr_record['name'];
  $str_title  = $arr_record['title'];
  $str_message = $arr_record['message'];
  $str_date  = $arr_record['date'];

?&gt;
  &lt;p align=center&gt;
  &lt;table border="1" cellpadding="3" cellspacing="0" width="600"&gt;
  &lt;tr&gt;
   &lt;td width="60"&gt;No.&lt;/td&gt;&lt;td width="440"&gt;&lt;?=$message_id?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;?=$str_name?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;?=$str_title?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td&gt;記事&lt;/td&gt;&lt;td&gt;&lt;?=$str_message?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td&gt;日時&lt;/td&gt;&lt;td&gt;&lt;?=$str_date?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;/table&gt;
  &lt;/p&gt;
  &lt;br&gt;
&lt;?php
 }
 //結果セットを破棄し，接続を閉じる
 mysqli_free_result($rs);
 $db = $mysqli->close();
}
?&gt;
 &lt;p align=center&gt;
 &lt;table border="0"&gt;
 &lt;form method="post"&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="30"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;
  &lt;td&gt;&lt;textarea name="message" rows="5" cols="60"&gt;&lt;/textarea&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;
  &lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
 &lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>「main01e.php」ファイルへのアクセス結果を以下に示します． フォームに記入し，送信したデータが正常にデータベースに保存され，確認のために表示したデータが正常に表示されているのがわかります．記事番号（No.欄）と日時も正常に表示されています．</p>
 
		<img src="./files/chap6_01.png" width="600">

 
		<img src="./files/chap6_03.png" width="600">

<p>phpMyAdminを使って，データベースのテーブル内にデータが挿入されていることを確認します．</p>
 
		<img src="./files/chap6_04.png" width="600">


<h4>6.1.10　MySQLの設定ファイルの作成</h4>
<p>ファイルが増えていった場合，全てのファイルにMySQLのユーザ名とパスワードを書いておくと，もしユーザ名やパスワードに変更があった場合，ファイルを一つずつ直していかなくてはなりません．大変な手間がかかります．そこで，MySQLのユーザ名，パスワードをファイルから分離させて，各ファイルから分離させたファイルを読み込むようにします．そうすることで，もしユーザ名やパスワードに変更があった場合でも，1カ所書き換えるだけで良くなります．</p>
<p>「main01d.php」がある場所に「Connection」という名前でディレクトリを作成します．その中に，「localhost.php」という名前で次のコードを記述します．</p>

localhost.php
<pre class="brush:php;">
&lt;?php

// 「送信」の場合
if($_POST['command'] == "送信")
{
 // MySQLのホスト名
 $hostname = "localhost";
 // MySQLのデータベース名
 $database = "db_bbs";
 // MySQLのユーザID
 $username = "webapl";
 // MySQLのパスワード
 $password = "pass1234";
?&gt;
</pre>

<p>「main01d.php」を「main01e.php」として次のように書き換えます．</p>
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

require_once('./Connections/localhost.php');
// 「送信」の場合
if(isset($_POST['command'])&&$_POST['command'] == "送信")
{
 // データの受信
 $str_name   = $_POST['name'];
 $str_title  = $_POST['title'];
 $str_message = $_POST['message'];

 // 改行コードを改行タグに変換
 $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);

 // 現在日時の取得
 $str_date = date("Y-m-d H:i:s",time());

 // 「message_id」の生成
 // データベースへの接続
 // 「message_id」の生成
 // データベースへの接続
 $mysqli = new mysqli($hostname, $username, $password, $database);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 


 // 以下は，「main01d.php」と同様ですので省略します．
</pre>

<h4>6.1.10　一般的な記事表示形式</h4>
<p>記事本文の表示形式を，以下のような一般的な表示形式に変更します．</p>
 
  <table width="450" border="1" cellspacing="0" cellpadding="0">
    <tbody><tr> 
      <td>No番号 タイトル[氏名]日時</td>
    </tr>
    <tr> 
      <td> 
        
<p>　　記事本文</p>
        
      </td>
    </tr>
  </tbody></table>
<p>この場合は，表によるレイアウトを下記サンプルのように変更します．</p> 
  <p class="command-print">　　&lt;table border="1" cellpadding="3" 
    cellspacing="0" width="600"&gt;<br>
    　　&lt;tr&gt;<br>
    　　　&lt;td &gt;No.&lt;?=$message_id?&gt;　&lt;?=$str_title?&gt;　[&lt;?=$str_name?&gt;]　&lt;?=$str_date?&gt;&lt;/td&gt;<br>
    　　&lt;/tr&gt;<br>
    　　&lt;tr&gt;<br>
    　　　&lt;td&gt;&lt;?=$str_message?&gt;&lt;/td&gt;<br>
    　　&lt;/tr&gt;<br>
    　　&lt;/table&gt;<br>
  </p>


<h4>6.1.11　記事本文表示処理の関数化</h4>
<p>記事本文の表示はこの後，検索結果記事本文の表示等いろんな場面で使います．そこで，記事本文の表示処理のための関数を「message_disp()」関数として作成しておき，利用することとします．なお，１個の記事に関するデータは，あらかじめ以下の連想配列$arr_messageに保存されているものとします．</p>
 
  <table border="0" cellspacing="0" cellpadding="0" class="print">
    <tbody><tr> 
      <td class="print">$arr_message[id'']</td>
      <td class="print">：記事番号</td>
    </tr>
    <tr> 
      <td class="print">$arr_message['title']</td>
      <td class="print"> ：タイトル</td>
    </tr>
    <tr> 
      <td class="print">$arr_message['name'] </td>
      <td class="print">：氏名</td>
    </tr>
    <tr> 
      <td class="print">$arr_message['date']</td>
      <td class="print">：日時</td>
    </tr>
    <tr> 
      <td class="print">$arr_message[message']</td>
      <td class="print">：本文</td>
    </tr>
  </tbody></table>
<p>「message_disp()」関数のサンプルリストを以下に示します．</p> 
  <p class="command-print">// 1個の記事本文の表示<br>
    function message_disp(&amp;$arr_message)<br>
    {<br>
    /*<br>
    $arr_message['id'] ：記事番号<br>
    $arr_message['name'] ：投稿者氏名<br>
    $arr_message['title'] ：記事タイトル<br>
    $arr_message['message'] ：記事本文<br>
    $arr_message['date'] ：投稿日時<br>
    */<br>
    <br>
    ?&gt;<br>
    　&lt;table border="1" cellpadding="3" cellspacing="0" 
    width="600"&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;<br>
    　　　　　［&lt;?=$arr_message['name']?&gt;］　&lt;?=$str_date?&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;/table&gt;<br>
    &lt;?php<br>
    }</p>
<p> 「message_disp()」関数を使用した場合の全体のサンプルリストを「main01f.php」に示します． </p> 
main01f.php
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

// 「送信」の場合
if(isset($_POST['command'])&&$_POST['command'] == "送信")
{
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];

 // 改行コードを改行タグに変換
 $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);

 // 現在日時の取得
 $str_date = date("Y-m-d H:i:s",time());

 // 「message_id」の生成
 // データベースへの接続
 // データベースサーバへの接続・データベースの選択
 $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 

 // tbl_bbs1テーブルのmessage_idの最大値の取得
 $str_sql 
   = "select max(message_id) as max_id from tbl_bbs1;";
 $rs = $mysqli->query($str_sql);

 $arr_record = array();
 $arr_record = $rs->fetch_assoc();
 $max_id = $arr_record['max_id'];

 if($max_id &gt; 0)
 {
  $new_id = $max_id + 1;
 }
 else
 {
  $new_id = 1;
 }

 // データのテーブルへの保存
 $str_sql = "insert into tbl_bbs1 "
      . "(message_id,name,title,message,date)"
      . "values("
      . $new_id   . ",'" . $str_name   . "','" 
      . $str_title . "','" . $str_message . "','" 
      . $str_date . "');";

 $mysqli->query($str_sql);

 // テーブルのデータの一覧取得
 $str_sql = "select * from tbl_bbs1 order by message_id desc;";
 $rs = $mysqli->query($str_sql);

 // データの表示
 print "&lt;p align=center&gt;";

 while($arr_record = $rs->fetch_assoc())
 {
  // 記事データの配列への格納
  $arr_message = array();

  $arr_message['id']    = $arr_record['message_id'];
  $arr_message['name']   = $arr_record['name'];
  $arr_message['title']   = $arr_record['title'];
  $arr_message['message'] = $arr_record['message'];
  $arr_message['date']   = $arr_record['date'];

  // 1個の記事本文の表示
  message_disp($arr_message);

 }

 print "&lt;/p&gt;";

 //結果セットを破棄し，接続を閉じる
 mysqli_free_result($rs);
 $mysqli->close();

}
?&gt;
 &lt;p align=center&gt;
 &lt;table border="0"&gt;
 &lt;form method="post"&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="30"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;
 &lt;td&gt;&lt;textarea name="message" rows="5" cols="60"&gt;&lt;/textarea&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
 &lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
// ユーザ定義関数
// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id']    ：記事番号
$arr_message['name']   ：投稿者氏名
$arr_message['title']   ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date']   ：投稿日時
*/

?&gt;
 &lt;table border="1" cellpadding="3" cellspacing="0" width="600"&gt;
 &lt;tr&gt;
  &lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
      ［&lt;?=$arr_message['name']?&gt;］ &lt;?=$arr_message['date']?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/table&gt;
&lt;?php
}
?&gt;
</pre>

<p>main01f.phpで記事を送信した結果を以下に示します．記事がヘッダー部と本文に別れ，一般的な記事の形式に表示されています．</p>

	<img src="./files/chap6_05.png" width="600">


<!--	<img src="./files/chap6_06.jpg" width="600">-->


<h4>6.1.12　ブラウザから送信されるデータのチェック</h4>
<p>ブラウザの入力フォームから送信されるデータで，例えば氏名欄が空白の場合は，そのままデータベースに保存するのではなく，有効な文字列が入力されるまで再入力を促したい場合があります．その場合は，入力データが「空」かどうかをチェックし，「空」でなければデータベースに保存し，「空」ならば再度入力フォームを表示するようにします．ここでは，氏名，タイトル，本文のデータを順次「空」でないかどうかチェックすることとします．なお，データのチェックのために，「data_check()」関数を定義します．「data_check()」関数では，データが正常であれば，戻り値は「空」とし，データが正常でなければ，戻り値はその旨を示すメッセージとします．たとえば，氏名が「空」ならば，「氏名を入力してください．」という文字列を戻り値とします．「data_check()」関数のサンプルリストを以下に示します．</p> 
  <p class="command-print">○関数の呼び出し部分<br>
    // 受信データが「空」でないかどうかチェック<br>
  <font color="#FF0000">$str_error_message</h4></font> = <font color="#FF0000">data_check($str_name,$str_title,$str_message)</font></h4>;<br>
    <br>
    if(<font color="#FF0000">$str_error_message == ""</h4></font>)<br>
    {<br>
    <br>
    　// 改行コードを改行タグに変換<br>
    　$str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br 
    /&gt;", $str_message); 　<br>
    <br>
    　データ保存処理<br>
    }<br>
    else<br>
    {<br>
    　print "&lt;font style='color:red'&gt;{<font color="#FF0000">$str_error_message</font></h4>}&lt;/font&gt;&lt;br&gt;\n";<br>
    }<br>
    <br>
    <br>
    ○関数の定義<br>
    // ----------------------------------------------<br>
    // 受信データのチェック<br>
    <font color="#FF0000">function data_check(&amp;$str_name,&amp;$str_title,&amp;$str_message)</font></h4><br>
    {<br>
    /*<br>
    $str_name 　 ：投稿者氏名<br>
    $str_title 　：記事タイトル<br>
    $str_message ：記事本文<br>
    $str="";
    */<br>
    　// データの受信<br>
    　$str_name　　= $_POST['name'];<br>
    　$str_title 　= $_POST['title'];<br>
    　$str_message = $_POST['message'];<br>
    <br>
    　// 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換<br>
    　$str_name 　 = <font color="#FF0000">input_str_convert</font></h4>($str_name);<br>
    　$str_title 　= <font color="#FF0000">input_str_conver</font></h4>t($str_title);<br>
    　$str_message = <font color="#FF0000">input_str_convert</font></h4>($str_message); 
    　<br>
    <br>
    　 // 文字列が空かいなかのチェック<br>
    　if($str_name == "")<br>
    　{<br>
    　　$str = "氏名を記入してください";<br>
    　}<br>
    　elseif($str_title == "")<br>
    　{<br>
    　　$str = "タイトルを記入してください";<br>
    　}<br>
    　elseif($str_message == "")<br>
    　{<br>
    　　$str = "本文を記入してください";<br>
    　}<br>
    　return $str;<br>
    } <br>
    <br>
    // ----------------------------------------------<br>
    // 入力文字列の整形処理<br>
    <font color="#FF0000">function input_str_convert($str)</h4></font><br>
    {<br>
    　if($str != "")<br>
    　{<br>
    　　// 文字列の前後の半角スペースを削除<br>
    　　$str = trim($str);<br>
    <br>
    　　// 半角カタカナを全角カタカナに変換<br>
    　　// V: 濁点付きの文字を１文字に変換<br>
    　　// K: 半角カタカナを全角カタカナに変換<br>
    　　$str = mb_convert_kana($str,'KV');<br>
    　}<br>
    　return $str;<br>
    } </p>
  
<p>「data_check()」関数では，さらに「input_str_convert()」関数を定義し，使っています．「input_str_convert()」関数では，文字列の前後の半角スペースを削除し，かつ半角カタカナを全角カタカナに変換しています．サンプルリストを「main01g.php」とします． </p> 
main01g.php
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

// 「送信」の場合
if(isset($_POST['command'])&&$_POST['command'] == "送信")
{

 // 受信データが「空」でないかどうかチェック
 $str_error_message = data_check($str_name,$str_title,$str_message);

 if($str_error_message == "")
 {
  // 改行コードを改行タグに変換
  $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);
  // 現在日時の取得
  $str_date = date("Y-m-d H:i:s",time());

  // 「message_id」の生成
  // データベースへの接続
  // データベースサーバへの接続・データベースの選択
  $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
  //クライアント文字コードの通知（文字化け防止）
  $str_sql = "set names utf8;";
  $rs = $mysqli->query($str_sql); 
 

  // tbl_bbs1テーブルのmessage_idの最大値の取得
  $str_sql = "select max(message_id) as max_id from tbl_bbs1;";
  $rs = $mysqli->query($str_sql);
  $arr_record = array();
  $arr_record = $rs->fetch_assoc();
  $max_id = $arr_record['max_id'];
  if($max_id &gt; 0)
  {
   $new_id = $max_id + 1;
  }
  else
  {
   $new_id = 1;
  }

  // データのテーブルへの保存
  $str_sql = "insert into tbl_bbs1 "
       . "(message_id,name,title,message,date)"
       . "values("
       . $new_id. ",'" . $str_name . "','" . $str_title
       . "','" . $str_message . "','" . $str_date . "');";

  $mysqli->query($str_sql);

  // テーブルのデータの一覧取得
  $str_sql = "select * from tbl_bbs1 order by message_id desc;";

   $rs = $mysqli->query($str_sql);

   // データの表示
  print "&lt;p align=center&gt;";
  while($arr_record = $rs->fetch_assoc())
  {
   // 記事データの配列への格納
   $arr_message = array();
   $arr_message['id']    = $arr_record['message_id'];
   $arr_message['name']   = $arr_record['name'];
   $arr_message['title']   = $arr_record['title'];
   $arr_message['message'] = $arr_record['message'];
   $arr_message['date']   = $arr_record['date'];

   // 1個の記事本文の表示
   message_disp($arr_message);
  }
  print "&lt;/p&gt;";

  //結果セットを破棄し，接続を閉じる
  mysqli_free_result($rs);
  $mysqli->close();
 }
 else
 {
  print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";
 }
}
?&gt;
&lt;p align=center&gt;
&lt;table border="0"&gt;
&lt;form method="post"&gt;
&lt;tr&gt;
 &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="30"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt;記事&lt;/td&gt;
 &lt;td&gt;&lt;textarea name="message" rows="5" cols="60"&gt;&lt;/textarea&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/form&gt;
&lt;/table&gt;
&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
// ユーザ定義関数
// ----------------------------------------------
//
function data_check(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
 // データの受信
 $str_name   = $_POST['name'];
 $str_title  = $_POST['title'];
 $str_message = $_POST['message'];

 // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
 $str_name   = input_str_convert($str_name);
 $str_title  = input_str_convert($str_title);
 $str_message = input_str_convert($str_message);

 // 文字列が空かいなかのチェック
 if($str_name == "")
 {
  $str = "氏名を記入してください";
 }
 elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 return $str;
}

// ----------------------------------------------
// 入力文字列の整形処理
function input_str_convert($str)
{
 if($str != "")
 {
  // 文字列の前後の半角スペースを削除
  $str = trim($str);

  // 半角カタカナを全角カタカナに変換
  // V: 濁点付きの文字を１文字に変換
  // K: 半角カタカナを全角カタカナに変換
  $str = mb_convert_kana($str,'KV');
 }
 return $str;
}

// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
*/
?&gt;
&lt;table border="1" cellpadding="3" cellspacing="0" width="600"&gt;
&lt;tr&gt;
 &lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
    ［&lt;?=$arr_message['name']?&gt;］ &lt;?=$arr_message['date']?&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
 &lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;?php
}
?&gt;
</pre>

<h4>6.1.13　入力データの再表示</h4>
<p>「main01g.php」ファイルの場合，入力データの一部に記入もれがあると，入力フォームを再表示します．ただ，その場合，入力フォームのすべての欄がリセットされ空白になっています．これでは，先に入力した正常の欄も再度，はじめから入力しなくてはならず，使い勝手がいいとはいえません．そこで，入力フォームを再表示する場合，すでに入力した欄のデータはそのまま再表示するようにします．入力フォームに入力したデータを再表示するには，①入力したデータをPOSTメソッドで次のファイル（ここでは自分自身のファイル）引き継ぐことと，②引き継いだデータを各入力フォームの初期値として表示するようにする必要があります．実は，フォームオブジェクトの場合，各入力フォーム（各フォーム要素）の初期値を設定しておけば，「送信」ボタンを押せば自動的に入力データは，次のファイルに引き継がれます．以上の入力フォームを表示するために，「input_form_disp()」関数を定義します．「input_form_disp()」関数のサンプルリストを以下に示します．</p> 
  <p class="command-print">○関数の呼び出し部分<br>
    データが正常に保存された場合は，次のように各データをリセットしておきます．<br>
    　<font color="#FF0000">$str_name 　 = "";<br>
    　$str_title　 = "";<br>
    　$str_message = "";</h4></font><br>
    <br>
    // 入力フォームの表示<br>
    <font color="#FF0000">input_form_disp($str_name,$str_title,$str_message)</h4></font>;<br>
    <br>
    <br>
    ○関数の定義部分 <br>
    // ----------------------------------------------<br>
    // 入力フォームの表示<br>
    <font color="#FF0000">function input_form_disp(&amp;$str_name,&amp;$str_title,&amp;$str_message)</h4></font><br>
    {<br>
    /*<br>
    $str_name ：投稿者氏名<br>
    $str_title ：記事タイトル<br>
    $str_message ：記事本文<br>
    */<br>
    　// 改行タグの改行コードへの変換<br>
    　<font color="#FF0000">$str_message = preg_replace( "/(&lt;br&gt;|&lt;br 
    \/&gt;)/", "\n", $str_message); </h4></font><br>
    ?&gt;<br>
    　&lt;table border="0"&gt;<br>
    　&lt;form method="post"&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="60"<br>
    　　　　　　　　　　　　　　　　　　value="<font color="#FF0000">&lt;?=$str_name?</font></h4>&gt;"&gt;&lt;/td&gt;<br>
    　 &lt;/tr&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" 
    size="60"<br>
    　　　　　　　　　　　　　　　　　　　value="<font color="#FF0000">&lt;?=$str_title?&gt;</font></h4>"&gt;&lt;/td&gt;<br>
    <br>
    　 &lt;/tr&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt;記事&lt;/td&gt;<br>
    　　&lt;td&gt;&lt;textarea name="message" <br>
    　　　　　　　　　　rows="5" cols="60"&gt;<font color="#FF0000">&lt;?=$str_message?&gt;</font></h4>&lt;/textarea&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" 
    value="送信"&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;/form&gt;<br>
    　&lt;/table&gt;<br>
    &lt;?php<br>
    }<br>
  </p>
<p> &lt;textarea&gt;要素に文字列を表示するためには，次のように文字列中の改行タグを改行コードに変換しておく必要があります．</p> 
  <p class="command-print"><font color="#000000">$str_message = preg_replace( 
    "/(&lt;br&gt;|&lt;br \/&gt;)/", "\n", $str_message)</font></p>
<p>サンプルリストを「main01h.php」とします． </p> 
main01h.php
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php

// 「送信」の場合
if(isset($_POST['command'])&&$_POST['command'] == "送信")
{

 // 受信データが「空」でないかどうかチェック
 $str_error_message = data_check($str_name,$str_title,$str_message);

 if($str_error_message == "")
 {

  // 改行コードを改行タグに変換
  $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);

  // 現在日時の取得
  $str_date = date("Y-m-d H:i:s",time());

  // 「message_id」の生成
  // データベースへの接続
  // データベースサーバへの接続・データベースの選択
  $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
  //クライアント文字コードの通知（文字化け防止）
  $str_sql = "set names utf8;";
  $rs = $mysqli->query($str_sql); 
 
  // tbl_bbs1テーブルのmessage_idの最大値の取得
  $str_sql = "select max(message_id) as max_id from tbl_bbs1;";
  $rs = $mysqli->query($str_sql);

  $arr_record = array();
  $arr_record = $rs->fetch_assoc();
  $max_id = $arr_record['max_id'];

  if($max_id &gt; 0)
  {
   $new_id = $max_id + 1;
  }
  else
  {
   $new_id = 1;
  }

  // データのテーブルへの保存
  $str_sql = "insert into tbl_bbs1 "
       . "(message_id,name,title,message,date)"
       . "values("
       . $new_id. ",'" . $str_name . "','" . $str_title
       . "','" . $str_message . "','" . $str_date . "');";

  //print $str_sql;
  $mysqli->query($str_sql);

  // データのリセット
  $new_id = "";
  $str_name = "";
  $str_title = "";
  $str_message = "";
  $str_date = "";

  // テーブルのデータの一覧取得
  $str_sql = "select * from tbl_bbs1 order by message_id desc;";

  $rs = $mysqli->query($str_sql);

  // データの表示（仮）
  print "&lt;p align=center&gt;";

  while($arr_record = $rs->fetch_assoc())
  {
   // 記事データの配列への格納
   $arr_message = array();

   $arr_message['id']     = $arr_record['message_id'];
   $arr_message['name']   = $arr_record['name'];
   $arr_message['title']    = $arr_record['title'];
   $arr_message['message'] = $arr_record['message'];
   $arr_message['date']    = $arr_record['date'];

   // 1個の記事本文の表示
   message_disp($arr_message);

  }
  print "&lt;/p&gt;";

  //結果セットを破棄し，接続を閉じる
  mysqli_free_result($rs);
  $mysqli->close();
 }
 else
 {
  print "&lt;p align=center&gt;";
  print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";
  print "&lt;/p&gt;";
 }
}

print "&lt;p align=center&gt;";

// 入力フォームの表示
input_form_disp($str_name,$str_title,$str_message);

print "&lt;/p&gt;";
?&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
// ユーザ定義関数
// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_title,&$str_message)
{
/*
$str_name   ：投稿者氏名
$str_title    ：記事タイトル
$str_message ：記事本文
*/
 // データの受信
 $str_name   = $_POST['name'];
 $str_title    = $_POST['title'];
 $str_message = $_POST['message'];

 // 改行コードを改行タグに変換
 $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);

 // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
 $str_name   = input_str_convert($str_name);
 $str_title    = input_str_convert($str_title);
 $str_message = input_str_convert($str_message);

 // 文字列が空かいなかのチェック
 if($str_name == "")
 {
  $str = "氏名を記入してください";
 }
 elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
  elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message)
{
/*
$str_name   ：投稿者氏名
$str_title    ：記事タイトル
$str_message ：記事本文
*/
// 改行タグの改行コードへの変換
$str_message = preg_replace( "/(&lt;br&gt;|&lt;br \/&gt;)/", "\n", $str_message);

?&gt;
 &lt;table border="0"&gt;
 &lt;form method="post"&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="60"
              value="&lt;?=$str_name?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"
                value="&lt;?=$str_title?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;
  &lt;td&gt;&lt;textarea name="message" 
         rows="5" cols="60"&gt;&lt;?=$str_message?&gt;&lt;/textarea&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// 入力文字列の整形処理
function input_str_convert($str)
{
 if($str != "")
 {
  // 文字列の前後の半角スペースを削除
  $str = trim($str);

  // 半角カタカナを全角カタカナに変換
  // V: 濁点付きの文字を１文字に変換
  // K: 半角カタカナを全角カタカナに変換
  $str = mb_convert_kana($str,'KV');
 }
 return $str;
}

// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id']     ：記事番号
$arr_message['name']   ：投稿者氏名
$arr_message['title']    ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date']    ：投稿日時
*/
?&gt;
 &lt;table border="1" cellpadding="3" cellspacing="0" width="600"&gt;
 &lt;tr&gt;
  &lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
    ［&lt;?=$arr_message['name']?&gt;］ &lt;?=$arr_message['date']?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/table&gt;
&lt;?php
}
?&gt;
</pre>

<p>「main01h.php」ファイルにアクセスし，たとえば氏名欄だけ書き忘れて空白のまま「送信」ボタンをクリックすると，下記のように警告メッセージが表示され，再度入力フォームが表示されます．入力フォームにはすでに記入したデータは再表示されています．</p>

<img src="./files/1050109.png" width="600">


<h4>6.1.14　スタイルシート（CSS)の利用</h4>
<p>これまで，記事の表示等において，文字サイズや背景色等について特に工夫をしてきませんでした．HTMLファイルにおいて，文字サイズや背景色を制御する方法には多様な方法がありますが，ここでは今後主流になりつつあるカスケードスタイルシート（CSS）を使用する方法について述べます．たとえば，これまで記事は以下のように単純に表示していました．</p><table width="600" border="1" cellspacing="0" cellpadding="0">
  <tbody><tr style="font-size:medium"> 
    <td>No.123　スタイルシートについて　［山田］　2006-11-14 12:34:00</td>
  </tr>
  <tr style="font-size:medium"> 
    <td>●スタイルシートの利用<br>
      <br>
      HTMLファイルにおいて，文字サイズや背景色を制御する方法には多様な方法がありますが，ここでは今後主流になりつつあるカスケードスタイルシート（CSS）を使用する方法について述べます． 
    </td>
  </tr>
</tbody></table><p>これをたとえば，次のようなスタイルで表示することを考えます．</p><div style="background-color:#ffff99"><br>
  <table width="600" border="1" cellspacing="0" cellpadding="0">
    <tbody><tr style="font-size:x-small ; background-color: #dcdcdc"> 
      <td>No.123　スタイルシートについて　<span style="font-weight:bold">［山田］</span>　<span style="color: #696969">2006-11-14 
        12:34:00</span></td>
    </tr>
    <tr style="font-size:x-small ; background-color: white"> 
      <td> ●スタイルシートの利用<br>
        <br>
        HTMLファイルにおいて，文字サイズや背景色を制御する方法には多様な方法がありますが，ここでは今後主流になりつつあるカスケードスタイルシート（CSS）を使用する方法について述べます． 
      </td>
    </tr>
  </tbody></table>
  <br>
</div><p>具体的には，各項目ごとに以下のスタイル（属性）を設定する必要があります．</p><table width="600" border="1" cellspacing="0" cellpadding="0">
  <tbody><tr> 
    <td>要素</td>
    <td>タグ</td>
    <td>属性</td>
    <td>値</td>
    <td>スタイルシート</td>
    <td>クラス名</td>
  </tr>
  <tr> 
    <td>ブラウザ背景</td>

    <td>&lt;body&gt;</td>
    <td>背景色</td>
    <td>#ffff99</td>
    <td>background-color:#ffff99</td>
    <td>.b_ffff99</td>
  </tr>
  <tr> 
    <td>テーブル</td>
    <td>&lt;table&gt;</td>
    <td>外枠の幅</td>
    <td>1</td>
    <td>border-width:1</td>
    <td>　</td>
  </tr>
  <tr> 
    <td>テーブル</td>
    <td>&lt;table&gt;</td>
    <td>外枠のタイプ</td>
    <td>solid</td>
    <td>border-type:solid</td>
    <td>　</td>
  </tr>
  <tr> 
    <td>テーブル</td>
    <td>&lt;table&gt;</td>
    <td>外枠の色</td>
    <td>黒</td>
    <td>border-color:black</td>
    <td>　</td>
  </tr>
  <tr> 
    <td>テーブル</td>
    <td>&</td>
  </tr>lt;table&gt;</td>
    <td>パッディング</td>
    <td>3</td>
    <td>padding:3</td>
    <td>.padding3
  <tr> 
    <td>テーブル</td>
    <td>&lt;table&gt;</td>
    <td>セルとセルの間隔</td>
    <td>0</td>
    <td>border-spacing</td>
    <td>.bd_spacing0</td>
  </tr>
  <tr> 
    <td>テーブル</td>
    <td>&lt;table&gt;</td>
    <td>幅</td>
    <td>600</td>
    <td>width:600</td>
    <td>.w600</td>
  </tr>
  <tr> 
    <td>ヘッダー行</td>
    <td>&lt;tr&gt;</td>
    <td>背景色</td>
    <td>#dcdcdc</td>
    <td>background-color:#dcdcdc</td>
    <td>.b_dcdcdc</td>
  </tr>
  <tr> 
    <td>ヘッダー行</td>
    <td>&lt;tr&gt;</td>
    <td>文字サイズ</td>
    <td>x-small</td>
    <td>font-size:x-small</td>
    <td>.xs</td>
  </tr>
  <tr> 
    <td>一部の文字列</td>
    <td>&lt;span&gt;</td>
    <td>文字の太さ</td>
    <td>bold</td>
    <td>font-weight:bold</td>
    <td>.fbold</td>
  </tr>
  <tr> 
    <td>一部の文字列</td>
    <td>&lt;span&gt;</td>
    <td>文字の色</td>
    <td>#696969</td>
    <td>color:#696969</td>
    <td>.696969</td>
  </tr>
  <tr> 
    <td>本文行</td>
    <td>&lt;tr&gt;</td>
    <td>文字サイズ</td>
    <td>x-small</td>
    <td>font-size:x-small</td>
    <td>.xs</td>
  </tr>
</tbody></table><p>クラス名は，スタイルシートの定義内容を示す略称のようなものです．具体的な使い方は後に述べます．スタイルシートをHTMLに関連付ける方法として主に以下の３つの方法があります．</p> 
<p>①HTMLファイル内のタグ要素に，style属性の値として組み込む方法</p>
   
    <p class="command-print">&lt;タグ要素名 style="スタイルシート　;　スタイルシート"&gt;</p>
  
<p>②styleタグ要素の内容として組み込む方法．styleタグ要素は&lt;head&gt;縲鰀&lt;/head&gt;の範囲内に書き込む．</p>
   
    <p class="command-print">&lt;head&gt;<br>
      -------- <br>
      &lt;style type="text/css"&gt;<br>
      &lt;!--<br>
      　クラス名　{ スタイルシート　;　スタイルシート　}<br>
      <br>
      --&gt;<br>
      &lt;/style&gt;<br>
      &lt;/head&gt; </p>
  
<p>styleタグ要素の中で，スタイルシートを記述し，その記述にたとえばスタイル名を付与します．あるタグ要素に，そのスタイル名に対応するスタイルシートを適用する場合は，以下のように，class属性を使用します．</p>
   
    <p class="command-print">&lt;タグ要素名　class="クラス名　クラス名"&gt;</p>
  
<p>③スタイルシートの書かれたファイル（CSSファイル)を読み込む方法．　linkタグ要素で読み込むファイルを指定する．<br>
    　 linkタグ要素は&lt;head&gt;縲鰀&lt;/head&gt;の範囲内に書き込む．CSSファイルの拡張子は「.css」とします．</p>
   
    <p class="command-print">&lt;head&gt;<br>
      --------<br>
      &lt;link　rel="stylesheet"　href="CSSファイルのURL"　 
      type="text/css"&gt; <br>
      --------<br>
      &lt;/head&gt; </p>
  
<p>この方法は，②の方法で，styleタグ要素の中に記述したクラス名等の定義を，CSSファイルに書き出したものと言えます．HTMLファイルの中での，スタイル名の利用法は②の場合と同じです．</p>
<p>なお，上記いずれの場合も，スタイルシートを記述する言語としてCSS(Cascading Style Seet)言語を使用する旨をmetaタグ要素により&lt;head&gt;縲鰀&lt;/head&gt;の範囲内に記述しておく必要があります．</p> 
  <p class="command-print">&lt;head&gt;<br>
    ------<br>
    &lt;meta http-equiv="Content-Style-Type" content="text/css"&gt;<br>
    ------<br>
    &lt;/head&gt;</p>
<p>①縲怫Bの中で一番勧めるのは，③の方法です．複数のHTMLファイルあるいはWebサイトでデザインの統一感を出すための実現方法としてもっとも効率的であり，修正・更新もすばやく効率的に行えるからです．以下，先に示したスタイルで記事を表示するためのスタイルシートの記述方法を，①縲怫Bのおのおの場合について具体的に述べます．</p>

<h4>6.1.15　スタイルシートを，HTMLファイル内のタグ要素に，style属性の値として組み込む方法（①の方法）</h4>
<p>スタイルシートを，HTMLファイル内のタグ要素に，style属性の値として組み込む方法による場合のサンプルリストを以下に示します．</p> 
  <p class="command-print"> &lt;head&gt;<br>
    ------<br>
  <font color="#FF0000">&lt;meta http-equiv="Content-Style-Type" 
    content="text/css"&gt;</font></h4><br>
    ------<br>
    &lt;/head&gt;<br>
    &lt;body <font color="#FF0000">style="background-color:#ffff99"</font></h4>&gt;<br>
    ------<br>
    <br>
    　　print "&lt;p <font color="#FF0000">style='text-align:center'</h4></font>&gt;";<br>
    　　-----<br>
    　　message_disp(&amp;arr_message); <br>
    <br>
    ------<br>
    function message_disp(&amp;$arr_message)<br>
    {<br>
    　&lt;table <font color="#FF0000">style="border-width:1 ;border-style:solid; 
    border-color:black<br>
    　　　　　　　　　　; padding:3 ; border-spacing:0 <br>
    　　　　　　　　　　; border-collapse:collapse ; width:600"</h4></font>&gt;<br>
    　&lt;tr <font color="#FF0000">style="background-color:#dcdcdc 
    ; font-size:x-small"</h4></font>&gt;<br>
    　　&lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;<br>
    　　　　　&lt;span <font color="#FF0000">style="font-weight:bold"</h4></font>&gt;［&lt;?=$arr_message['name']?&gt;］　&lt;/span&gt;<br>
    　　　　　&lt;span <font color="#FF0000">style="color:#696969"</h4></font>&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;tr <font color="#FF0000">style="background-color:white 
    ; font-size:x-small"</font></h4>&gt;<br>
    　　&lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;/table&gt;<br>
    } </p>


<h4>6.1.16　スタイルシートを，styleタグ要素の内容として組み込む方法</h4>
<p>スタイルシートを，styleタグ要素の内容として組み込む方法による場合のサンプルリストを以下に示します．styleタグ要素の中で，スタイルシートとそれに対応するクラス名を順次定義していきます．スタイルシートを適用したいタグ要素の中で，class='クラス名'の属性を記述することにより，そのタグ要素にスタイルシートが適用されます．サンプルリストを以下に示します．</p> 
  <p class="command-print">&lt;head&gt;<br>
    ------<br>
  <font color="#FF0000">&lt;meta http-equiv="Content-Style-Type" 
    content="text/css"&gt;</font></h4><br>
    <font color="#FF0000">&lt;style type="text/css"&gt;<br>
    &lt;!--<br>
    　.b_ffff99 { background-color : #ffff99;}<br>
    　.b_dcdcdc { background-color : #dcdcdc;}<br>
    　.b_w　　　 { background-color : white;}<br>
    　.ac　　　　{ text-align : center;}<br>
    　.bd_w1　　{ border-width:1px;}<br>
    　.bd_solid { border-style:solid;}<br>
    　.bd_b　　　{ border-color: black;}<br>
    　.padding3 { padding:3px}<br>
    　.bd_spacing0 { border-spacing:0px}<br>
    　.bd_collapse { border-collapse:collapse}<br>
    　.w600　　 { width: 600px;}<br>
    　.xs　　　　 { font-size: x-small }　 <br>
    　.fbold 　　{ font-weight: bold}<br>
    　.696969 { color: #696969;}<br>
    --&gt;<br>
    &lt;/style&gt;</font></h4><br>
    ------<br>
    &lt;/head&gt;<br>
    &lt;body <font color="#FF0000">class="b_ffff99"</font></h4>&gt;<br>
    ------<br>
    <br>
    　　print "&lt;p <font color="#FF0000">class=ac'</h4></font>&gt;";<br>
    　　-----<br>
    　　message_disp(&amp;arr_message); <br>
    <br>
    ------<br>
    function message_disp(&amp;$arr_message)<br>
    {<br>
    　&lt;table <font color="#FF0000">class="bd_w1bd_solid bd_b padding3 
    bd_spacing0 <br>
    　　　　　　　　　 bd_collapse w600"</h4></font>&gt;<br>
    　&lt;tr <font color="#FF0000">class="b_dcdcdc xs"</h4></font>&gt;<br>
    　　&lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;<br>
    　　　　　&lt;span <font color="#FF0000">class="fbold"</h4></font>&gt;［&lt;?=$arr_message['name']?&gt;］　&lt;/span&gt;<br>
    　　　　　&lt;span <font color="#FF0000">class="696969"</h4></font>&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;tr <font color="#FF0000">class="b_w xs"</font></h4>&gt;<br>
    　　&lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;/table&gt;<br>
    } </p>


<h4>6.1.17　スタイルシートの書かれたファイル（CSSファイル)を読み込む方法</h4>
<p>クラス名とそれに対応するスタイルシートとの関係の記述を，別途CSSファイルとして切り離す方法のサンプルリストの概要を以下に示します．</p> 
  <p class="command-print">&lt;head&gt;<br>
    ------<br>
  <font color="#FF0000">&lt;meta http-equiv="Content-Style-Type" 
    content="text/css"&gt;</font></h4><br>
    <font color="#FF0000">&lt;link rel="stylesheet" type="text/css" 
    href="common.css"&gt;</font></h4>　&lt;--この行を追加<br>
    ------<br>
    &lt;/head&gt;<br>
    &lt;body <font color="#FF0000">class="b_ffff99"</font></h4>&gt;<br>
    ------<br>
    <br>
    　　print "&lt;p <font color="#FF0000">class=ac'</h4></font>&gt;";<br>
    　　-----<br>
    　　message_disp(&amp;arr_message); <br>
    <br>
    ------<br>
    function message_disp(&amp;$arr_message)<br>
    {<br>
    　&lt;table <font color="#FF0000">class="bd_w1bd_solid bd_b padding3 
    bd_spacing0 <br>
    　　　　　　　　　 bd_collapse w600"</h4></font>&gt;<br>
    　&lt;tr <font color="#FF0000">class="b_dcdcdc xs"</h4></font>&gt;<br>
    　　&lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;<br>
    　　　　　&lt;span <font color="#FF0000">class="fbold"</h4></font>&gt;［&lt;?=$arr_message['name']?&gt;］　&lt;/span&gt;<br>
    　　　　　&lt;span <font color="#FF0000">class="696969"</h4></font>&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;tr <font color="#FF0000">class="b_w xs"</font></h4>&gt;<br>
    　　&lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;/table&gt;<br>
    } </p>
<p>ある程汎用的なスタイルシートファイルを自分で作っておくといいでしょう．ここでは，例えば以下のような汎用的なスタイルシートcommon.cssを使用しています．</p> 
<pre class="brush:css;">
.xxs { font-size: xx-small ;}
.xs { font-size: x-small }
.s { font-size: small }
.m { font-size: medium }
.l { font-size: large }
.xl { font-size: x-large }
.xxl { font-size: xx-large }
.smaller { font-size: smaller }
.larger { font-size: larger }
.fbold { font-weight: bold}
.underline { text-decoration: underline}
.p200 { font-size: 200% }
.aleft { text-align: left }
.aright { text-align: right }
.acenter { text-align: center}
.vtop { vertical-align: top; }
.vmiddle { vertical-align: middle; }
.al { text-align: left;}
.ac { text-align: center;}
.ar { text-align: right;}
.vtop_al {
vertical-align: top; 
text-align: left;
}
.vtop_ac { 
vertical-align: top; 
text-align: center;
}
.vtop_ar {
vertical-align: top; 
text-align: right;
}
.vmiddle_ac {
vertical-align: middle; 
text-align: center;
}
.font_red {color: red;}
.font_black {color: black;}
.black {color: black;}
.red {color: red;}
.blue {color: blue;}
.green {color: green;}
.silver {color: silver;}
.yellow {color: yellow;}
.696969 {color: #696969;}
.ffccff {color: #ffccff;}
.ffcc99 {color: #ffcc99;}
.white {color: white;}

.padding0 {padding:0px}
.padding1 {padding:1px}
.padding2 {padding:2px}
.padding3 {padding:3px}
.padding4 {padding:4px}
.padding5 {padding:5px}
.padding6 {padding:6px}
.padding8 {padding:8px}
.padding10 {padding:10px}
.margin0 {margin:0px}
.margin1 {margin:1px}
.margin2 {margin:2px}
.margin3 {margin:3px}
.margin4 {margin:4px}
.margin5 {margin:5px}
.margin6 {margin:6px}
.margin8 {margin:8px}
.margin10 {margin:10px}

.bd_collapse {border-collapse:collapse}
.bd_separate {border-collapse:separate}
.bd_w0 {border-width:0px}
.bd_w1 {border-width:1px}
.bd_w2 {border-width:2px}
.bd_solid {border-style:solid}
.bd_spacing0 {border-spacing:0px}
.bd_spacing1 {border-spacing:1px}
.bd_spacing2 {border-spacing:2px}

.zenkaku {ime-mode: active;}
.hankaku {ime-mode: inactive;}
.float_left {float: left;}
.float_right {float: right;}
.clear_left {clear: left;}
.clear_right {clear: right;}
.warn { color: red;}
.w10 { width: 10px;}
.w16 { width: 16px;}
.w20 { width: 20px;}
.w24 { width: 24px;}
.w30 { width: 30px;}
.w40 { width: 40px;}
.w50 { width: 50px;}
.w60 { width: 60px;}
.w70 { width: 70px;}
.w80 { width: 80px;}
.w90 { width: 90px;}
.w100 { width: 100px;}
.w120 { width: 120px;}
.w140 { width: 140px;}
.w160 { width: 160px;}
.w180 { width: 180px;}
.w200 { width: 200px;}
.w250 { width: 250px;}
.w300 { width: 300px;}
.w400 { width: 400px;}
.w500 { width: 500px;}
.w600 { width: 600px;}
.w640 { width: 640px;}
.w10p { width: 10%;}
.w15p { width: 15%;}
.w50p { width: 50%;}
.w100p { width: 100%;}
.h10 { height: 10px;}
.h15 { height: 15px;}
.h20 { height: 20px;}

.b1 { border: solid 1px;}
.b2 { border: solid 2px;}
.b_w { background-color: white;}
.b_b { background-color: black;}
.b_gray { background-color: gray;}
.b_silver { background-color: #c0c0c0;}
.b_red { background-color: red;}
.b_yellow{ background-color: yellow;}
.b_sunday{ background-color: #ffcccc;}
.b_cccccc {background-color: #cccccc;}
.b_dcdcdc {background-color: #dcdcdc;}
.b_808080 {background-color: #808080;}
.b_696969 {background-color: #696969;}
.b_ccccff {background-color: #ccccff;}
.b_ccffcc {background-color: #ccffcc;}
.b_ffcccc {background-color: #ffcccc;}
.b_ccffff {background-color: #ccffff;}
.b_ffccff {background-color: #ffccff;}
.b_ffffcc {background-color: #ffffcc;}
.b_ccff99 {background-color: #ccff99;}
.b_99ccff {background-color: #99ccff;}
.b_ff99cc {background-color: #ff99cc;}
.b_99ffcc {background-color: #99ffcc;}
.b_cc99ff {background-color: #cc99ff;}
.b_ffcc99 {background-color: #ffcc99;}
.b_99ffff {background-color: #99ffff;}
.b_ff99ff {background-color: #ff99ff;}
.b_ffff99 {background-color: #ffff99;}
.b_ccff66 {background-color: #ccff66;}
.b_66ccff {background-color: #66ccff;}
.b_ff66cc {background-color: #ff66cc;}

.bd_b { border-color: black;}
.bd_gray { border-color: gray;}
.bd_red { border-color: red;}
.bd_top_gray { border-top:solid 1px;
border-top-color: gray;
} 
.bd_bottom_gray { border-bottom:solid 1px;
border-bottom-color: gray;
} 
.h_cal { height: 50}
.disp_block {display: block;}
.disp_inline {display: inline;}
.disp_none {display: none;}
.mark1 { padding-left:10px;
background-image:url(m1.gif);
background-repeat:no-repeat;
}
A:hover { color:red}.xxs { font-size: xx-small ;}
.xs { font-size: x-small }
.s { font-size: small }
.m { font-size: medium }
.l { font-size: large }
.xl { font-size: x-large }
.xxl { font-size: xx-large }
.smaller { font-size: smaller }
.larger { font-size: larger }
.fbold { font-weight: bold}
.underline { text-decoration: underline}
.p200 { font-size: 200% }
.aleft { text-align: left }
.aright { text-align: right }
.acenter { text-align: center}
.vtop { vertical-align: top; }
.vmiddle { vertical-align: middle; }
.al { text-align: left;}
.ac { text-align: center;}
.ar { text-align: right;}
.vtop_al {
vertical-align: top; 
text-align: left;
}
.vtop_ac { 
vertical-align: top; 
text-align: center;
}
.vtop_ar {
vertical-align: top; 
text-align: right;
}
.vmiddle_ac {
vertical-align: middle; 
text-align: center;
}
.font_red {color: red;}
.font_black {color: black;}
.black {color: black;}
.red {color: red;}
.blue {color: blue;}
.green {color: green;}
.silver {color: silver;}
.yellow {color: yellow;}
.696969 {color: #696969;}
.ffccff {color: #ffccff;}
.ffcc99 {color: #ffcc99;}
.white {color: white;}

.padding0 {padding:0px}
.padding1 {padding:1px}
.padding2 {padding:2px}
.padding3 {padding:3px}
.padding4 {padding:4px}
.padding5 {padding:5px}
.padding6 {padding:6px}
.padding8 {padding:8px}
.padding10 {padding:10px}
.margin0 {margin:0px}
.margin1 {margin:1px}
.margin2 {margin:2px}
.margin3 {margin:3px}
.margin4 {margin:4px}
.margin5 {margin:5px}
.margin6 {margin:6px}
.margin8 {margin:8px}
.margin10 {margin:10px}

.bd_collapse {border-collapse:collapse}
.bd_separate {border-collapse:separate}
.bd_w0 {border-width:0px}
.bd_w1 {border-width:1px}
.bd_w2 {border-width:2px}
.bd_solid {border-style:solid}
.bd_spacing0 {border-spacing:0px}
.bd_spacing1 {border-spacing:1px}
.bd_spacing2 {border-spacing:2px}

.zenkaku {ime-mode: active;}
.hankaku {ime-mode: inactive;}
.float_left {float: left;}
.float_right {float: right;}
.clear_left {clear: left;}
.clear_right {clear: right;}
.warn { color: red;}
.w10 { width: 10px;}
.w16 { width: 16px;}
.w20 { width: 20px;}
.w24 { width: 24px;}
.w30 { width: 30px;}
.w40 { width: 40px;}
.w50 { width: 50px;}
.w60 { width: 60px;}
.w70 { width: 70px;}
.w80 { width: 80px;}
.w90 { width: 90px;}
.w100 { width: 100px;}
.w120 { width: 120px;}
.w140 { width: 140px;}
.w160 { width: 160px;}
.w180 { width: 180px;}
.w200 { width: 200px;}
.w250 { width: 250px;}
.w300 { width: 300px;}
.w400 { width: 400px;}
.w500 { width: 500px;}
.w600 { width: 600px;}
.w640 { width: 640px;}
.w10p { width: 10%;}
.w15p { width: 15%;}
.w50p { width: 50%;}
.w100p { width: 100%;}
.h10 { height: 10px;}
.h15 { height: 15px;}
.h20 { height: 20px;}

.b1 { border: solid 1px;}
.b2 { border: solid 2px;}
.b_w { background-color: white;}
.b_b { background-color: black;}
.b_gray { background-color: gray;}
.b_silver { background-color: #c0c0c0;}
.b_red { background-color: red;}
.b_yellow{ background-color: yellow;}
.b_sunday{ background-color: #ffcccc;}
.b_cccccc {background-color: #cccccc;}
.b_dcdcdc {background-color: #dcdcdc;}
.b_808080 {background-color: #808080;}
.b_696969 {background-color: #696969;}
.b_ccccff {background-color: #ccccff;}
.b_ccffcc {background-color: #ccffcc;}
.b_ffcccc {background-color: #ffcccc;}
.b_ccffff {background-color: #ccffff;}
.b_ffccff {background-color: #ffccff;}
.b_ffffcc {background-color: #ffffcc;}
.b_ccff99 {background-color: #ccff99;}
.b_99ccff {background-color: #99ccff;}
.b_ff99cc {background-color: #ff99cc;}
.b_99ffcc {background-color: #99ffcc;}
.b_cc99ff {background-color: #cc99ff;}
.b_ffcc99 {background-color: #ffcc99;}
.b_99ffff {background-color: #99ffff;}
.b_ff99ff {background-color: #ff99ff;}
.b_ffff99 {background-color: #ffff99;}
.b_ccff66 {background-color: #ccff66;}
.b_66ccff {background-color: #66ccff;}
.b_ff66cc {background-color: #ff66cc;}

.bd_b { border-color: black;}
.bd_gray { border-color: gray;}
.bd_red { border-color: red;}
.bd_top_gray { border-top:solid 1px;
border-top-color: gray;
} 
.bd_bottom_gray { border-bottom:solid 1px;
border-bottom-color: gray;
} 
.h_cal { height: 50}
.disp_block {display: block;}
.disp_inline {display: inline;}
.disp_none {display: none;}
.mark1 { padding-left:10px;
background-image:url(m1.gif);
background-repeat:no-repeat;
}
A:hover { color:red}
</pre>

<p>以上を反映したサンプルリストをmain01i.phpに示す．</p> 
<pre class="brush:php;">
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;meta http-equiv="Content-Style-Type" content="text/css"&gt;
&lt;link rel="stylesheet" type="text/css" href="common.css"&gt;
&lt;/head&gt;
&lt;body class="b_ffff99"&gt;
&lt;?php
 // 「送信」の場合
 if(isset($_POST['command'])&&$_POST['command'] == "送信")
 {
  // 受信データが「空」でないかどうかチェック
  $str_error_message = data_check($str_name,$str_title,$str_message);

  if($str_error_message == "")
  {
   // 改行コードを改行タグに変換
   $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message)
   // 現在日時の取得
   $str_date = date("Y-m-d H:i:s",time());
   // 「message_id」の生成
   // データベースへの接続
   // データベースサーバへの接続・データベースの選択
   $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
   //クライアント文字コードの通知（文字化け防止）
   $str_sql = "set names utf8;";
   $rs = $mysqli->query($str_sql); 

   // tbl_bbs1テーブルのmessage_idの最大値の取得
   $str_sql = "select max(message_id) as max_id from tbl_bbs1;";
   $rs = $mysqli->query($str_sql);
   $arr_record = array();
   $arr_record = $rs->fetch_assoc();
   $max_id = $arr_record['max_id'];
   if($max_id &gt; 0)
   {
    $new_id = $max_id + 1;
   }
   else
   {
    $new_id = 1;
   }

   // データのテーブルへの保存
   $str_sql = "insert into tbl_bbs1 "
        . "(message_id,name,title,message,date)"
        . "values("
        . $new_id. ",'" . $str_name . "','" . $str_title
        . "','" . $str_message . "','" . $str_date . "');";
   //print $str_sql;
   $mysqli->query($str_sql);

   // データのリセット
   $new_id = "";
   $str_name = "";
   $str_title = "";
   $str_message = "";
   $str_date = "";

   // テーブルのデータの一覧取得
   $str_sql = "select * from tbl_bbs1 order by message_id desc;";
   $rs = $mysqli->query($str_sql);

   // データの表示
   print "&lt;p class='ac'&gt;";
   while($arr_record = $rs->fetch_assoc())
   {
    // 記事データの配列への格納
    $arr_message = array();
    $arr_message['id']    = $arr_record['message_id'];
    $arr_message['name']   = $arr_record['name'];
    $arr_message['title']  = $arr_record['title'];
    $arr_message['message'] = $arr_record['message'];
    $arr_message['date']   = $arr_record['date'];

    // 1個の記事本文の表示
    message_disp($arr_message);
    print "&lt;br&gt;\n";
   }
   print "&lt;/p&gt;";
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs);
   $mysqli->close();
  }
  else
  {
   print "&lt;p class=ac&gt;";
   print "&lt;font class='red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";
   print "&lt;/p&gt;";
  }
 }
 print "&lt;p class='ac'&gt;";
 // 入力フォームの表示
 input_form_disp($str_name,$str_title,$str_message);
 print "&lt;/p&gt;";
?&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php

// ユーザ定義関数

// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
 $str = "";
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];

 // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
 $str_name = input_str_convert($str_name);
 $str_title = input_str_convert($str_title);
 $str_message = input_str_convert($str_message);
 // 文字列が空かいなかのチェック
 if($str_name == "")
 {
  $str = "氏名を記入してください";
 }
 elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
 // 改行タグの改行コードへの変換
 $str_message = preg_replace( "/(&lt;br&gt;|&lt;br \/&gt;)/", "\n", $str_message);

?&gt;
 &lt;table border="0"&gt;
 &lt;form method="post"&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="60"
              value="&lt;?=$str_name?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"
                value="&lt;?=$str_title?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;
  &lt;td&gt;&lt;textarea name="message" 
         rows="5" cols="60"&gt;&lt;?=$str_message?&gt;&lt;/textarea&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// 入力文字列の整形処理
function input_str_convert($str)
{
 if($str != "")
 {
  // 文字列の前後の半角スペースを削除
  $str = trim($str);
  // 半角カタカナを全角カタカナに変換
  // V: 濁点付きの文字を１文字に変換
  // K: 半角カタカナを全角カタカナに変換
  $str = mb_convert_kana($str,'KV');
 }
 return $str;
}
</pre>

<p>「main01i.php」ファイルにより記事を送信した例を以下に示します．スタイルシートによりデザインされています．</p>
		<img src="./files/10501101.png" width="600"> 
		<img src="./files/1050110.png" width="600">


<h4>6.1.18　記事の一覧をページ単位で表示する</h4>
<p>これまでのサンプルリストでは，すべての記事を一覧表示していました．記事数が少ない場合はこれでもいのですが，記事数が多くなると，５件とか１０件あるいは２０件ごとに表示する必要がでてきます．このような表示方法をページ単位表示と呼ぶこととします．SQL文の中のselect文には，limit句があり，例えば検索結果のレコードの内，２１番目から１０個を取り出す，ということが可能になります．この場合のselect文は以下のように記述します．</p>
 
  <p class="command-print">select * from テーブル名<br>
    where 条件式<br>
    limit オフセット　,　ページサイズ</p>
<p>２１番目から１０個を取り出す場合，オフセットの値を21に，ページサイズの値を10にします．また，このようなページ単位表示では，以下のように「前の１０ページ」，「次の１０ページ」のようなナビゲーションをハイパーリンクで作るのが一般的です．</p> 
  <p class="command-print">［前の１０ページ］　　　　　　　　３／２０　　　　　　　　　　　［次の１０ページ]</p>
<p>「３／２０」は，現在のページが第３ページ目で，総ページ数が２０ページであることを示しています．なお，ハイパーリンクでは，URLでSQL文，指定ページ番号を引き継ぐ必要があります．一般に以下の書式になります．</p> 
  <p class="command-print">&lt;a href="ファイル名?sql=SQL文&amp;page=ページ番号"&gt;次の１０ページ&lt;/a&gt;</p>
<p>ここで，ファイル名は，ジャンプ先のファイル名で，「?」はこの後にGETメソッドで引き継ぐ変数とその値のペアが続くことを示す記号です．「=」はその左側が変数名でその右側が変数の値を示します．最初の変数は「sql」で，その値は「SQL文」です．「&amp;」は，変数のペアの区切り符号です．２番目の変数は「page」で，その値は「ページ番号」です．なお，このとき，文字列からなるSQL文はURLエンコードしておく必要があります．ページ番号は数値なのでその必要はありません．また，入力フォームから記事データをPOSTメソッドで送信するようにもなっていますが，ここまで&lt;form&gt;タグ要素の中の「action」属性は省略してきていました．その場合は，現在のURLがそのまま引き継がれます．たとえば，ページ移動した直後のURLは，以下のようになっています．</p> 
  <p class="command-print">http://main01j.php?sql=（SQL文のURLエンコード）&amp;page=（ページ番号）</p>
<p>この状態で入力フォームに記事を記入し，送信ボタンをクリックすると，POSTメソッドで記事データを送信しますが，URLにGETメソッドのための文字列が付加されているので，GETメソッドでもSQL文とページ番号を送信してしまいます．このようなあいまいさを避けるために，ここでは&lt;form&gt;タグ要素の中の「action」属性は省略せず，</p> 
  <p class="command-print">&lt;form method='post' <font color="#FF0000">action='main01j.php</font></h4>'&gt;</p>
<p>と明記します．実際には，現在のファイル名を定数THIS_FILEに代入し，定数THIS_FILEを使用することとします．</p> 
  <p class="command-print">&lt;?php<br>
  <font color="#FF0000">define(THIS_FILE,"main01j.php");</h4></font><br>
    ?&gt; <br>
    -----<br>
    <br>
    ----- <br>
    &lt;form method='post' <font color="#FF0000">action='&lt;?=THIS_FILE'</h4></font>&gt;</p>
<p>記事をページ単位で表示するようにしたサンプルリストを「main01j.php」とし，以下に示します．</p> 
<pre class="brush:php;">
&lt;?php
define(THIS_FILE,"main01j.php");
// ページサイズ
$page_size = 5;
?&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;meta http-equiv="Content-Style-Type" content="text/css"&gt;
&lt;link rel="stylesheet" type="text/css" href="common.css"&gt;
&lt;/head&gt;
&lt;body class="b_ffff99"&gt;
&lt;?php
 // データベースへの接続と選択
 // データベースサーバへの接続・データベースの選択
 $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 
 
  if(isset($_GET['page'])&&$_GET['page'] &gt; 0)
  {
   // ページ番号
   $page = $_GET['page'];
   // SQL文
   $str_sql = $_GET['sql'];
   
   // ページ単位表示
   page_disp($str_sql,$page,$page_size,$mysqli);
   
  }
  // 「送信」の場合
 elseif(isset($_POST['command'])&&$_POST['command'] == "送信")
  {
   // 受信データが「空」でないかどうかチェック
   $str_error_message = data_check($str_name,$str_title,$str_message);
   
   if($str_error_message == "")
   {
    // 改行コードを改行タグに変換
    $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str_message);
    // 現在日時の取得
    $str_date = date("Y-m-d H:i:s",time());
     // 「message_id」の生成
     // tbl_bbs1テーブルのmessage_idの最大値の取得
     $str_sql = "select max(message_id) as max_id from tbl_bbs1;";
    $rs = $mysqli->query($str_sql);
    $arr_record = array();
    $arr_record = $rs->fetch_assoc();
    $max_id = $arr_record['max_id'];
    if($max_id &gt; 0)
    {
     $new_id = $max_id + 1;
     }
    else
    {
     $new_id = 1;
    } 
   // データのテーブルへの保存
    $str_sql = "insert into tbl_bbs1 "
          . "(message_id,name,title,message,date)"
          . "values("
          . $new_id. ",'" . $str_name . "','" . $str_title
          . "','" . $str_message . "','" . $str_date . "');";
     //print $str_sql;
     $mysqli->query($str_sql);
    
    // データのリセット
    $new_id = "";
    $str_name = "";
    $str_title = "";
     $str_message = "";
    $str_date = ""; 
    
     // テーブルのデータの一覧取得（最後に「;」をつけない）
    $str_sql = "select * from tbl_bbs1 order by message_id desc";
     
     // 第１ページ目の設定
     $page = 1;
    
    // ページ単位表示
    page_disp($str_sql,$page,$page_size,$mysqli);
     
    $mysqli->close();
   }
   else
   {
    print "&lt;p class='ac'&gt;";
    print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";
    print "&lt;/p&gt;";
    }
  }
  print "&lt;p class='ac'&gt;";
  
  // 入力フォームの表示
  input_form_disp($str_name,$str_title,$str_message);
  print "&lt;/p&gt;";
?&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
// ユーザ定義関数
// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
  $srt = "";
  // データの受信
  $str_name   = $_POST['name'];
  $str_title    = $_POST['title'];
  $str_message = $_POST['message'];
  // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
  $str_name   = input_str_convert($str_name);
  $str_title    = input_str_convert($str_title);
  $str_message = input_str_convert($str_message);
  // 文字列が空かいなかのチェック
  if($str_name == "")
  {
   $str = "氏名を記入してください";
  }
  elseif($str_title == "")
  {
   $str = "タイトルを記入してください";
  }
  elseif($str_message == "")
  {
   $str = "本文を記入してください";
  }
  return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
  // 改行タグの改行コードへの変換
  $str_message = preg_replace( "/(&lt;br&gt;|&lt;br \/&gt;)/",   "\n", $str_message);
?&gt;
  &lt;table border="0"&gt;
  &lt;form method="post"  aciton='&lt;?=THIS_FILE?&gt;'&gt;
  &lt;tr&gt;
   &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="30"
                    value="&lt;?=$str_name?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"
                    value="&lt;?=$str_title?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;
  &lt;td&gt;&lt;textarea name="message" 
           rows="5" cols="60"&gt;&lt;?=$str_message?&gt;&lt;/textarea&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// 入力文字列の整形処理
function input_str_convert($str)
{
 if($str != "")
 {
  // 文字列の前後の半角スペースを削除
  $str = trim($str);
  // 半角カタカナを全角カタカナに変換
  // V: 濁点付きの文字を１文字に変換
  // K: 半角カタカナを全角カタカナに変換
  $str = mb_convert_kana($str,'KV');
 }
 return $str;
}

// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
*/
?&gt;
 &lt;table class="bd_w1 bd_solid bd_b
     padding3 bd_spacing0 bd_collapse w600"&gt;
 &lt;tr class="b_dcdcdc xs"&gt;
  &lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
      &lt;span class="fbold"&gt;［&lt;?=$arr_message['name']?&gt;］ &lt;/span&gt;
      &lt;span class="696969"&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr class="b_w xs"&gt;
  &lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql    ：SQL文（最後に「;」はつけていないこと）
$page     ：ページ番号
$page_size  ：ページサイズ
$db       ：データベース接続リソース
*/
 if($str_sql != "" && $page &gt; 0)
 {
     
  // limit句なしでSQL文の実行
  $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
   if($page &gt; 0 && $page &lt;= $total_page)
   {
    // ページ数の値が正しい場合
    // オフセットの設定
    $offset = ($page - 1) * $page_size;

    // SQL文にlimit句追加
     $str_sql_limit = $str_sql . " limit " 
               . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);
    
    // ページの表示
     print "&lt;p class='ac'&gt;";
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
    
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
     {
      // 記事データの配列への格納
      $arr_message = array();
      $arr_message['id']     = $arr_record['message_id'];
     $arr_message['name']   = $arr_record['name'];
     $arr_message['title']    = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date']    = $arr_record['date'];
     
     // 1個の記事本文の表示
     message_disp($arr_message);
     print "&lt;br&gt;\n";
    }
    
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
    print "&lt;/p&gt;";
    
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{
/*
$str_sql    : SQL文（最後に「;」がついていないこと
$page     : ページ番号
$total_page : 全ページ数
$page_size  : １ページ内のレコード数
*/
 // URLエンコード
 $str_sql_encoded = rawurlencode($str_sql);
 // URL文字列生成
 $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
          . "&page=" ;
  // ページナビゲータ表示
  print "&lt;table class='bd_w0'&gt;\n";
  print "&lt;tr&gt;\n";
  print "&lt;td class='al w250'&gt;";
  
  if($page &gt; 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);
   
   print "[&lt;a href=" . $str_url_before . "&gt;前の"    
   . $page_size . "ページ&lt;/a&gt;]\n";
  }
  else
  {
   print "&lt;span class='silver'&gt;[前の{$page_size}ページ]&lt;/span&gt;";
  }
  
  print "&lt;/td&gt;\n";
  print "&lt;td class='ac w100'&gt;\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "&lt;/td&gt;\n";
  print "&lt;td class='ar w250'&gt;\n";
  
  if($page &lt; $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[&lt;a href=" . $str_url_next . "&gt;次の"    
  . $page_size . "ページ&lt;/a&gt;]\n";
  }
  else
  {
   print "&lt;span class='silver'&gt;[次の{$page_size}ページ]&lt;/span&gt;";
  }
  print "&lt;/td&gt;\n";
  print "&lt;/tr&gt;\n";
  print "&lt;/table&gt;\n";
}
?&gt;
</pre>

<p>「main01j.php」ファイルにアクセスし，記事を送信した結果を以下に示します．ここでは，ページサイズは５ページであり，最初の５ページが表示されます．また，ページナビゲータの「次の５ページ」のハイパーリンクも表示されています．</p>
 
<img src="./files/1050111.png" width="600">

<p>「次の５ページ」のハイパーリンクをクリックすると，次の第２ページ目が表示されます．</p>
 
		<img src="./files/1050112.png" width="600">


<h4>6.1.19　セキュリティ対策等のための文字列変換</h4>
<p>（１）ブラウザー等から受信したデータに対する文字列変換</p><p>「Webアプリケ竏茶VョンのためのPHP入門」の３．４で述べたように，セキュリティ対策やエスケープ文字処理のために，WebサーバがHTMLフォーム等からGETメソッドやPOSTメソッドで文字列データを受信した場合，受信後に以下の処理を行うことが必要です．</p> 
<p>①stripslashes()関数により，「'」，「"」，「\」のエスケープ処理された文字を元にもどす．<br>
    ②htmlspecialchars()に関数により，「&lt;」，「&gt;」，「&amp;」，「"」，「'」をHTML実体参照に変換する．<br>
    ③nl_rep_br()関数により，改行コードを改行タグ「&lt;br&gt;」に変換する．</p>
  <p class="caution-print">改行コードを改行タグ「&lt;br&gt;」に変換する組み込み関数nl2br（）関数がありますが，厳密には例えば「\n」は「&lt;br&gt;\n」に変換され，「改行コード「\n」は削除されず残されています．<br>
    ここでは，改行コードを削除するユーザ定義関数 nl_rep_br()関数を使うこととします．</p>
<p>このユーザ定義関数名を「tag_entity_input()」とすることとします．</p><p>（２）フォームの要素に初期値として表示するデータに対する文字列変換</p><p>また，上記５．１で述べたように入力データをHTMLフォームのテキストエリアに表示する場合は，改行タグを改行コードにもどしておく必要があります．このユーザ定義関数名を「tag_entity_form()」とすることとします．</p><p>（３）SQL文の文字列に対する文字列変換</p><p>SQL文では，「'」や「"」は，文字列の区切り記号として使われるので，文字列そのものの中に「'」や「"」がある場合は，あらかじめエスケープ処理のための文字列変換処理をしておく必要があります．MySQLには，現在の文字エンコーディングを考慮した組み込み関数「$mysqli->real_escape_string()」関数があります．「tag_entity_input()」と「tag_entity_form()」のサンプルリストを以下に示します．これらの関数は，インクルードファイル「common.php」内に記述し，使用することとします．なお，「common.php」ファイルはさらに「user.php」ファイルをインクルードしています．</p> 

「common.php」内に記述
  <pre class="brush:php;">
// -------------------------------------
// 改行コードを改行タグ「&lt;br /&gt;」に変換
function nl_rep_br($str)
{
/*
 $string ： 入力文字列
 戻り値 ： 変換後文字列
*/
 // 改行コードを改行タグに変換
 $str = preg_replace( "/(\r\n|\r|\n)/", "&lt;br /&gt;", $str);
 return $str;
} // -------------------------------------
// GETメソッド，POSTメソッドによる入力データ変換処理
// (HTMLタグ等をHTML実体参照に変換するモードの場合)
function tag_entity_input($string,$str_charset)
{
/*
 $string   ： 入力文字列
 $str_charset: 文字コード(EUCJP/Shift-JIS/UTF-8) 
 戻り値   ： 変換後文字列
*/
 if(empty($string)) {return "";}
 
 // 「'」,「"」,「\」のエスケープ処理された文字を元にもどす
 $string = stripslashes($string);
 
 // 「&lt;」,「&gt;」,「&」,「"」,「'」をHTML実体参照に変換する
 // ENT_QUOTES : 「"」と「'」の両方を変換するモード
 $string = htmlspecialchars($string,ENT_QUOTES,'UTF-8');
 
 // 改行コードを改行タグ「&lt;br /&gt;」に変換する．
 $string = nl_rep_br($string);
 return $string;
}

// -------------------------------------
// HTMLフォームのテキストエリアにデータを表示する直前の
// データ変換処理
// (HTMLタグ等をHTML実体参照に変換するモードの場合)
function tag_entity_form($string)
{
/*
 $string ： 入力文字列
 戻り値 ： 変換後文字列
*/
 if(empty($string)) {return "";}
 
 // 改行タグを改行コードに変換
 $string = preg_replace( "/(&lt;br&gt;|&lt;br \/&gt;)/", "\n", $string);
 return $string;
}
</pre>

<p>セキュリティ対策等のための文字列変換を行う場合のサンプルリストの概要を以下に示します．</p> 
  <p class="command-print">&lt;?php<br>
  <font color="#FF0000">include "common.php";　</h4></font><br>
    ------ <br>
    <br>
    ------ <br>
    // 「送信」の場合<br>
    elseif(isset($_POST['command'])&&$_POST['command'] == "送信")<br>
    {<br>
    　// 受信データが「空」でないかどうかチェック<br>
    　$str_error_message = data_check($str_name,$str_title,$str_message);<br>
    　if($str_error_message == "")<br>
    　{<br>
    　----<br>
    <br>
    　　<font color="#FF0000">$str_name 　　= $mysqli->real_escape_string($str_name);<br>
    　　$str_title 　　　= $mysqli->real_escape_string($str_title);<br>
    　　$str_message = $mysqli->real_escape_string($str_message);</font></h4><br>
    <br>
    　　　// データのテーブルへの保存<br>
    　　<font color="#FF0000">$str_sql</font></h4> = "insert into tbl_bbs1 
    "<br>
    　　　　　　. "(message_id,name,title,message,date)"<br>
    　　　　　　　. "values("<br>
    　　　　　 　 . $new_id. ",'" . <font color="#FF0000">$str_name</font></h4> 
    . "','" . <font color="#FF0000">$str_title</font></h4><br>
    　　　　　　 . "','" . <font color="#FF0000">$str_message</font></h4> 
    . "','" . $str_date . "');";<br>
    <br>
    　　<font color="#FF0000"> $mysqli->query($str_sql);</font></h4><br>
    <br>
    <br>
    <br>
    // ----------------------------------------------<br>
    // 受信データのチェック<br>
    function data_check(&amp;$str_name,&amp;$str_title,&amp;$str_message)<br>
    {<br>
    /*<br>
    $str_name ：投稿者氏名<br>
    $str_title ：記事タイトル<br>
    $str_message ：記事本文<br>
    */<br>
    　 // データの受信<br>
    　 $str_name　　　= $_POST['name'];<br>
    　 $str_title 　　　= $_POST['title'];<br>
    　 $str_message = $_POST['message'];<br>
    <br>
    　//　受信データのセキュリティ対策等のための文字列変換処理<br>
    　<font color="#FF0000">$str_name　　　= tag_entity_input($str_name);<br>
    　$str_title 　　　= tag_entity_input($str_title);<br>
    　$str_message = tag_entity_input($str_message);</font></h4><br>
    <br>
    　 // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換<br>
    　 $str_name 　　= input_str_convert($str_name);<br>
    　 $str_title　　　 = input_str_convert($str_title);<br>
    　 $str_message = input_str_convert($str_message);<br>
    　 // 文字列が空かいなかのチェック<br>
    　-----　<br>
    　<br>
    　-----<br>
    　 return $str;<br>
    }<br>
    <br>
    // ----------------------------------------------<br>
    // 入力フォームの表示<br>
    function input_form_disp(&amp;$str_name,&amp;$str_title,&amp;$str_message)<br>
    {<br>
    　// 改行タグの改行コードへの変換<br>
    　<font color="#FF0000">$str_message = tag_entity_form($str_message);</font></h4><br>
    <br>
    ?&gt;<br>
    　&lt;table border="0"&gt;<br>
    　&lt;form method="post"&gt;<br>
    　-----<br>
    <br>
    　-----<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt;記事&lt;/td&gt;<br>
    　　&lt;td&gt;<font color="#FF0000">&lt;textarea</font></h4> name="message" 
    <br>
    　　　　　　　　　rows="5" cols="60"&gt;&lt;?=<font color="#FF0000">$str_message</font></h4>?&gt;<font color="#FF0000">&lt;/textarea&gt;</font></h4>&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;tr&gt;<br>
    　　&lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" 
    value="送信"&gt;&lt;/td&gt;<br>
    　&lt;/tr&gt;<br>
    　&lt;/form&gt;<br>
    　&lt;/table&gt;<br>
    &lt;?php<br>
    }<br>
  </p>

<p>「common.php」の全容です．</p>

common.php(前の章からのデータに追記しています)
<pre class="brush: php;">
<?php
// include file(common.php)
// インクルードファイルの読み込み
include "user.php";

// -------------------------------------
// ユーザ定義関数
/*
disp_arr          // 配列のダンプ表示（デバグ用）
disp_func         // 関数名の表示（デバグ用）
disp_mes          // メッセージの表示（デバグ用）
disp_var          // 変数の表示（デバグ用）
disp_var_hex      // 変数の16進数表示（デバグ用)
nl_rep_br         // 改行コードを改行タグ「<br />」に変換
tag_entity_input  // メソッドによる入力データ変換処理
tag_entity_form   // フォーム表示データの変換処理
*/

// ----------------------------------------------
// 配列のダンプ表示（デバグ用）
function disp_arr($disp,&$arr,$arr_name)
{
/*
$disp     = 表示モード
            (=0:非表示、=1:黒文字で表示、=2:赤文字で表示、=3:青文字で表示
             =4:ライム色で表示、=5:アクア色で表示)
$arr      = 配列の値
$arr_name = 配列名
DEBUG     = デバグモード指定定数（インクルードファイルuser.php内で定義）
            (=0:非デバグモード、=1:デバグモード)
*/
   if(DEBUG == 0){return;}
   if($disp == 0) {return;}
   if($disp == 1)
   {
      $color = "black";
   }
   elseif($disp == 2)
   {
      $color = "red";
   }
   elseif($disp == 3)
   {
      $color = "blue";
   }
   elseif($disp == 4)
   {
      $color = "lime";
   }
   elseif($disp == 5)
   {
      $color = "aqua";
   }

   print "<span style='color:" .$color . "'>";

   // 配列でない場合
   if(!is_array($arr))
   {
      print $arr_name . "= [" . $arr . "] is not array<br>\n";
      return;
   }

   if(count($arr) < 1 )
   {
      print $arr_name . "[] is empty<br>\n";
      return;
   }

   print "<br>\n";
   foreach($arr as $key => $value) 
   {
      if(is_array($value)) 
      {
         foreach($value as $key2 => $value2) 
         {
            if(is_array($value2)) 
            {
               foreach($value2 as $key3 => $value3)
               {
                  if(is_array($value3)) 
                  {
                     foreach($value3 as $key4 => $value4)
                     {
                        print $arr_name . "[" . $key . "][". $key2 . "][" . 
                              $key3 . "][". $key4 . "]=" . $value4 . "<br>\n";
                     }
                  } 
                  else 
                  {
                     print $arr_name . "[" . $key . "][". $key2 . "][" . 
                                      $key3 . "]=" . $value3 . "<br>\n";
                  }
               }
            } 
            else 
            {
               print $arr_name . "[" . $key . "][". $key2 . "]=" . 
                                                 $value2 . "<br>\n";
            }
         }
         print "<br>\n";
      }else
      {
         print $arr_name . "[" . $key . "]=" . $value . "<br>\n";
      }
   }
   print "</span>\n";
}

// ----------------------------------------------
// 関数名の表示（デバグ用）
function disp_func($on,$f_name,$mess) 
{
/*
$on       = 表示モード
            (=0:非表示、=1:黒文字で表示、=2:赤文字で表示、=3:青文字で表示
             =4:ライム色で表示、=5:アクア色で表示)
$f_name   = 関数名
$mess     = 表示メッセージ（入口："Hi"、出口："Bye"）
DEBUG     = デバグモード指定定数（インクルードファイルuser.php内で定義）
            (=0:非デバグモード、=1:デバグモード)
*/
   if(DEBUG == 0){return;}

   if($on == 1)
   {
      $color = "black";
   }
   elseif($on == 2)
   {
      $color = "red";
   }
   elseif($on == 3)
   {
      $color = "blue";
   }
   elseif($on == 4)
   {
      $color = "lime";
   }
   elseif($on == 5)
   {
      $color = "aqua";
   }

   if($on != 0) 
   {
      print "<span style='color:" .$color . "'>";

      print "<br>【" . $mess . " ! " . $f_name . "】<br>\n";

      print "</span>\n";
   }
}

// ----------------------------------------------
// メッセージの表示（デバグ用）
function disp_mes($disp,$str_mes)
{
/*
$disp     = 表示モード
            (=0:非表示、=1:黒文字で表示、=2:赤文字で表示、=3:青文字で表示
             =4:ライム色で表示、=5:アクア色で表示)
$str_mes  = メッセージ
DEBUG     = デバグモード指定定数（インクルードファイルuser.php内で定義）
             (=0:非デバグモード、=1:デバグモード)
*/
$on = 1;
disp_func($on,'disp_mes','Hi');
   if(DEBUG == 0){return;}
   if($disp == 0) {return;}

   if($disp == 1)
   {
      $color = "black";
   }
   elseif($disp == 2)
   {
      $color = "red";
   }
   elseif($disp == 3)
   {
      $color = "blue";
   }
   elseif($disp == 4)
   {
      $color = "lime";
   }
   elseif($disp == 5)
   {
      $color = "aqua";
   }
   print "<span style='color:" .$color . "'>" 
         . $str_mes . "</span><br>\n";
disp_func($on,'disp_mes','Bye');
}

// ----------------------------------------------
// 変数の表示（デバグ用）
function disp_var($disp,$var,$var_name){
/*
$disp     = 表示モード
            (=0:非表示、=1:黒文字で表示、=2:赤文字で表示、=3:青文字で表示
             =4:ライム色で表示、=5:アクア色で表示)
$var      = 変数の値
$var_name = 変数名
DEBUG     = デバグモード指定定数（インクルードファイルuser.php内で定義）
               (=0:非デバグモード、=1:デバグモード)
*/
   if(DEBUG == 0){return;}
   if($disp == 0) {return;}
   if($disp == 1)
   {
      $color = "black";
   }
   elseif($disp == 2)
   {
      $color = "red";
   }
   elseif($disp == 3)
   {
      $color = "blue";
   }
   elseif($disp == 4)
   {
      $color = "lime";
   }
   elseif($disp == 5)
   {
      $color = "aqua";
   }


   elseif(is_null($var))
   {
      $var = "NULL";
   }

   elseif($var === FALSE)
   {
      $var = "FALSE";
   }
   elseif($var === TRUE)
   {
      $var = "TRUE";
   }

   print "<span style='color:" .$color . "'>" 
             . $var_name . "=" . $var . "</span><br>\n";
}
// ----------------------------------------------
// 変数の16進数表示（デバグ用）
function disp_var_hex($disp,$var,$var_name)
{
/*
$disp     = 表示モード
            (=0:非表示、=1:黒文字で表示、=2:赤文字で表示、=3:青文字で表示
             =4:ライム色で表示、=5:アクア色で表示)
$var      = 変数の値
$var_name = 変数名
DEBUG     = デバグモード指定定数（インクルードファイルuser.php内で定義）
            (=0:非デバグモード、=1:デバグモード)
*/
   if(DEBUG == 0){return;}
   if($disp == 0) {return;}
   if($disp == 1)
   {
      $color = "black";
   }
   elseif($disp == 2)
   {
      $color = "red";
   }
   elseif($disp == 3)
   {
      $color = "blue";
   }
   elseif($disp == 4)
   {
      $color = "lime";
   }
   elseif($disp == 5)
   {
      $color = "aqua";
   }

   $var = "【" . bin2hex($var). "】";

   print "<span style='color:" .$color . "'>" 
             . $var_name . "=" . $var . "</span><br>\n";

}

// -------------------------------------
// 改行コードを改行タグ「<br />」に変換
function nl_rep_br($str)
{
/*
$string = 入力文字列
戻り値  = 変換後文字列
*/
  // 改行コードを改行タグに変換
  $str = preg_replace( "/(\r\n|\r|\n)/", "<br />", $str);
  return $str;
}

// -------------------------------------
// GETメソッド、POSTメソッドによる入力データ変換処理
// (HTMLタグ等をHTML実体参照に変換するモードの場合)
function tag_entity_input($string)
{
/*
$string = 入力文字列
戻り値  = 変換後文字列
*/
  if(empty($string)) {return "";}

  // 「'」,「"」,「\」のエスケープ処理された文字を元にもどす
  $string = stripslashes($string);

  // 「<」,「>」,「&」,「"」をHTML実体参照に変換する
  $string = htmlspecialchars($string);

  // 改行コードを改行タグ「<br>」に変換する。
  $string = nl_rep_br($string);
  return $string;
}

// -------------------------------------
// HTMLフォームのテキストエリアにデータを表示する直前のデータ変換処理
// (HTMLタグ等をHTML実体参照に変換するモードの場合)
function tag_entity_form($string)
{
/*
$string = 入力文字列
戻り値  = 変換後文字列
*/
  if(empty($string)) {return "";}

  // 改行タグを改行コードに変換
  $string = preg_replace( "/(<br>|<br \/>)/", "\n", $string);
  return $string;
}
</pre>

<p>以上を反映したサンプルリストを「main01K.php」として，以下に示します．</p> 
<pre class="brush:php;">
&lt;?php
include "common.php";
//define(THIS_FILE,"main01k.php");
const THIS_FILE = "main01k.php";
$str_charset = "UTF-8";
// ページサイズ
$page_size = 5;
?&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;meta http-equiv="Content-Style-Type" content="text/css"&gt;
&lt;link rel="stylesheet" type="text/css" href="common.css"&gt;
&lt;/head&gt;
&lt;body class="b_ffff99"&gt;
&lt;?php
  //変数に関する情報をダンプする．必要なければコメントアウトする
  var_dump($_post);
  // データベースへの接続と選択
  // データベースサーバへの接続・データベースの選択
 $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 
 
  
  // ページ番号を受信した場合
  if(isset($_GET['page'])&&$_GET['page'] &gt; 0)
  {
   // ページ番号
   $page = $_GET['page'];
   // SQL文
   $str_sql_encoded = $_GET['sql'];
  // URLエンコードしたデータのデコード
  $str_sql = rawurldecode($str_sql_encoded);
   // ページ単位表示
   page_disp($str_sql,$page,$page_size,$mysqli);
 }
  // 「送信」の場合
  elseif(isset($_POST['command'])&&$_POST['command'] == "送信")
 {
   // 受信データが「空」でないかどうかチェック
   $str_error_message = data_check($str_name,$str_title,$str_message);
    
  if($str_error_message == "")
  {
   // 改行コードを改行タグに変換
    $str_message = preg_replace( "/(\r\n|\r|\n)/", "&lt;br 
    /&gt;", $str_message);
    // 現在日時の取得
    $str_date = date("Y-m-d H:i:s",time());
    // 「message_id」の生成
    // tbl_bbs1テーブルのmessage_idの最大値の取得
    $str_sql = "select max(message_id) as max_id from tbl_bbs1;";
    $rs = $mysqli->query($str_sql);
    $arr_record = array();
    $arr_record = $rs->fetch_assoc();
    $max_id = $arr_record['max_id'];
    if($max_id &gt; 0)
    {
     $new_id = $max_id + 1;
    }
    else
    {
     $new_id = 1;
    } 
   // 文字列をSQLクエリー用にエスケープ
   $str_name    = $mysqli->real_escape_string($str_name);
   $str_title    = $mysqli->real_escape_string($str_title);
   $str_message = $mysqli->real_escape_string($str_message);
    
    // データのテーブルへの保存
    $str_sql = "insert into tbl_bbs1 "
        . "(message_id,name,title,message,date)"
        . "values("
        . $new_id. ",'" . $str_name . "','" . $str_title
        . "','" . $str_message . "','" . $str_date . "');";
    //print $str_sql;
    $mysqli->query($str_sql);
    // データのリセット
    $new_id = "";
    $str_name = "";
    $str_title = "";
    $str_message = "";
    $str_date = "";
     // テーブルのデータの一覧取得
    $str_sql = "select * from tbl_bbs1 order by message_id desc;";
    // 第１ページ目の設定
    $page = 1;
    // ページ単位表示
    page_disp($str_sql,$page,$page_size,$mysqli);
    $mysqli->close();
   }
   else
   {
    print "&lt;p align=center&gt;";
    print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";
    print "&lt;/p&gt;";
   }
  }
  print "&lt;p class='ac'&gt;";
  // 入力フォームの表示
  input_form_disp($str_name,$str_title,$str_message);
  print "&lt;/p&gt;";
?&gt;
  &lt;/body&gt;
  &lt;/html&gt;
&lt;?php
// ユーザ定義関数
// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
 global $str_charset;
  $str = "";
  // データの受信
  $str_name   = $_POST['name'];
  $str_title    = $_POST['title'];
  $str_message = $_POST['message'];
  // セキュリティ対策等処理
  $str_name   = tag_entity_input($str_name,$str_charset);
  $str_title    = tag_entity_input($str_title,$str_charset);
  $str_message = tag_entity_input($str_message,$str_charset);
  // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
  $str_name   = input_str_convert($str_name);
  $str_title    = input_str_convert($str_title);
  $str_message = input_str_convert($str_message);
  // 文字列が空かいなかのチェック
  if($str_name == "")
  {
   $str = "氏名を記入してください";
  }
  elseif($str_title == "")
  {
   $str = "タイトルを記入してください";
  }
  elseif($str_message == "")
  {
   $str = "本文を記入してください";
  }
  return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
  // 改行タグの改行コードへの変換
  $str_message = preg_replace( "/(&lt;br&gt;|&lt;br \/&gt;)/", "\n", $str_message);
?&gt;
 &lt;table border="0"&gt;
 &lt;form method="post"&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="60"
                  value="&lt;?=$str_name?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"
                    value="&lt;?=$str_title?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;
  &lt;td&gt;&lt;textarea name="message" 
           rows="5" cols="60"&gt;&lt;?=$str_message?&gt;&lt;/textarea&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// 入力文字列の整形処理
function input_str_convert($str)
{
 if($str != "")
  {
   // 文字列の前後の半角スペースを削除
   $str = trim($str);
   // 半角カタカナを全角カタカナに変換
   // V: 濁点付きの文字を１文字に変換
   // K: 半角カタカナを全角カタカナに変換
   $str = mb_convert_kana($str,'KV');
  }
  return $str;
}

// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
*/

?&gt;
&lt;table class="bd_w1 bd_solid bd_b
    padding3 bd_spacing0 bd_collapse w600"&gt;
&lt;tr class="b_dcdcdc xs"&gt;
 &lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
    &lt;span class="fbold"&gt;［&lt;?=$arr_message['name']?&gt;］ &lt;/span&gt;
    &lt;span class="696969"&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class="b_w xs"&gt;
 &lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/
  if($str_sql != "" && $page &gt; 0)
  {
  
   // オフセットの設定
   $offset = ($page - 1) * $page_size;
   
   // 「;」の削除
   $str_sql = preg_replace("/;/"," ",$str_sql);
   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql);
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page &gt; 0 && $page &lt;= $total_page)
  {
    // ページ数の値が正しい場合
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "&lt;p class='ac'&gt;";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "&lt;br&gt;\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "&lt;/p&gt;";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{

 // URLエンコード
  $str_sql_encoded = rawurlencode($str_sql);
  // URL文字列生成
  $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
           . "&page=" ;
  // ページナビゲータ表示
  print "&lt;table class='bd_w0'&gt;\n";
  print "&lt;tr&gt;\n";
  print "&lt;td class='al w250'&gt;";
  
 if($page &gt; 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);

   print "[&lt;a href=" . $str_url_before . "&gt;前の" 
         . $page_size . "ページ&lt;/a&gt;]\n";
  }
  else
  {
   print "&lt;span class='silver'&gt;[前の{$page_size}ページ]&lt;/span&gt;";
  }
  
 print "&lt;/td&gt;\n";
  print "&lt;td class='ac w100'&gt;\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "&lt;/td&gt;\n";
  print "&lt;td class='ar w250'&gt;\n";

 if($page &lt; $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[&lt;a href=" . $str_url_next . "&gt;次の"    
       . $page_size . "ページ&lt;/a&gt;]\n";
  }
  else
  {
   print "&lt;span class='silver'&gt;[次の{$page_size}ページ]&lt;/span&gt;";
  }
  print "&lt;/td&gt;\n";
  print "&lt;/tr&gt;\n";
  print "&lt;/table&gt;\n";
  }
?&gt;
</pre>

<p>「main01k.php」ファイルにアクセスし，以下のソースリストの記事を送信します．</p>
 
		<img src="./files/1050113.png" width="600">


<p>その結果，「&lt;」「&gt;」のタグや「"」が，もとのまま保存され，表示されていることがわかります．</p>
 
		<img src="./files/1050114.png" width="600">


<h4>6.1.20　記事検索</h4>
<p>ブラウザから入力したキーワードを含む記事を検索し，一覧表示します．画面の上部に検索キーワード入力用のフォームを作成し，「検索」ボタンをクリックすると，検索結果を表示するためのファイルquery.phpにアクセスするようにします．サンプルリストの概要を以下に示します．</p> 
  <p class="command-print"> &lt;form action="<font color="#FF0000">query.php</font></h4>" 
    method="post"&gt;<br>
    &lt;input type="text" name="<font color="#FF0000">keyword</font></h4>"&gt;<br>
    &lt;input type="submit" name="command" value="<font color="#FF0000">検索</font></h4>"&gt;<br>
    &lt;/form&gt;<br>
  </p>
<p>検索キーワードはPOSTメソッドで変数$str_keywordで受信し，tb_bbs1テーブルのmessageフィールドに対する部分一致検索を行い，message_idフィールドの逆順にソートすることとします．また，「記事入力」で「main01l.php」ファイルに戻り，記事入力フォームを表示し，「検索解除」のハイパーリンクで，「main01l.php」ファイルに戻り，全記事を表示するようににします．後者の場合，urlに「?page=all」を付加し，$_GET['page']が「all」のときに全記事を表示するようにします．サンプルリストの概要を以下に示します．</p> 
  <p class="command-print"> &lt;!-- 「記事入力」，「全記事表示」のハイパーリンクの表示 --&gt;<br>
    &lt;p class="ac"&gt;<br>
  <font color="#FF0000">&lt;a href="main01l.php"&gt;記事入力&lt;/a&gt;　｜　<br>
    &lt;a href="main01l.php?page=all"&gt;全記事表示&lt;/a&gt;</font></h4>&lt;br&gt;&lt;br&gt;<br>
    -----<br>
    -----<br>
    // 全記事表示（page=all）<br>
    if(<font color="#FF0000">$_GET['page'] == 'all'</font></h4>)<br>
    {<br>
    　// テーブルのデータの一覧取得<br>
    　$str_sql = "select * from tbl_bbs1 order by message_id desc;";<br>
    　 // 第１ページ目の設定<br>
    　$page = 1;// ページ単位表示<br>
    　page_disp($str_sql,$page,$page_size,$mysqli);　$mysqli->close();<br>
    }<br>
    elseif($_GET['page'] &gt; 0)<br>
    {<br>
    -----<br>
    <br>
    -----<br>
    }<br>
    // 「検索」の場合<br>
    <font color="#FF0000">elseif($_POST['command'] == "検索")<br>
    {<br>
    　// キーワードの受信<br>
    　$str_keyword = $_POST['keyword'];<br>
    <br>
    　// HTMLエンティティの変換<br>
    　$str_keyword = tag_entity_input($str_keyword,$str_charset);<br>
    <br>
    　// 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換<br>
    　$str_keyword = input_str_convert($str_keyword);<br>
    <br>
    　// キーワードが「空」でないかどうかチェック<br>
    　if($str_keyword != "")<br>
    　{<br>
    　　// SQL文のためのエスケープ処理<br>
    　　$str_keyword = $mysqli->real_escape_string($str_keyword);<br>
    <br>
    　　// 部分一致検索(最後に「;」をつけないこと）<br>
    　　$str_sql = "select * from tbl_bbs1"<br>
    　　　　　　 . " where message like '%{$str_keyword}%'"<br>
    　　　　　　 . " order by message_id desc";<br>
    　　 //print $str_sql;<br>
    <br>
    　　 // 第１ページ目の設定<br>
    　　 $page = 1;<br>
    <br>
    　　　// ページ単位表示<br>
    　　page_disp($str_sql,$page,$page_size,$mysqli);<br>
    <br>
    　　　$mysqli->close();<br>
    　 }<br>
    　 else<br>
    　 {<br>
    　　 $str_error_message = "キーワードを入力してください";<br>
    　　 print "&lt;p align=center&gt;";<br>
    　　 print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";<br>
    　　 print "&lt;/p&gt;";<br>
    　 }<br>
    }<br>
    </h4></font> </h4> </p>
<p>サンプルリストをmain01l.phpとquery.phpに示します．ただし，main01k.phpのソースリスト内に記述した以下のユーザ定義関数は，別途「common_bbs1.php」ファイル内に記述し，「include　common_bbs1.php;」によりファイル内に読み込むこととします．</p> 
  <p class="command-print">data_check()<br>
    input_form_disp()<br>
    input_str_convert()<br>
    message_disp()<br>
    page_disp()<br>
    page_navigater_disp() </p>
common_bbs1.php
<pre class="brush:php;">
&lt;?php
// ユーザ定義関数
// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
 global $str_charset
  // データの受信
  $str_name   = $_POST['name'];
  $str_title    = $_POST['title'];
  $str_message = $_POST['message'];
  // セキュリティ対策等処理
  $str_name   = tag_entity_input($str_name,$str_charset);
  $str_title    = tag_entity_input($str_title,$str_charset);
  $str_message = tag_entity_input($str_message,$str_charset);
  // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
  $str_name   = input_str_convert($str_name);
  $str_title    = input_str_convert($str_title);
  $str_message = input_str_convert($str_message);
  // 文字列が空かいなかのチェック
  if($str_name == "")
  {
   $str = "氏名を記入してください";
  }
  elseif($str_title == "")
  {
   $str = "タイトルを記入してください";
  }
  elseif($str_message == "")
  {
   $str = "本文を記入してください";
  }
  return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
*/
  // 改行タグの改行コードへの変換
  $str_message = preg_replace( "/(&lt;br&gt;|&lt;br \/&gt;)/", "\n", $str_message);
?&gt;
 &lt;table border="0"&gt;
 &lt;form method="post"&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="60"
                  value="&lt;?=$str_name?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" size="60"
                    value="&lt;?=$str_title?&gt;"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt;記事&lt;/td&gt;
  &lt;td&gt;&lt;textarea name="message" 
           rows="5" cols="60"&gt;&lt;?=$str_message?&gt;&lt;/textarea&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" value="送信"&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// 入力文字列の整形処理
function input_str_convert($str)
{
 if($str != "")
  {
   // 文字列の前後の半角スペースを削除
   $str = trim($str);
   // 半角カタカナを全角カタカナに変換
   // V: 濁点付きの文字を１文字に変換
   // K: 半角カタカナを全角カタカナに変換
   $str = mb_convert_kana($str,'KV');
  }
  return $str;
}

// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
*/

?&gt;
&lt;table class="bd_w1 bd_solid bd_b
    padding3 bd_spacing0 bd_collapse w600"&gt;
&lt;tr class="b_dcdcdc xs"&gt;
 &lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
    &lt;span class="fbold"&gt;［&lt;?=$arr_message['name']?&gt;］ &lt;/span&gt;
    &lt;span class="696969"&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class="b_w xs"&gt;
 &lt;td&gt;&lt;?=$arr_message['message']?&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/
  if($str_sql != "" && $page &gt; 0)
  {   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page &gt; 0 && $page &lt;= $total_page)
  {
    // ページ数の値が正しい場合
   // オフセットの設定
    $offset = ($page - 1) * $page_size;
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "&lt;p class='ac'&gt;";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "&lt;br&gt;\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "&lt;/p&gt;";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{

 // URLエンコード
  $str_sql_encoded = rawurlencode($str_sql);
  // URL文字列生成
  $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
           . "&page=" ;
  // ページナビゲータ表示
  print "&lt;table class='bd_w0'&gt;\n";
  print "&lt;tr&gt;\n";
  print "&lt;td class='al w250'&gt;";
  
 if($page &gt; 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);

   print "[&lt;a href=" . $str_url_before . "&gt;前の" 
         . $page_size . "ページ&lt;/a&gt;]\n";
  }
  else
  {
   print "&lt;span class='silver'&gt;[前の{$page_size}ページ]&lt;/span&gt;";
  }
  
 print "&lt;/td&gt;\n";
  print "&lt;td class='ac w100'&gt;\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "&lt;/td&gt;\n";
  print "&lt;td class='ar w250'&gt;\n";

 if($page &lt; $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[&lt;a href=" . $str_url_next . "&gt;次の"    
       . $page_size . "ページ&lt;/a&gt;]\n";
  }
  else
  {
   print "&lt;span class='silver'&gt;[次の{$page_size}ページ]&lt;/span&gt;";
  }
  print "&lt;/td&gt;\n";
  print "&lt;/tr&gt;\n";
  print "&lt;/table&gt;\n";
  }
?&gt;
</pre>

main01l.php
<pre class="brush:php;">
&lt;?php
include "common.php";
include "common_bbs1.php";
const THIS_FILE = "main01l.php";
$str_charset = "UTF-8";
// ページサイズ
$page_size = 5;
?&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1:記事検索&lt;/title&gt;
&lt;meta http-equiv="Content-Style-Type" content="text/css"&gt;
&lt;link rel="stylesheet" type="text/css" href="common.css"&gt;
&lt;/head&gt;
&lt;body class="b_ffff99"&gt;
&lt;?php
 require_once('./Connections/localhost.php');
 
 // データベースへの接続と選択
 $mysqli = new mysqli($hostname, $username, $password, $database);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 

?&gt;
&lt;!-- 「記事入力」，「全記事表示」のハイパーリンクの表示 --&gt;
&lt;p class="ac"&gt;
&lt;a href="main01l.php"&gt;記事入力&lt;/a&gt; ｜ 
&lt;a href="main01l.php?page=all"&gt;全記事表示&lt;/a&gt;&lt;br&gt;&lt;br&gt;

&lt;!-- 検索キーワード入力部の表示 --&gt;
&lt;form action="query.php" method="post"&gt;
&lt;input type="text" name="keyword"&gt;
&lt;input type="submit" name="command" value="検索"&gt;
&lt;/form&gt;
&lt;/p&gt;&lt;?php

 // 全記事表示（page=all）
 if($_GET['page'] == 'all' && !isset($_POST['command'])
 {
  // テーブルのデータの一覧取得（最後に「;」をつけない）
  $str_sql = "select * from tbl_bbs1 order by message_id desc";

  // 第１ページ目の設定
  $page = 1;

  // ページ単位表示
  page_disp($str_sql,$page,$page_size,$mysqli);

  $mysqli->close();
 }
 // ページ番号を受信した場合
 elseif(isset($_GET['page'])&&$_GET['page'] &gt; 0)
 {
  // ページ番号
  $page = $_GET['page'];
  // SQL文
  $str_sql = $_GET['sql'];

  // ページ単位表示
  page_disp($str_sql,$page,$page_size,$mysqli);

 }
 // 「送信」の場合
 if(isset($_POST['command'])&&$_POST['command'] == "送信")
 {
  // 受信データが「空」でないかどうかチェック
  $str_error_message = data_check($str_name,$str_title,$str_message);
  disp_var(0,$str_message,'$str_message');
  if($str_error_message == "")
  {
   // 現在日時の取得
   $str_date = date("Y-m-d H:i:s",time());
   // 「message_id」の生成
   // tbl_bbs1テーブルのmessage_idの最大値の取得
   $str_sql = "select max(message_id) as max_id from tbl_bbs1;";
   $rs = $mysqli->query($str_sql);
   $arr_record = array();
   $arr_record = $rs->fetch_assoc();
   $max_id = $arr_record['max_id'];
   if($max_id &gt; 0)
   {
    $new_id = $max_id + 1;
   }
   else
   {
    $new_id = 1;
   }

   $str_name = $mysqli->real_escape_string($str_name);
   $str_title = $mysqli->real_escape_string($str_title);
   $str_message = $mysqli->real_escape_string($str_message);

   // データのテーブルへの保存
   $str_sql = "insert into tbl_bbs1 "
        . "(message_id,name,title,message,date)"
        . "values("
        . $new_id. ",'" . $str_name . "','" . $str_title
        . "','" . $str_message . "','" . $str_date . "');";
   //print $str_sql;
   $mysqli->query($str_sql);

   // データのリセット
   $new_id = "";
   $str_name = "";
   $str_title = "";
   $str_message = "";
   $str_date = "";

   // テーブルのデータの一覧取得（最後に「;」をつけない）
   $str_sql = "select * from tbl_bbs1 order by message_id desc";

   // 第１ページ目の設定
   $page = 1;

   // ページ単位表示
   page_disp($str_sql,$page,$page_size,$mysqli);

   $mysqli->close();
  }
  else
  {
   print "&lt;p align=center&gt;";
   print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";
   print "&lt;/p&gt;";
  }
 }
 print "&lt;p class='ac'&gt;";

 // 入力フォームの表示
 input_form_disp($str_name,$str_title,$str_message);
 print "&lt;/p&gt;";
?&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

query.php

<pre class="brush:php;">
&lt;?php
include "common.php";
include "common_bbs1.php";
const THIS_FILE = "query.php";
$str_charset = "UTF-8";
// ページサイズ
$page_size = 5;
?&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html;charset=utf-8" &gt;
&lt;title&gt;BBS1&lt;/title&gt;
&lt;meta http-equiv="Content-Style-Type" content="text/css"&gt;
&lt;link rel="stylesheet" type="text/css" href="common.css"&gt;
&lt;/head&gt;
&lt;body class="b_ffff99"&gt;
&lt;?php
 // データベースへの接続と選択
 // データベースサーバへの接続・データベースの選択
 $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 
 

?&gt;
&lt;!-- 「記事入力」，「全記事表示」のハイパーリンクの表示 --&gt;
&lt;p class="ac"&gt;
&lt;a href="main01l.php"&gt;記事入力&lt;/a&gt; ｜ 
&lt;a href="main01l.php?page=all"&gt;全記事表示&lt;/a&gt;&lt;br&gt;&lt;br&gt;

&lt;!-- 検索キーワード入力部の表示 --&gt;
&lt;form action="query.php" method="post"&gt;
&lt;input type="text" name="keyword"&gt;
&lt;input type="submit" name="command" value="検索"&gt;
&lt;/form&gt;
&lt;/p&gt;
&lt;?php

 // ページ番号を受信した場合
 if(isset($_GET['page'])&&$_GET['page'] &gt; 0)
 {
  // ページ番号
  $page = $_GET['page'];
  // SQL文
  $str_sql = $_GET['sql'];
  // URLエンコードしたデータのデコード
  // $str_sql = rawurldecode($str_sql);
  // 文字列をアンエスケープ
  $str_sql = stripslashes($str_sql);
  disp_var(1,$str_sql,'$str_sql');
  // ページ単位表示
  page_disp($str_sql,$page,$page_size,$mysqli);

 }
 // 「検索」の場合
 elseif(isset($_POST['command'])&&$_POST['command'] == "検索")
 {
  // キーワードの受信
  $str_keyword = $_POST['keyword'];

  // HTMLエンティティの変換
  $str_keyword = tag_entity_input($str_keyword,$str_charset);

  // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
  $str_keyword = input_str_convert($str_keyword);

  // キーワードが「空」でないかどうかチェック
  if($str_keyword != "")
  {
   // SQL文のためのエスケープ処理 
   $str_keyword = $mysqli->real_escape_string($str_keyword);

   // 部分一致検索(最後に「;」をつけないこと）
   $str_sql = "select * from tbl_bbs1"
        . " where message like '%{$str_keyword}%'"
        . " order by message_id desc";
 
   // 第１ページ目の設定
   $page = 1;

   // ページ単位表示
   page_disp($str_sql,$page,$page_size,$mysqli);
   
   $mysqli->close();
  }
  else
  {
   $str_error_message = "キーワードを入力してください";
   print "&lt;p align=center&gt;";
   print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";
   print "&lt;/p&gt;";
  }
 }
 print "&lt;p class='ac'&gt;"; 
?&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>「mai01l.php」ファイルにアクセスし，「テスト」をキーワード欄に入力し，「検索」ボタンを押します．</p>
 
		<img src="./files/1050115.png" width="600">


<p>結果は，次のように表示されます．</p>
 
		<img src="./files/1050116.png" width="600">


<p>検索結果もページ単位（ここでは５ページごと）に表示されます．</p>


<p>「全記事表示」リンクをクリックすると，検索結果表示が解除され，全部の記事がページ単位で表示されます．</p>
 
		<img src="./files/1050118.png" width="600">


<h3>6.2　再編集・引用可能なBBS（タイプ２）</h3>
<p>再編集（削除，更新）・引用可能な電子掲示板（BBS（タイプ２）)を作成することにより，以下のWebアプリケーションの基礎技術を習得します． 
</p> 
<p>・URLの登録<br>
    ・記事の削除<br>
    ・記事の更新</p>


<h4>6.2.1　データベースの作成</h4>
<p>以下に制作するBBSの記事は，タイプ１のBBSに対して「更新日」，「URL」，「パスワード」，「親記事番号」を含むものとします．これをタイプ２BBS（BBS2)と呼ぶこととします．</p>
  <table border="1" cellpadding="0" cellspacing="0" class="print">
    <tbody><tr class="print"> 
      <td class="print">フィールド名</td>
      <td class="print">型</td>
      <td class="print">長さ</td>
      <td class="print">説明</td>
      <td class="print">備考</td>
    </tr>
    <tr> 
      <td class="print">message_id</td>
      <td class="print">INTEGER</td>
      <td class="print">　</td>
      <td class="print">記事番号</td>
      <td class="print">主キー：自動入力</td>
    </tr>
    <tr> 
      <td class="print">name</td>
      <td class="print">CHAR</td>
      <td class="print">64</td>
      <td class="print">投稿者氏名</td>
      <td class="print">ブラウザから入力</td>
    </tr>
    <tr> 
      <td class="print">title</td>
      <td class="print">VARCHAR</td>
      <td class="print">255</td>
      <td class="print">タイトル</td>
      <td class="print">ブラウザから入力</td>
    </tr>
    <tr> 
      <td class="print">message</td>
      <td class="print">TEXT</td>
      <td class="print">　</td>
      <td class="print">記事本文</td>
      <td class="print">ブラウザから入力</td>
    </tr>
    <tr> 
      <td class="print">date</td>
      <td class="print">DATETIME</td>
      <td class="print">　</td>
      <td class="print">投稿日時</td>
      <td class="print">自動入力</td>
    </tr>
    <tr> 
      <td class="print"><font color="#FF0000">date_update</font></h4></td>
      <td class="print"><font color="#FF0000">DATETIME</font></h4></td>
      <td class="print"><font color="#FF0000"></font></h4></td>
      <td class="print"><font color="#FF0000">更新日</font></h4></td>
      <td class="print"><font color="#FF0000">自動入力</font></h4></td>
    </tr>
    <tr> 
      <td class="print"><font color="#FF0000">url</font></h4></td>
      <td class="print"><font color="#FF0000">VARCHAR</font></h4></td>
      <td class="print"><font color="#FF0000">255</font></h4></td>
      <td class="print"><font color="#FF0000">URL</font></h4></td>
      <td class="print"><font color="#FF0000">ブラウザから入力</font></h4></td>
    </tr>
    <tr> 
      <td class="print"><font color="#FF0000">pwd</font></h4></td>
      <td class="print"><font color="#FF0000">CHAR</font></h4></td>
      <td class="print"><font color="#FF0000">32</font></h4></td>
      <td class="print"><font color="#FF0000">パスワード</font></h4></td>
      <td class="print"><font color="#FF0000">ブラウザから入力</font></h4></td>
    </tr>
    <tr> 
      <td class="print"><font color="#FF0000">parent_id</font></h4></td>
      <td class="print"><font color="#FF0000">INTEGER</font></h4></td>
      <td class="print"><font color="#FF0000"></font></h4></td>
      <td class="print"><font color="#FF0000">親記事番号</font></h4></td>
      <td class="print"><font color="#FF0000">自動入力</font></h4></td>
    </tr>
    <tr> 
      <td class="print"><font color="#FF0000">mail</font></h4></td>
      <td class="print"><font color="#FF0000">VARCHAR</font></h4></td>
      <td class="print"><font color="#FF0000">255</font></h4></td>
      <td class="print"><font color="#FF0000">メールアドレス</font></h4></td>
      <td class="print"><font color="#FF0000">ブラウザから入力</font></h4></td>
    </tr>
  </tbody></table>
<p>データベース「db_bbs」の中に，上記のテーブル名を「tbl_bbs2」として作成します．</p><p>

<pre class="brush: sql;">

CREATE TABLE tbl_bbs2
(
  message_id  INTEGER,
  name        CHAR(64),
  title       VARCHAR(255),
  message     TEXT,
  date        DATETIME,
  date_update DATETIME,
  url         VARCHAR(255),
  pwd         CHAR(32),
  parent_id   INTEGER,
  mail        VARCHAR(255),
  PRIMARY KEY(message_id)
) ENGINE = MYISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

</pre>

	<img src="./files/chap6_07.jpg" width="600"> 

	<img src="./files/chap6_08.jpg" width="600">

<h4>6.2.2　URLの登録</h4>
<p>記事を投稿する場合，記事に関連するURLも投稿したくなる場合があります．ただ，記事の中にURLを記述できるようにするためには，記事にHTMLタグの記入を許容する必要があります．ただ，「6.1　セキュリティ対策等のための文字列変換」の項で述べたように，記事の中にHTMLタグの記入を許容することはセキュリティ対策上好ましくありません．そこで，URLのみを記述できる入力欄を新たに設けることとします．</p><p>（１）記事入力フォームへのURL入力欄の追加</p><p>まず，５．１で作成したインクルードファイルcommon_bbs1.phpの中の入力フォーム表示用のユーザ定義関数「input_form_disp()」を以下のように改造します．URL入力欄には初期値として「http://」と表示するようにします．</p>

common_bbs2.php
<pre class="brush: php;">
<?php
// ユーザ定義関数
// ----------------------------------------------
// 受信データのチェック
// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_title,&$str_message,&$str_url)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
*/
 global $str_charset;
 disp_var(1,$str_charset,'$str_charset');
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];
 $str_url = $_POST['url'];

 $str_name = tag_entity_input($str_name,$str_charset);
 $str_title = tag_entity_input($str_title,$str_charset);
 $str_message = tag_entity_input($str_message,$str_charset);

 // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
 $str_name = input_str_convert($str_name);
 $str_title = input_str_convert($str_title);
 $str_message = input_str_convert($str_message);
 // 文字列が空かいなかのチェック
 if($str_name == "")
 {
  $str = "氏名を記入してください";
 }
 elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 elseif($str_url != "http://")
 {
  if(!preg_match(MATCH_URL,$str_url))
  {
   $str = "URLを正しく記入してください";
  }
 }
 elseif($str_url == "http://")
 {
  $str_url = "";
 }
 return $str;
}

// ----------------------------------------------
// 入力フォームの表示
// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message,&$str_url)
{
/*
$str_name  ：投稿者氏名
$str_title  ：記事タイトル
$str_message ：記事本文
$str_url  ：関連URL
*/
 // 改行タグの改行コードへの変換
 $str_message = tag_entity_form($str_message);
 
 // URL欄の初期値設定
 if($str_url == "")
 {
  $str_url = "http://";
 }
?>
<table border="0">
<form method="post" action='<?=THIS_FILE?>'>
<tr>
 <td> </td><td>BBS1</td>
</tr>
<tr>
 <td>氏名</td><td><input name="name" size="30"
             value="<?=$str_name?>"></td>
</tr>
<tr>
 <td>タイトル</td><td><input name="title" size="60"
               value="<?=$str_title?>"></td>
</tr>
<tr>
 <td>記事</td>
 <td><textarea name="message" 
        rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
 <td>URL</td><td><input name="url" size="60"
            value="<?=$str_url?>"></td>
</tr>
<tr>
 <td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
</form>
</table>
<?php
}

// ----------------------------------------------
// 入力文字列の整形処理
function input_str_convert($str)
{
 if($str != "")
  {
   // 文字列の前後の半角スペースを削除
   $str = trim($str);
   // 半角カタカナを全角カタカナに変換
   // V: 濁点付きの文字を１文字に変換
   // K: 半角カタカナを全角カタカナに変換
   $str = mb_convert_kana($str,'KV');
  }
  return $str;
}

// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
$arr_message['url'] ：関連URL
*/
 $str_url = $arr_message['url'];
?>
<table class="bd_w1 bd_solid bd_b
         padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
 <td>No.<?=$arr_message['id']?> <?=$arr_message['title']?>
    <span class="fbold">［<?=$arr_message['name']?>］ </span>
    <span class="696969"><?=$arr_message['date']?></span></td>
</tr>
<tr class="b_w xs">
 <td><?=$arr_message['message']?>
<?php
 if($str_url != "")
 {
?>
<br>URL: <a href="<?=$str_url?>"><?=$str_url?></a></td>
<?php
 }
?>
</tr>
</table>
<?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/
  if($str_sql != "" && $page > 0)
  {   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page > 0 && $page <= $total_page)
  {
    // ページ数の値が正しい場合
   // オフセットの設定
    $offset = ($page - 1) * $page_size;
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "<p class='ac'>";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
     $arr_message['url'] = $arr_record['url'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "<br>\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "</p>";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{

 // URLエンコード
  $str_sql_encoded = rawurlencode($str_sql);
  // URL文字列生成
  $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
           . "&page=" ;
  // ページナビゲータ表示
  print "<table class='bd_w0'>\n";
  print "<tr>\n";
  print "<td class='al w250'>";
  
 if($page > 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);

   print "[<a href=" . $str_url_before . ">前の" 
         . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[前の{$page_size}ページ]</span>";
  }
  
 print "</td>\n";
  print "<td class='ac w100'>\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "</td>\n";
  print "<td class='ar w250'>\n";

 if($page < $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[<a href=" . $str_url_next . ">次の"    
       . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[次の{$page_size}ページ]</span>";
  }
  print "</td>\n";
  print "</tr>\n";
  print "</table>\n";
  }
?>
</pre>


<p>（２）受信URLのチェック</p><p>受信したURLデータが，URLとして正しい文字列かどうか，セキュリティ対策上チェックする必要があります．URL文字列$str_urlは，Perl互換の正規表現として，たとえば以下の正規表現に一致する必要があります．</p> 
  <p class="command-print">preg_match('/^http(s?)\:\/\/[\w\.\-\/\?\&amp;\+\=\:\@\%\#]+$/',$str_url)</p>
<p>ただ，受信URLの文字列が「http://」の場合は，初期値のままで未入力状態なので，この場合は受信URL文字列は「http://」でなく空にします．サンプルスクリプトでは，一致すべき正規表現パターンを定数MATCH_URLとして，インクルードファイルsystem02a.php内に定義して使用することとします．</p>

<p>この定数MATCH_URLを使用して，５．１で作成したインクルードファイルcommon_bbs1.phpの中の受信データチェック用のユーザ定義関数「data_check()」を以下のように改造します．</p>


common_bbs2.phpの一部抜粋(common_bbs1.phpを別名で保存して作成して下さい)
<pre class="brush: php;">
// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_title,&$str_message,&$str_url)
{
/*
$str_name ：投稿者氏名
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
*/
 global $str_charset;
 disp_var(1,$str_charset,'$str_charset');
 
 $str = "";
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];
 $str_url = $_POST['url'];

 $str_name = tag_entity_input($str_name,$str_charset);
 $str_title = tag_entity_input($str_title,$str_charset);
 $str_message = tag_entity_input($str_message,$str_charset);

 // 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換
 $str_name = input_str_convert($str_name);
 $str_title = input_str_convert($str_title);
 $str_message = input_str_convert($str_message);
 // 文字列が空かいなかのチェック
 if($str_name == "")
 {
  $str = "氏名を記入してください";
 }
 elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 elseif($str_url != "http://")
 {
  if(!preg_match(MATCH_URL,$str_url))
  {
   $str = "URLを正しく記入してください";
  }
 }
 elseif($str_url == "http://")
 {
  $str_url = "";
 }
 return $str;
}
</pre>


<p>（３）URLデータのデータベースへの保存</p><p>５．１で作成したメインファイルmain01l.phpファイルを以下のように改造し，main02a.phpファイルとします．また，５．１で作成した検索用ファイルquery.phpファイルをquery02.phpファイルとします．インクルードファイルcommon_bbs1.phpは上記改造を加えた上でcommon_bbs2a.phpとします．なお，インクルードファイルsystem02a.php内に以下の定数を定義し，使用することとします．</p>
<p>4行目の処理について説明します．受信したURLデータが，URLとして正しい文字列かどうか，セキュリティ対策上チェックする必要があります．URL文字列$str_urlは，Perl互換の正規表現として，たとえば以下の正規表現に一致する必要があります．ただ，受信URLの文字列が「http://」の場合は，初期値のままで未入力状態なので，この場合は受信URL文字列は「http://」でなく空にします．サンプルスクリプトでは，一致すべき正規表現パターンを定数MATCH_URLとして，インクルードファイルsystem02a.php内に定義して使用することとします．</p>

system02a.php
<pre class="brush: php;">
<?php
const COMMON_BBS_FILE = "common_bbs2a.php";
const MAIN_FILE = "main02a.php";
const QUERY_FILE = "query02.php";
const MATCH_URL = "/^http(s?)\:\/\/[\w\.\-\/\?\&\+\=\:\@\%\#]+$/";
?>
</pre>



main02a.php
<pre class="brush: php;">
<?php
include "system02a.php";
include "common.php";
const THIS_FILE = MAIN_FILE;
include COMMON_BBS_FILE;
$str_charset = "UTF-8";
// ページサイズ
$page_size = 5;
?>
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" >
<title>BBS1:記事検索</title>
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="common.css">
</head>
<body class="b_ffff99">
<?php
 // データベースへの接続と選択
 // データベースサーバへの接続・データベースの選択
 $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 
 
?>
<!-- 「記事入力」，「全記事表示」のハイパーリンクの表示 -->
<p class="ac">
<a href="<?=MAIN_FILE?>">記事入力</a> ｜ 
<a href="<?=MAIN_FILE?>?page=all">全記事表示</a><br><br>

<!-- 検索キーワード入力部の表示 -->
<form action="<?=QUERY_FILE?>" method="post">
<input type="text" name="keyword">
<input type="submit" name="command" value="検索">
</form>
</p><?php

 // 全記事表示（page=all）
 if(isset($_GET['page'])&&$_GET['page'] == 'all' && !isset($_POST['command']))
 {
  // テーブルのデータの一覧取得（最後に「;」をつけない）
  $str_sql = "select * from tbl_bbs2 order by message_id desc";

  // 第１ページ目の設定
  $page = 1;

  // ページ単位表示
  page_disp($str_sql,$page,$page_size,$mysqli);

  $mysqli->close();
 }
 // ページ番号を受信した場合
 elseif(isset($_GET['page'])&&$_GET['page'] > 0)
 {
  // ページ番号
  $page = $_GET['page'];
  // SQL文
  $str_sql = $_GET['sql'];

  // ページ単位表示
  page_disp($str_sql,$page,$page_size,$mysqli);

 }
 // 「送信」の場合
 if(isset($_POST['command'])&&$_POST['command'] == "送信")
 {
  // 受信データが「空」でないかどうかチェック
  $str_error_message = data_check($str_name,$str_title,$str_message
                  ,$str_url);
  if($str_error_message == "")
  {
   // 現在日時の取得
   $str_date = date("Y-m-d H:i:s",time());
   // 「message_id」の生成
   // tbl_bbs2テーブルのmessage_idの最大値の取得
   $str_sql = "select max(message_id) as max_id from tbl_bbs2;";
   $rs = $mysqli->query($str_sql);
   $arr_record = array();
   $arr_record = $rs->fetch_assoc();
   $max_id = $arr_record['max_id'];
   if($max_id > 0)
   {
    $new_id = $max_id + 1;
   }
   else
   {
    $new_id = 1;
   }

   $str_name = $mysqli->real_escape_string($str_name);
   $str_title = $mysqli->real_escape_string($str_title);
   $str_message = $mysqli->real_escape_string($str_message);

  // データのテーブルへの保存
  $str_sql = "insert into tbl_bbs2 "
       . "(message_id,name,title,message,date,url)"
       . "values("
       . $new_id. ",'" . $str_name . "','" . $str_title
       . "','" . $str_message . "','" . $str_date 
       . "','" . $str_url . "');";

  $mysqli->query($str_sql);

  // データのリセット
  $new_id = "";
  $str_name = "";
  $str_title = "";
  $str_message = "";
  $str_date = "";
  $str_url = "";

   // テーブルのデータの一覧取得（最後に「;」をつけない）
   $str_sql = "select * from tbl_bbs2 order by message_id desc";

   // 第１ページ目の設定
   $page = 1;

   // ページ単位表示
   page_disp($str_sql,$page,$page_size,$mysqli);

   $mysqli->close();
  }
  else
  {
   print "<p align=center>";
   print "<font style='color:red'>{$str_error_message}</font><br>\n";
   print "</p>";
  }
 }
 print "<p class='ac'>";

 // 入力フォームの表示
 input_form_disp($str_name,$str_title,$str_message, $str_url);
 print "</p>";
?>
</body>
</html>
?>
</pre>


<p>（４）URLデータの表示</p><p>インクルードファイルcommon_bbs2a.php内のユーザ定義関数page_disp()関数とmessage_disp()関数を以下のように改造します．</p>



common_bbs2a.php内のユーザ定義関数page_disp()関数とmessage_disp()関数
<pre class="brush: php;">
// -----------------------------------------------
// 1個の記事本文の表示
function message_disp(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
$arr_message['url'] ：関連URL
*/
 $str_url = $arr_message['url'];
?>
<table class="bd_w1 bd_solid bd_b
         padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
 <td>No.<?=$arr_message['id']?> <?=$arr_message['title']?>
    <span class="fbold">［<?=$arr_message['name']?>］ </span>
    <span class="696969"><?=$arr_message['date']?></span></td>
</tr>
<tr class="b_w xs">
 <td><?=$arr_message['message']?>
<?php
 if($str_url != "")
 {
?>
<br>URL: <a href="<?=$str_url?>"><?=$str_url?></a></td>
<?php
 }
?>
</tr>
</table>
<?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/
  if($str_sql != "" && $page > 0)
  {   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page > 0 && $page <= $total_page)
  {
    // ページ数の値が正しい場合
   // オフセットの設定
    $offset = ($page - 1) * $page_size;
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "<p class='ac'>";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
     $arr_message['url'] = $arr_record['url'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "<br>\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "</p>";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}
?>
</pre>


<p>main02a.phpにアクセスし，URLを記入した例を以下に示します．</p>
<img src="./files/1050201.png" width="600">

<p>「送信」ボタンをクリックすると，URLもデータベースに保存され，下記のように，URLがハイパーリンク化され表示されます．</p>
 
		<img src="./files/1050202.png" width="600">


<h4>6.2.3　削除可能なBBS</h4>
<p>投稿した記事を，後で投稿者が削除できるようなBBSを作成します．そのために記事を投稿するときに，パスワードも一緒に登録するようにします．記事を一覧表示した画面で，各記事に「削除」用リンクを表示し，「削除」用リンクをクリックすると，その記事を再表示するとともにパスワード入力欄も表示し，パスワードが入力され「削除」ボタンがクリックされると，当該記事を削除することとします．パスワードが登録されていない（パスワード欄が空）記事は削除できないこととします．また，パスワードは，セキュリティ上暗号化して保存しておくこととします．</p><p>（１）記事入力フォームへのパスワードの入力欄の追加</p><p>記事入力フォームへのパスワードの入力欄を追加します．そこで，インクルードファイルcommon_bbs2a.phpの中の入力フォーム表示用のユーザ定義関数「input_form_disp()」を以下のように改造します．パスワード入力欄では，自動的に半角英数字入力モードにします．具体的には，スタイルシートの「hankaku」クラスを指定します．</p> 
  <p class="command-print">// ----------------------------------------------<br>
    // 入力フォームの表示<br>
    function input_form_disp(&amp;$str_name,&amp;$str_title,&amp;$str_message,&amp;$str_url,<font color="#FF0000">&amp;$str_pwd</font></h4>)<br>
    {<br>
    /*<br>
    $str_name　　 ：投稿者氏名<br>
    $str_title　　　 ：記事タイトル<br>
    $str_message ：記事本文<br>
    $str_url　　　　 ：関連URL<br>
    <font color="#FF0000">$str_pwd　　　　：パスワード</h4></font><br>
    */<br>
    　// 改行タグの改行コードへの変換<br>
    　$str_message = tag_entity_form($str_message);<br>
    <br>
    　// URL欄の初期値設定<br>
    　if($str_url == "")<br>
    　{<br>
    　　$str_url = "http://";<br>
    　}<br>
    ?&gt;<br>
    &lt;table border="0"&gt;<br>
    &lt;form method="post" action='&lt;?=MAIN_FILE?&gt;'&gt;<br>
    &lt;tr&gt;<br>
    -----（略）-----<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;URL&lt;/td&gt;&lt;td&gt;&lt;input name="url" size="60"<br>
    　　　　　　　　　　　　　　　　　value="&lt;?=$str_url?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    <font color="#FF0000">　&lt;td&gt;パスワード&lt;/td&gt;<br>
    　&lt;td&gt;&lt;input type="password" name="pwd" 
    size="8"<br>
    　　　　　　　　class="hankaku" 　value="&lt;?=$str_pwd?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;</font></h4><br>
    &lt;tr&gt;<br>
    　&lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" 
    value="送信"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;/form&gt;<br>
    &lt;/table&gt;<br>
    &lt;?php<br>
    }<br>

  </p>
<p>（２）受信パスワードのチェック</p><p>ここでは，パスワードは半角英数字のみで構成されることとします．つまり，パスワード文字列$str_pwdは，以下の正規表現に一致する必要があります．</p> 
  <p class="command-print">preg_match("/[a-z][A-Z][0-9]/",$str_pwd); 
  </p>
<p>サンプルスクリプトでは，一致すべき正規表現パターンを定数MATCH_PWDとして，インクルードファイルsystem02b.php内に定義して使用することとします．</p> 
 

system02b.php

    <br>
 <pre class="brush:php;">
    &lt;?php
    const COMMON_BBS_FILE = "common_bbs2b.php";
    const MAIN_FILE = "main02b.php";
    const QUERY_FILE = "query02.php";
    const EDIT_FILE = "edit02b.php";
    const MATCH_URL = "/^http(s?)\:\/\/[\w\.\-\/\?\&\+\=\:\@\%\#]+$/";
    <font color="#FF0000">const MATCH_PWD = "/^[a-zA-Z0-9]+$/";</font>
    const SALT = "bbs";
    ?&gt;
</pre>
  </p>
<p>この定数MATCH_PWDを使用して，インクルードファイルcommon_bbs2a.phpの中の受信データチェック用のユーザ定義関数「data_check()」を以下のように改造します．</p> 
  <p class="command-print">// ----------------------------------------------<br>
    // 受信データのチェック<br>
    function data_check(&amp;$str_name,&amp;$str_title,&amp;$str_message,&amp;$str_url<br>
    　　　　　　　　　　　　　<font color="#FF0000">,&amp;$str_pwd</font></h4>)<br>
    {<br>
    /*<br>
    $str_name ：投稿者氏名<br>
    $str_title ：記事タイトル<br>
    $str_message ：記事本文<br>
    $str_url ：関連URL<br>
    $str_pwd ：パスワード<br>
    */<br>
    　global $str_charset;<br>
    　// データの受信<br>
    　$str_name = $_POST['name'];<br>
    　$str_title = $_POST['title'];<br>
    　$str_message = $_POST['message'];<br>
    　$str_url = $_POST['url'];<br>
    <font color="#FF0000">　$str_pwd = $_POST['pwd'];</h4></font><br>
    <br>
    　$str_name = tag_entity_input($str_name,$str_charset);<br>
    　$str_title = tag_entity_input($str_title,$str_charset);<br>
    　$str_message = tag_entity_input($str_message,$str_charset);<br>
    <br>
    　// 文字列の前後の半角スペースを削除し，半角カタカナを全角カタカナに変換<br>
    　$str_name = input_str_convert($str_name);<br>
    　$str_title = input_str_convert($str_title);<br>
    　$str_message = input_str_convert($str_message);<br>
    <font color="#FF0000">　$str_pwd = trim($str_pwd);</h4></font><br>
    <br>
    　 // 文字列が空かいなかのチェック<br>
    　if($str_name == "")<br>
    　{<br>
    　-----（略）-----<br>
    <font color="#FF0000">　elseif($str_pwd != "" &amp;&amp; 
    !preg_match(MATCH_PWD,$str_pwd))<br>
    　{<br>
    　　$str = "パスワードを正しく記入してください";<br>
    　}</h4></font><br>
    　elseif($str_url == "http://")<br>
    　{<br>
    　　$str_url = "";<br>
    　}<br>
    <font color="#FF0000"></h4></font>　return $str;<br>
    }<br>
  </p>
<p>（３）受信パスワードの暗号化と保存</p><p>受信パスワードは，セキュリティ上，暗号化して保存することとします．暗号化は組み込み関数のｃｒｙｐｔ（）関数を使います．</p> 
  <p class="command-print">暗号化パスワード　=　crypt(パスワード,キー文字列)</p>
<p>キー文字列は，省略可能ですが，ここでは「bbs」という文字列を明示的に使うこととします．同じパスワードを同じキー文字列で暗号化すると暗号化されたパスワードも同じになります．ただ，暗号化されたパスワードからパスワードを再現することはほぼ不可能です．なお，キー文字列は定数SALTとして，system02b.phpファイル上で定義しておくこととします．</p> 
  

system02b.php

<pre class="brush:php;">
    &lt;?php
    const COMMON_BBS_FILE = "common_bbs2b.php";
    const MAIN_FILE = "main02b.php";
    const QUERY_FILE = "query02.php";
    const EDIT_FILE = "edit02b.php";
    const MATCH_URL = "/^http(s?)\:\/\/[\w\.\-\/\?\&\+\=\:\@\%\#]+$/";
    const MATCH_PWD = "/^[a-zA-Z0-9]+$/";
  <font color="#FF0000">const SALT = "bbs";</font>
    ?&gt;
</pre>
  </p>
<p>main02a.phpファイルは，パスワードを暗号化し保存するように以下のように改造します．改造後のファイルをmain02b.phpとします．インクルードファイルcomon_bss2a.phpファイルは，上記改造を加えた後common_bbs2b.phpとします．</p> 
  <p class="command-print">main02b.php<br>
    <br>
    　-----（略）----- <br>
    　}<br>
    　// 「送信」の場合<br>
    　elseif(isset($_POST['command'])&&$_POST['command'] == "送信")<br>
    　{<br>
    　　// 受信データが「空」でないかどうかチェック<br>
    　　$str_error_message = data_check($str_name,$str_title,$str_message<br>
    　　　　　　　　　　　　　　　　　　　　　　　,$str_url,<font color="#FF0000">$str_pwd</font></h4>);<br>
    　　-----（略）----- <br>
    　　 // パスワードの暗号化<br>
    　　<font color="#FF0000">$enc_pwd = "";<br>
    　　if($str_pwd != "")<br>
    　　{ <br>
    　　　$enc_pwd = crypt($str_pwd,SALT);<br>
    　　}</font></h4><br>
    　　// データのテーブルへの保存<br>
    　　$str_sql = "insert into tbl_bbs2 "<br>
    　　　　　　　　. "(message_id,name,title,message,date,url<font color="#FF0000">,pwd</font></h4>)"<br>
    　　　　　　　　. "values("<br>
    　　　　　　　　. $new_id. ",'" . $str_name . "','" . $str_title<br>
    　　　　　　　　. "','" . $str_message . "','" . $str_date 
    <br>
    　　　　　　　　. "','" . $str_url . <font color="#FF0000">"','" 
    . $enc_pwd .</font></h4> "');";<br>
    　　-----（略）----- <br>
  </p>
<p>（４）記事の一覧表示に「削除」リンク表示</p><p>記事を一覧表示する画面で，個々の記事に「削除」リンクを表示するようにします．そこで，インクルードファイルcommon_bbs2b.php内のユーザ定義関数message_disp()関数を以下のように改造します．「削除」リンクをクリックしたときは，「EDIT_FILE」ファイルを起動することとします．定数「EDIT_FILE」の値は，後にインクルードファイルsyste02b.php内で定義することとします．</p> 
  <p class="command-print">// -----------------------------------------------<br>
    // 1個の記事本文の表示<br>
    function message_disp(&amp;$arr_message)<br>
    {<br>
    -----（略）-----<br>
    　<font color="#FF0000">$str_url_del = EDIT_FILE . "?id=" 
    . $arr_message['id']<br>
    　　　　　　　　　. "&amp;command=del";</font></h4><br>
    ?&gt;<br>
    &lt;table class="bd_w1 bd_solid bd_b<br>
    　　　　　　　　　padding3 bd_spacing0 bd_collapse w600"&gt;<br>
    -----（略）-----<br>
    &lt;/table&gt;<br>
    <font color="#FF0000">&lt;table class="bd_w0 w600"&gt;<br>
    &lt;tr class="xs"&gt;<br>
    　&lt;td class="ar"&gt;&lt;a href="&lt;?=$str_url_del?&gt;"&gt;削除&lt;/a&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;/table&gt;</font></h4><br>
  </p>
<p>（５）削除確認画面の表示</p><p>個々の記事の「削除」リンクをクリックした後，当該記事を再確認のために再表示し，パスワードを記入し，「削除」ボタンをクリックすれば，削除を実行し，「キャンセル」ボタンをクリックすれば削除しないで，全記事表示に戻るようにします．サンプルリストを以下のedit02b.phpファイルに示します．</p> 
  

edit02b.php
<pre class="brush:php;">
    
    &lt;?php
    include "system02b.php";
    include "common.php";
    const THIS_FILE = EDIT_FILE;
    include COMMON_BBS_FILE;
    $str_charset = "UTF-8";
    // ページサイズ
    $page_size = 5;
    ?&gt;
    &lt;html&gt;
    &lt;head&gt;
    &lt;meta http-equiv="content-type" content="text/html;charset=utf-8" 
    &gt;
    &lt;title&gt;BBS2&lt;/title&gt;
    &lt;meta http-equiv="Content-Style-Type" content="text/css"&gt;
    &lt;link rel="stylesheet" type="text/css" href="common.css"&gt;
    &lt;/head&gt;
    &lt;body class="b_ffff99"&gt;
    &lt;?php
    　// データベースへの接続と選択
    　// データベースサーバへの接続・データベースの選択
     $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
     //クライアント文字コードの通知（文字化け防止）
     $str_sql = "set names utf8;";
     $rs = $mysqli->query($str_sql); 
 
    ?&gt;
    &lt;!-- 「記事入力」，「全記事表示」のハイパーリンクの表示 --&gt;
    &lt;p class="ac"&gt;
    &lt;a href="&lt;?=MAIN_FILE?&gt;"&gt;記事入力&lt;/a&gt;　｜　
    &lt;a href="&lt;?=MAIN_FILE?&gt;?page=all"&gt;全記事表示&lt;/a&gt;&lt;br&gt;&lt;br&gt;
    &lt;/p&gt;
    &lt;?php
    　// 「削除」リンクをクリックした場合
  <font color="#FF0000">　if($_GET['command'] == "del")
    　{
    　　// 記事番号の受信
    　　$message_id = $_GET['id'];
   
    　　if($message_id &gt; 0)
    　　{
    　　　// 当該記事の検索
    　　　$str_sql = "select * from tbl_bbs2"
    　　　　　　　　. " where message_id = {$message_id};";
    　　　$rs = $mysqli->query($str_sql);
    
    　　　if($rs->num_rows === 1)
    　　　{
    　　　　$arr_record = $rs->fetch_assoc();
    
    　　　　// 記事データの配列への格納
    　　　　$arr_message = array();
    　　　　$arr_message['id'] 　　　= $arr_record['message_id'];
    　　　　$arr_message['name'] 　　= $arr_record['name'];
    　　　　$arr_message['title'] 　= $arr_record['title'];
    　　　　$arr_message['message'] = $arr_record['message'];
    　　　　$arr_message['date'] 　　= $arr_record['date'];
    　　　　$arr_message['url'] 　　= $arr_record['url'];
    
    　　　　print "&lt;p class='ac'&gt;";
    　　　　print "パスワードを記入し，「削除」ボタンをクリックしてください&lt;br&gt;\n";
    　　　　// 1個の記事本文の表示
    　　　　message_show($arr_message);
    
    　　　　$message_id = $arr_message['id'];
    　　　　print "&lt;form action='&lt;?=THIS_FILE?&gt;' method='post'&gt;\n";
    　　　　print "パスワード&lt;input type='password' name='pwd'&gt;\n";
    　　　　print "&lt;input type='hidden' name='id' value='{$message_id}'&gt;\n";
    　　　　print "&lt;input type='submit' name='command' value='削除'&gt;\n";
    　　　　print "&lt;input type='submit' name='command' value='キャンセル'&gt;\n";
    　　　　print "&lt;/form&gt;\n";
    　　　　print "&lt;/p&gt;\n";
    　　　　print "&lt;br&gt;\n";
    
    　　　}
    　　　mysqli_free_result($rs);
    　　}
    　}
    　$mysqli->close(); </h4></font><font color="#FF0000">
    </h4></font>?&gt;
</pre>
  </p>
<p>なお，確認のために， 当該記事を表示するユーザ定義関数message_show()をインクルードファイルcommon_bbs02b.php内に作成します．</p> 
  


<pre class="brush:php;">
<p class="code-print">// -----------------------------------------------
    // 1個の記事本文の表示（確認用）
  <font color="#FF0000">function message_show(&amp;$arr_message)</h4></font>
    {
    /*
    $arr_message['id'] ：記事番号
    $arr_message['name'] ：投稿者氏名
    $arr_message['title'] ：記事タイトル
    $arr_message['message'] ：記事本文
    $arr_message['date'] ：投稿日時
    $arr_message['url'] ：関連URL
    */
    　$str_url = $arr_message['url'];
    
    　$str_url_del = EDIT_FILE . "?id=" . $arr_message['id']
    　　　　　　　　. "&amp;command=del";
    ?&gt;
    &lt;table class="bd_w1 bd_solid bd_b
    　　　　　　　padding3 bd_spacing0 bd_collapse w600"&gt;
    &lt;tr class="b_dcdcdc xs"&gt;
    　&lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
    　　　&lt;span class="fbold"&gt;［&lt;?=$arr_message['name']?&gt;］ 
    &lt;/span&gt;
    　　　&lt;span class="696969"&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr class="b_w xs"&gt;
    　&lt;td&gt;&lt;?=$arr_message['message']?&gt;
    &lt;?php
    　if($str_url != "")
    　{
    ?&gt;
    &lt;br&gt;URL:　&lt;a href="&lt;?=$str_url?&gt;"&gt;&lt;?=$str_url?&gt;&lt;/a&gt;&lt;/td&gt;<
    &lt;?php
    　}
    ?&gt;
    &lt;/tr&gt;
    &lt;/table&gt;
    &lt;?php
    }
</pre>
</p>
<p>（６）指定記事の削除の実行</p><p>（５）の削除確認画面で「削除」ボタンをクリックすると，「EDIT_FILE」ファイル（ここではedit02b.phpファイル）が起動され，POSTメソッドで$_POST['command']に「削除」が受信されています．また，同様にPOSTメソッドで記事番号とパスワードも受信されますから，以下のようにSQLのdelete文により指定記事を削除します．</p> 
  <p class="command-print">delete from tbl_bbs2 where message_id = 記事番号 
    and pwd = '暗号化パスワード';</p>
<p>なお，パスワードの暗号化にあたっては，記事を投稿したときと同じ暗号化用キーを使って暗号化します．ここではその暗号化キーは定数SALTに設定されています．パスワード等が間違っていて記事が削除できなかった場合は，「戻る」ボタンをクリックすると，ブラウザのヒストリ（履歴）で一つ前のページに戻るようにします．そのために，以下のjavascriptのメソッドを使います．</p> 
  <p class="command-print">onClick='history.back()'</p>
<p>サンプルリストをedit02b.phpファイルに以下のように追加します．</p> 
  <p class="command-print">edit02b.php<br>
    <br>
    -----(略）-----<br>
    <br>
    　// 「削除」実行の場合<br>
  <font color="#FF0000">　elseif(isset($_POST['command'])&&$_POST['command'] == "削除")<br>
    　{<br>
    　　// データの受信<br>
    　　$message_id = $_POST['id'];<br>
    　　$str_pwd 　 = $_POST['pwd'];<br>
    <br>
    　　$str_pwd　 = trim($str_pwd);<br>
    　　print "&lt;p class='ac'&gt;\n";<br>
    　　if(preg_match(MATCH_PWD,$str_pwd))<br>
    　　{<br>
    　　　// パスワードの暗号化<br>
    　　　$enc_pwd = "";<br>
    　　　if($str_pwd != "")<br>
    　　　{ <br>
    　　　　$enc_pwd = crypt($str_pwd,SALT);<br>
    　　　}　<br>
    　　　// 削除用SQL文<br>
    　　　$str_sql = "delete from tbl_bbs2 "<br>
    　　　　　　　　. "where message_id = {$message_id} and pwd = '{$enc_pwd}';";<br>
    <br>
    　　　$rs = $mysqli->query($str_sql);<br>
    　　　// 削除されたレコード数の取得<br>
    　　　$del_rows = $mysqli->affected_rows;<br>
    <br>
    　　　if($del_rows &gt; 0)<br>
    　　　{<br>
    　　　　print "記事を削除しました．&lt;br&gt;&lt;br&gt;\n";<br>
    　　　}<br>
    　　　else<br>
    　　　{<br>
    　　　　print "記事は削除できませんでした．&lt;br&gt;&lt;br&gt;\n";<br>
    　　　　print "&lt;input type='button' value='戻る' "<br>
    　　　　　　. "onclick='history.back()'&gt;&lt;br&gt;\n";<br>
    　　　}<br>
    　　}<br>
    　　else<br>
    　　{<br>
    　　　print "記事は削除できませんでした．&lt;br&gt;&lt;br&gt;\n";<br>
    　　　print "&lt;input type='button' value='戻る' "<br>
    　　　　　　　　　. "onClick='history.back()'&gt;&lt;br&gt;\n";<br>
    　　}<br>
    　　print "&lt;/p&gt;\n";<br>
    　}<br>
    </h4></font> </h4> </p>
<p>main02b.phpファイルにアクセスし，記事を記入し，「送信」ボタンをクリックします．削除用パスワードも記入します．</p>
 
		<img src="./files/1050203.png" width="600">


<p>記事が表示され，記事の右下に削除用のリンクが表示されます．</p>
 
		<img src="./files/1050204.png" width="600">


<p>削除用リンクをクリックすると，削除確認画面が表示されます．</p>
 
		<img src="./files/1050205.png" width="600">


<p>記事を投稿したときのパスワードを記入し，「削除」ボタンをクリックします．</p>
 
		<img src="./files/1050206.png" width="600">


<p>記事が削除された旨を示す画面が表示されます．「全記事表示」画面に戻ります．</p>
 
		<img src="./files/1050207.png" width="600">


<p>記事が削除されたことが確認されます．</p>

<h4>6.2.4　更新可能なBBS</h4>
<p>投稿した記事を，後で投稿者が更新できるようなBBSを作成します．そのために記事を投稿するときに，パスワードも一緒に登録するようにします．記事を一覧表示した画面で，各記事に「更新」用リンクを表示し，「更新」用リンクをクリックすると，その記事を再表示するとともにパスワード入力欄も表示し，パスワードが入力され「更新」ボタンがクリックされると，当該記事を更新モードで再表示することとします．パスワードが登録されていない（パスワード欄が空）記事は更新できないこととします．また，パスワードは，上記「削除可能なBBS」で使用したものと同じパスワードを使用することとします．更新モードで再表示された記事本文を更新し，「更新」ボタンをクリックすると，再確認のために記事を再表示し，「送信」ボタンがクリックされると登録し，「キャンセル」ボタンがクリックされると，更新モード画面に戻ることとします．</p>
<p>（１）記事の一覧表示に「更新」リンク表示</p><p>記事を一覧表示する画面で，個々の記事に「更新」リンクを表示するようにします．そこで，インクルードファイルcommon_bbs2b.php内のユーザ定義関数message_disp()関数を以下のように改造します．「編集」リンクをクリックしたときは，「EDIT_FILE」ファイルを起動することとします．定数「EDIT_FILE」の値は，後にインクルードファイルsystem02c.php内で定義することとします．</p> 
  <p class="command-print">common_bbs2c.php<br>
    <br>
    // -----------------------------------------------<br>
    // 1個の記事本文の表示<br>
    function message_disp(&amp;$arr_message)<br>
    {<br>
    　-----（略）------ <br>
    　// 「削除」用URL<br>
    　$str_url_del = EDIT_FILE . "?id=" . $arr_message['id']<br>
    　　　　　　　　　. "&amp;command=del";<br>
    　// 「更新」用URL<br>
    　<font color="#FF0000">$str_url_update = EDIT_FILE . "?id=" 
    . $arr_message['id']<br>
    　　　　　　　　　　　　. "&amp;command=update";</font></h4><br>
    ?&gt;<br>
    　-----（略）------ <br>
    &lt;table class="bd_w0 w600"&gt;<br>
    &lt;tr class="xs"&gt;<br>
    &lt;td class="ar"&gt;&lt;a href="&lt;?=$str_url_del?&gt;"&gt;削除&lt;/a&gt;<br>
    　　　　　　　　　　<font color="#FF0000">&lt;a href="&lt;?=$str_url_update?&gt;"&gt;更新&lt;/a&gt;</font></h4>&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;/table&gt;<br>
    &lt;?php<br>
    }<br>
  </p>
<p>（２）更新確認画面の表示</p><p>個々の記事の「更新」リンクをクリックした後，当該記事を再確認のために再表示し，パスワードを記入し，「更新」ボタンをクリックすれば，更新モードで当該記事を再表示し，「戻る」ボタンをクリックすれば，全記事表示に戻るようにします．edit02b.phpファイルを改造したサンプルリストを以下のedit02c.phpに示します．「削除」リンクをクリックした場合の処理とほぼ同じ処理です．</p> 
  <p class="command-print">edit02c.php<br>
    <br>
    &lt;?php<br>
  <font color="#FF0000">include "system02c.php";</h4></font><br>
    include "common.php";<br>
    <br>
    -----（略）------<br>
    <br>
    　// 「更新」リンクをクリックした場合<br>
    　if(<font color="#FF0000">$_GET['command'] == "update"</h4></font>)<br>
    　{<br>
    　　// 記事番号の受信<br>
    　　$message_id = $_GET['id'];<br>
    　　if($message_id &gt; 0)<br>
    　　{<br>
    　　　// 当該記事の検索<br>
    　　　$str_sql = "select * from tbl_bbs2"<br>
    　　　　　　　　　. " where message_id = {$message_id};";<br>
    　　　$rs = $mysqli->query($str_sql);<br>
    　　　if($rs->num_rows === 1)<br>
    　　　{<br>
    　　　　$arr_record = $rs->fetch_assoc();<br>
    <br>
    　　　　// 記事データの配列への格納<br>
    　　　　$arr_message = array();<br>
    　　　　$arr_message['id'] 　　　　　　　= $arr_record['message_id'];<br>
    　　　　$arr_message['name']　　　　　 = $arr_record['name'];<br>
    　　　　$arr_message['title']　　　　　 = $arr_record['title'];<br>
    　　　　$arr_message['message']　　 = $arr_record['message'];<br>
    　　　　$arr_message['date']　　　　　 = $arr_record['date'];<br>
    　　　　$arr_message['url']　　　　 　　= $arr_record['url'];<br>
    <br>
    　　　　print "&lt;p class='ac'&gt;";<br>
    　　　　<font color="#FF0000">print "パスワードを記入し，「更新」ボタンをクリックしてください&lt;br&gt;\n";</font></h4><br>
    　　　　// 1個の記事本文の表示<br>
    　　　　message_show($arr_message);<br>
    　　　　$message_id = $arr_message['id'];<br>
    　　　　print "&lt;form action='" . THIS_FILE . "' method='post'&gt;\n";<br>
    　　　　print "パスワード&lt;input type='password' name='pwd'&gt;\n";<br>
    　　　　print "&lt;input type='hidden' name='id' value='{$message_id}'&gt;\n";<br>
    　　　<font color="#FF0000">　print "&lt;input type='submit' name='command' 
    value='更新'&gt;\n";</font></h4><br>
    　　　　print "&lt;input type='button' value=戻る' "<br>
    　　　　　　　　　　　　　　　. "onClick='history.back()'&gt;\n";<br>
    　　　　print "&lt;/form&gt;\n";<br>
    　　　　print "&lt;/p&gt;\n";<br>
    　　　　print "&lt;br&gt;\n";<br>
    　　　}<br>
    　　　mysqli_free_result($rs);<br>
    　}<br>
    }</p>
<p>（３）更新モードでの記事画面の表示</p><p>更新確認画面でパスワードが記入され，「更新」ボタンがクリックされると，，「EDIT_FILE」ファイル（ここではedit02c.phpファイル）が起動され，POSTメソッドで$_POST['command']に「更新」が受信されています．また，同様にPOSTメソッドで記事番号とパスワードも受信されますから，以下のようにSQLのselect文により指定記事を検索します．</p> 
  <p class="command-print">select * from tbl_bbs2 where message_id = 記事番号 
    and pwd = '暗号化パスワード'</p>

<p>1個の記事が検索されれば，パスワードも正しかったということで，当該記事の更新画面を表示します．当該記事の更新画面の表示のために，組み込み関数update_form_disp()を新たに定義します．update_form_disp()関数は，既存のinput_form_disp()を若干改造したものになります．update_form_disp()関数はインクルードファイルcommon_bbs2b.phpに追加することとし，ファイル名を新たにcommon_bbs2c.phpとします．</p> 
  <p class="command-print">edit02c.php<br>
    <br>
    &lt;?php<br>
    <font color="#000000">include "system02c.php";</font><br>
    include "common.php";<br>
    <br>
    -----（略）------<br>
    <br>
    　// 「更新」実行の場合<br>
    　<font color="#FF0000">elseif($_POST['command'] == "更新")</font></h4><br>
    　{<br>
    　　// データの受信<br>
    　　$message_id = $_POST['id'];<br>
    　　$str_pwd = $_POST['pwd'];<br>
    <br>
    　　$str_pwd = trim($str_pwd);<br>
    　　if(preg_match(MATCH_PWD,$str_pwd))<br>
    　　{<br>
    　　　// パスワードの暗号化<br>
    　　　$enc_pwd = "";<br>
    　　　if($str_pwd != "")<br>
    　　　{ <br>
    　　　　$enc_pwd = crypt($str_pwd,SALT);<br>
    　　　　// 更新用SQL文<br>
    　　　　<font color="#FF0000">$str_sql = "select * from tbl_bbs2 
    "<br>
    　　　　　　　　　　. "where message_id = {$message_id} and pwd = '{$enc_pwd}';";<br>
    　　　　$rs = $mysqli->query($str_sql);</font></h4><br>
    　　　　// 検索されたレコード数の取得<br>
    　　　　<font color="#FF0000">$select_rows = mysql_num_rows($db); <br>
    　　　 if($select_rows &gt; 0)</font></h4><br>
    　　　　{<br>
    　　　　　// 検索結果リソースの連想配列への格納<br>
    　　　　　$arr_record = $rs->fetch_assoc();<br>
    　　　　　// 記事データの変数への格納<br>
    　　　　　$str_name　　 = $arr_record['name'];<br>
    　　　　　$str_title 　　　= $arr_record['title'];<br>
    　　　　　$str_message = $arr_record['message'];<br>
    　　　　　$str_date　　　 = $arr_record['date'];<br>
    　　　　　$str_url 　　　　= $arr_record['url'];<br>
    　　　　　$str_update 　　= $arr_record['date_update'];<br>
    　　　　　// 記事更新画面の表示<br>
    　　　　　<font color="#FF0000">update_form_disp($message_id,$str_name,$str_title,$str_message<br>
    　　　　　　　　　　　　　　　　,$str_date,$str_update,$str_url,$str_pwd);</font></h4><br>
    　　　　}<br>
    　　　　else<br>
    　　　　{<br>
    　　　　　print "記事は更新できません．&lt;br&gt;&lt;br&gt;\n";<br>
    　　　　　print "&lt;input type='button' value='戻る' "<br>
    　　　　　　　　　　　. "onclick='history.back()'&gt;&lt;br&gt;\n";<br>
    　　　　}<br>
    　　　　print "記事は更新できません．&lt;br&gt;&lt;br&gt;\n";<br>
    　　　　print "&lt;input type='button' value='戻る' "<br>
    　　　　　　　　　　　. "onclick='history.back()'&gt;&lt;br&gt;\n";<br>
    　　　}<br>
    　　}<br>
    　　else<br>
    　　{<br>
    　　　print "記事は更新できません．&lt;br&gt;&lt;br&gt;\n";<br>
    　　　print "&lt;input type='button' value='戻る' "<br>
    　　　　　　　　　　. "onClick='history.back()'&gt;&lt;br&gt;\n";<br>
    　　}<br>
    　}<br>
  </p>
  <p class="command-print">common_bbs2c.php<br>
    <br>
    // ----------------------------------------------<br>
    // 更新モードでの記事の表示<br>
    <font color="#FF0000">function update_form_disp($message_id,$str_name,$str_title,$str_message<br>
    　　　　　　　　　　　　　　　　　,$str_date,$str_update,$str_url,$str_pwd)<br>
    {</h4></font><br>
    /*<br>
    $str_name ：投稿者氏名<br>
    $str_title ：記事タイトル<br>
    $str_message ：記事本文<br>
    $str_url ：関連URL<br>
    $str_pwd ：パスワード<br>
    */<br>
    　// 改行タグの改行コードへの変換<br>
    　$str_message = tag_entity_form($str_message);<br>
    <br>
    　// URL欄の初期値設定<br>
    　if($str_url == "")<br>
    　{<br>
    　　$str_url = "http://";<br>
    　}<br>
    ?&gt;<br>
    &lt;table border="0"&gt;<br>
    &lt;form method="post" action='&lt;?=EDIT_FILE?&gt;'&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;記事番号&lt;/td&gt;&lt;td&gt;&lt;?=$message_id?&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="30"<br>
    　　　　　　　　　　　　　　　　　value="&lt;?=$str_name?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" 
    size="60"<br>
    　　　　　　　　　　　　　　　　　　　value="&lt;?=$str_title?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;記事&lt;/td&gt;<br>
    　&lt;td&gt;&lt;textarea name="message" <br>
    　　　　　　　　　　rows="5" cols="60"&gt;&lt;?=$str_message?&gt;&lt;/textarea&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;URL&lt;/td&gt;&lt;td&gt;&lt;input name="url" size="60"<br>
    　　　　　　　　　　　　　　　　　value="&lt;?=$str_url?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;パスワード&lt;/td&gt;<br>
    　&lt;td&gt;&lt;input type="password" name="pwd" 
    size="8"<br>
    　　　　　　　　class="hankaku" value="&lt;?=$str_pwd?&gt;"&gt;(半角英数字)&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;投稿日&lt;/td&gt;&lt;td&gt;&lt;?=$str_date?&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td class='xs'&gt;前回更新日&lt;/td&gt;&lt;td&gt;&lt;?=$str_update?&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt; &lt;/td&gt;<br>
    　&lt;td&gt;&lt;input type="submit" name="command" 
    value="送信"&gt;<br>
    　　　　&lt;input type="submit" name="command" value="キャンセル"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    　&lt;input type="hidden" name="id" value="&lt;?=$message_id?&gt;"&gt;<br>
    　&lt;input type="hidden" name="date" value="&lt;?=$str_date?&gt;"&gt;<br>
    　&lt;input type="hidden" name="update" value="&lt;?=$str_update?&gt;"&gt;<br>
    &lt;/form&gt;<br>
    &lt;/table&gt;<br>
    &lt;?php<br>
    }<br>
  </p>

<p>（４）更新結果の確認画面の表示</p>
<p>記事更新画面で，「送信」ボタンがクリックされると，EDIT_FILEファイル（ここではedit02c.phpファイル）が起動され，POSTメソッドで$_POST['command']に「送信」が受信されます．受信データを新規の記事投稿の場合と同様ユーザ定義関数data_check()関数でチェックします．受信データが正しければ，確認のために更新後の記事を表示します．記事を確認後，正しければ「OK」ボタンをクリックし，正しくなければ「戻る」ボタンでブラウザの前のページに戻るようにします．サンプルリストを以下に示します．以下のリストはedit02c.phpファイルに追加します．</p> 
  <p class="command-print">edit02c.php<br>
    <br>
    -----(略)-----<br>
    <br>
    　// 「送信」の場合<br>
    　elseif(<font color="#FF0000">$_POST['command'] == "送信"</h4></font>)<br>
    　{<br>
    　　// 受信データのチェック<br>
    　　$str_error_message = data_check($str_name,$str_title,$str_message<br>
    　　　　　　　　　　　　　　　　　　　　　　　,$str_url,$str_pwd);<br>
    　　if($str_error_message == "")<br>
    　　{<br>
    　　　// 記事データの配列への格納<br>
    　　　$message_id 　= $_POST['id'];<br>
    　　　$str_date 　　= $_POST['date'];<br>
    　　　$str_update 　= $_POST['update'];<br>
    <br>
    　　　$arr_message = array();<br>
    　　　$arr_message['id']　　　　　 = $message_id;<br>
    　　　$arr_message['name'] 　　　= $str_name;<br>
    　　　$arr_message['title']　　　 = $str_title;<br>
    　　　$arr_message['message'] = $str_message;<br>
    　　　$arr_message['date']　　　 = $str_date;<br>
    　　　$arr_message['url'] 　　　　= $str_url;<br>
    <br>
    　　　print "内容を確認し，「OK」ボタンをクリックしてください&lt;br&gt;\n";<br>
    　　　// 1個の記事本文の表示<br>
    　　　message_show($arr_message);<br>
    <br>
    　　　// 改行タグの改行コードへの変換<br>
    　　　<font color="#FF0000">$str_message = tag_entity_form($str_message);<br>
    　　　if($str_url == "")<br>
    　　　{<br>
    　　　　$str_url = "http://";<br>
    　　　}</font></h4><br>
    　　　print "&lt;form action='" . THIS_FILE . "' method='post'&gt;\n";<br>
    　　　print "&lt;input type='hidden' name='id' value='{$message_id}'&gt;\n";<br>
    　　　print "&lt;input type='hidden' name='name' value='{$str_name}'&gt;\n";<br>
    　　　print "&lt;input type='hidden' name='title' value='{$str_title}'&gt;\n";<br>
    　　　print "&lt;input type='hidden' name='message' value='{$str_message}'&gt;\n";<br>
    　　　print "&lt;input type='hidden' name='url' value='{$str_url}'&gt;\n";<br>
    　　　print "&lt;input type='hidden' name='pwd' value='{$str_pwd}'&gt;\n";<br>
    　　　print "&lt;input type='submit' name='command' value='OK'&gt;\n";<br>
    　　　print "&lt;input type='button' value='戻る' "<br>
    　　　　　　　　　　　. "onClick='history.back()'&gt;\n";<br>
    　　　print "&lt;/form&gt;\n";<br>
    　　　print "&lt;br&gt;\n";<br>
    　}<br>
    }<br>
  </p>

<p>（５）更新記事の保存</p>
<p>更新結果の確認画面で，「OK」ボタンをクリックするとEDIT_FILEファイル（ここではedit02c.phpファイル）が起動され，POSTメソッドで$_POST['command']に「OK」が受信されます．ユーザ定義関数data_check()で，再度受信データをチェックし，正常であれば記事番号も受信し，更新日を設定します．パスワードが設定されていれば，以下のようにSQLのupdate文で記事データの更新を行います．</p> 
  <p class="command-print">update tbl_bbs2 set フィールド名1 = 値1,<br>
    　　　　　　　　　　　　　 フィールド名2 = 値2,<br>
    　　　　　　　　　　　　　----------------<br>
    　　　　　　　　　　where message_id = 記事番号;</p>
<p>サンプルリストを以下に示します．以下のリストは，edit02c.phpに追加します．</p> 
  <p class="command-print">edit02c.php<br>
    <br>
    -----（略）-----<br>
    <br>
    　// 「OK」の場合<br>
    　elseif(<font color="#FF0000">$_POST['command'] == "OK"</h4></font>)<br>
    　{<br>
    　　// 受信データのチェック<br>
    　　$str_error_message = data_check($str_name,$str_title,$str_message<br>
    　　　　　　　　　　　　　　　　　　　　　　　,$str_url,$str_pwd);<br>
    　　if($str_error_message == "")<br>
    　　{<br>
    　　　// データの受信<br>
    　　　$message_id = $_POST['id'];<br>
    　　　// 現在日時の取得<br>
    　　　<font color="#FF0000">$str_update = date("Y-m-d H:i:s",time());</font></h4><br>
    <br>
    　　　$str_name 　　= $mysqli->real_escape_string($str_name);<br>
    　　　$str_title 　　　= $mysqli->real_escape_string($str_title);<br>
    　　　$str_message = $mysqli->real_escape_string($str_message);<br>
    <br>
    　　　 if($str_pwd !="")<br>
    　　　{<br>
    　　　　// パスワードの暗号化<br>
    　　　　$enc_pwd = crypt($str_pwd,SALT);<br>
    　　　　// データのテーブルへの保存<br>
    　　　　<font color="#FF0000">$str_sql = "update tbl_bbs2 "<br>
    　　　　　　　　　　. "set name = '" . $str_name . "',"<br>
    　　　　　　　　　　. " title = '" . $str_title . "',"<br>
    　　　　　　　　　　. " message = '" . $str_message . "',"<br>
    　　　　　　　　　　. "date_update = '" . $str_update . "',"<br>
    　　　　　　　　　　. " url = '" . $str_url . "',"<br>
    　　　　　　　　　　. " pwd = '" . $enc_pwd . "'"<br>
    　　　　　　　　　　. " where message_id = " . $message_id . ";";</font></h4><br>
    <br>
    　　　 if(!mysql_query($str_sql,$db))<br>
    　　　{<br>
    　　　　print "&lt;br&gt;ERROR_NO=" . mysql_errno($db) . ":"<br>
    　　　　　　　　　　　　　　　　　　　　　. mysql_error($db) . "&lt;br&gt;}";<br>
    　　　}<br>
    　　}<br>
    　　// テーブルのデータの一覧取得（最後に「;」をつけない）<br>
    　　$str_sql = "select * from tbl_bbs2 order by message_id desc";<br>
    <br>
    　　 // 第１ページ目の設定<br>
    　　$page = 1;<br>
    <br>
    　　 // ページ単位表示<br>
    　　page_disp($str_sql,$page,$page_size,$mysqli);<br>
    <br>
    　　 $mysqli->close();<br>
    　}<br>
    　else<br>
    　{<br>
    　　print "&lt;font style='color:red'&gt;{$str_error_message}&lt;/font&gt;&lt;br&gt;\n";<br>
    　　// 更新画面の再表示<br>
    　　update_form_disp($message_id,$str_name,$str_title,$str_message<br>
    　　　　　　　　　　　　　,$str_date,$str_update,$str_url,$str_pwd);<br>
    　}<br>
    }<br>
  </p>
  
<p>main02c.phpにアクセスします．個々の記事には，「更新」リンクが表示されています．２番目の記事の「更新」リンクをクリックします．</p>
 
		<img src="./files/1050208.png" width="600">


<p>更新確認画面が表示されます．記事投稿時に入力したパスワードを記入し，「更新」ボタンをクリックします．</p>
 
		<img src="./files/1050209.png" width="600">


<p>更新モードで記事が表示されます．必要な更新あるいは修正等を行います．ここでは，赤線で囲った部分を修正しています．</p><p>パスワードは前のままでも，新たに入力しなおしてもいずれでもかまいません．「送信」ボタンをクリックします．</p>
 
		<img src="./files/1050210.png" width="600">


<p>更新結果の確認画面が表示されます．よければ「OK」ボタンをクリックします．</p>
 
		<img src="./files/1050211.png" width="600">


<p>正式に保存された結果が一覧表示されます．</p>
 
		<img src="./files/1050212.png" width="600">


<h4>6.2.5　引用可能なBBS</h4>
<p>ある記事に対して，引用して返信できるBBSを制作します．記事を一覧表示した画面で，各記事に「返信」用リンクを表示し，「品進」用リンクをクリックすると，その記事を引用した形で記事入力画面を表示します．返信用記事のタイトルの冒頭に「Re[ｎ]：」を付加することとします．ｎは最初は１で，Re[1]：への返信はRe[2]：としていきます．記事本文の引用部分は，各行の冒頭に「&gt; 
  」を挿入することとします．</p>
<p>（１）記事の一覧表示に「返信」リンク表示</p><p>記事を一覧表示する画面で，個々の記事に「返信」リンクを表示するようにします．そこで，インクルードファイルcommon_bbs2c.php内のユーザ定義関数message_disp()関数を以下のように改造します．「返信」リンクをクリックしたときは，「RESPONSE_FILE」ファイルを起動することとします．定数「RESPONSE_FILE」の値は，後にインクルードファイルsystem02d.php内で定義することとします．</p> 
  <p class="command-print">common_bbs2d.php<br>
    <br>
    -----（略）----- <br>
    <br>
    // -----------------------------------------------<br>
    // 1個の記事本文の表示<br>
    function message_disp(&amp;$arr_message)<br>
    {<br>
    -----（略）----- <br>
    　// 「更新」用URL<br>
    　$str_url_update = EDIT_FILE . "?id=" . $arr_message['id']<br>
    　　　　　　　　　　　　　　　　　　　. "&amp;command=update";<br>
    　// 「返信」用URL<br>
    <font color="#FF0000">　$str_url_response = RESPONSE_FILE . "?id=" 
    . $arr_message['id']<br>
    　　　　　　　　　　　　　　　　　　　　　　　　　. "&amp;command=response";</h4></font><br>
    ?&gt;<br>
    &lt;table class="bd_w1 bd_solid bd_b<br>
    　　　　　　　　　padding3 bd_spacing0 bd_collapse w600"&gt;<br>
    &lt;tr class="b_dcdcdc xs"&gt;<br>
    　&lt;td&gt;No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;<br>
    　　　　　&lt;span class="fbold"&gt;［&lt;?=$arr_message['name']?&gt;］ 
    &lt;/span&gt;<br>
    　　　　　&lt;span class="696969"&gt;&lt;?=$arr_message['date']?&gt;&lt;/span&gt;&lt;/td&gt;<br>
    <font color="#FF0000">　&lt;td class='ar'&gt;&lt;a href="&lt;?=$str_url_response?&gt;"&gt;返信&lt;/a&gt;&lt;/td&gt;</h4></font><br>
    &lt;/tr&gt;<br>
    &lt;tr class="b_w xs"&gt;<br>
    &lt;td <font color="#FF0000">colspan=2</h4></font>&gt;&lt;?=$arr_message['message']?&gt;<br>
    &lt;?php<br>
    -----（略）----- <br>
    }</p>
  
<p>（２）返信用記事入力フォームの表示</p><p>「返信」用リンクがクリックされると，，「RESPONSE_FILE」ファイル（ここではresponse02d.phpファイル）が起動され，POSTメソッドで$_POST['command']に「response」が受信されています．また，同様にPOSTメソッドで記事番号も受信されますから，以下のようにSQLのselect文により指定記事を検索します．</p> 
  <p class="command-print">select * from tbl_bbs2 where message_id = 記事番号'</p>

<p>当該記事の返信画面の表示のために，ユーザ定義関数response_form_disp()を新たに定義し，上記インクルードファイルcommon_bbs2c.phpに追加しcommon_bbs2d.phpとします．「返信」用リンクがクリックされた場合の状態を，返信用記事入力前ということで，「$status="before"」とします．後に，返信用記事入力後に「送信」ボタンをクリックした場合の状態は，「$status="before"」とします．response02d.phpで，「返信」用リンクがクリックされた場合のサンプルリストを以下に示します．</p> 
  <p class="command-print">response02d.php<br>
    <br>
    &lt;?php<br>
    include "system02d.php";<br>
    include "common.php";<br>
    define(THIS_FILE,RESPONSE_FILE);<br>
    include COMMON_BBS_FILE;<br>
    <br>
    -----（略）-----<br>
    <br>
    　// 「返信」リンクをクリックした場合<br>
    　if(<font color="#FF0000">$_GET['command'] == "response"</font></h4>)<br>
    　{<br>
    　　<font color="#FF0000">$status = "before";</font></h4><br>
    <br>
    　　// データの受信<br>
    　　$parent_id = $_GET['id'];<br>
    　　// 検索用SQL文<br>
    　　$str_sql = "select * from tbl_bbs2 "<br>
    　　　　　　　　. "where message_id = {$parent_id} ;";<br>
    　　$rs = $mysqli->query($str_sql);<br>
    　　// 検索されたレコード数の取得<br>
    　　$select_rows = $rs->num_rows;<br>
    　　if($select_rows &gt; 0)<br>
    　　{<br>
    　　　// 検索結果リソースの連想配列への格納<br>
    　　　$arr_record = $rs->fetch_assoc();<br>
    <br>
    　　　// 記事データの変数への格納<br>
    　　　$str_title = $arr_record['title'];<br>
    　　　$str_message = $arr_record['message'];<br>
    <br>
    　　　// 記事返信画面の表示<br>
    　　　<font color="#FF0000">response_form_disp($status,$parent_id,$str_name,$str_title<br>
    　　　　　　　　　　　　　　　　　　　　,$str_message,$str_url,$str_pwd);</font></h4><br>
    　　}<br>
    　　else<br>
    　　{<br>
    　　　print "記事番号が間違っています．&lt;br&gt;&lt;br&gt;\n";<br>
    　　　print "&lt;input type='button' value='戻る' "<br>
    　　　　　　　　　　　. "onClick='history.back()'&gt;&lt;br&gt;\n";<br>
    　　}<br>
    　}<br>
  </p>
<p>「$status="before"」の場合は，①タイトルの冒頭に返信のレベルを示す文字列「Re[n]:」を挿入・置換します．この文字列を返信レベルカウンターと呼びます．「n」は返信レベルで，１，２，３と増加させます．この返信レベルカウンターを挿入・置換するためにユーザ定義関数re_counter()関数を作成し，使用します．また，②記事本文の行頭に引用記号「&gt; 
  」を挿入します．<br>
</p> 
  <p class="command-print">common_bbs2d.php<br>
    <br>
    // ----------------------------------------------<br>
    // 返信フォームの表示<br>
    function <font color="#FF0000">response_form_disp($status,$parent_id,$str_name,$str_title<br>
    　　　　　　　　　　　　　　　　　　　　　　　,$str_message,$str_url,$str_pwd)</font></h4><br>
    {<br>
    /*<br>
    $parent_id ：親記事番号<br>
    $str_name ：投稿者氏名<br>
    $str_title ：記事タイトル<br>
    $str_message ：記事本文<br>
    $str_url ：関連URL<br>
    $str_pwd ：パスワード<br>
    */<br>
    　// 改行タグの改行コードへの変換<br>
    　$str_message = tag_entity_form($str_message);<br>
    <br>
    　if($status == "before")<br>
    　{<br>
    　　// タイトルの冒頭に「Re[n]:」を付加する<br>
    　　$str_title = <font color="#FF0000">re_counter($str_title);</font></h4><br>
    <br>
    　　// 記事本文の行頭に引用記号「&gt; 」を挿入する<br>
    　　<font color="#FF0000">$arr_message = array();<br>
    　　$arr_message = explode("\n",$str_message);<br>
    　　$arr_message_new = array();<br>
    　　foreach($arr_message as $str_line)<br>
    　　{<br>
    　　　$str_line = "&amp;gt; " . $str_line;<br>
    　　　array_push($arr_message_new,$str_line);<br>
    　　}<br>
    　　$str_message = implode("\n",$arr_message_new);</font></h4><br>
    　}<br>
    <br>
    　// URL欄の初期値設定<br>
    　if($str_url == "")<br>
    　{<br>
    　　$str_url = "http://";<br>
    　}<br>
    ?&gt;<br>
    &lt;table border="0"&gt;<br>
    &lt;form method="post" action='&lt;?=RESPONSE_FILE?&gt;'&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt; &lt;/td&gt;&lt;td&gt;BBS1&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;氏名&lt;/td&gt;&lt;td&gt;&lt;input name="name" size="30"<br>
    　　　　　　　　　　　　　　　　　value="&lt;?=$str_name?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;タイトル&lt;/td&gt;&lt;td&gt;&lt;input name="title" 
    size="60"<br>
    　　　　　　　　　　　　　　　　　　　value="&lt;?=$str_title?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;記事&lt;/td&gt;<br>
    　&lt;td&gt;&lt;textarea name="message" <br>
    　　　　　　　　　　rows="5" cols="60"&gt;&lt;?=$str_message?&gt;&lt;/textarea&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;URL&lt;/td&gt;&lt;td&gt;&lt;input name="url" size="60"<br>
    　　　　　　　　　　　　　　　　　value="&lt;?=$str_url?&gt;"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt;パスワード&lt;/td&gt;<br>
    　&lt;td&gt;&lt;input type="password" name="pwd" 
    size="8"<br>
    　　　　　　　　class="hankaku" value="&lt;?=$str_pwd?&gt;"&gt;(半角英数字)&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;tr&gt;<br>
    　&lt;td&gt; &lt;/td&gt;&lt;td&gt;&lt;input type=submit name="command" 
    value="送信"&gt;&lt;/td&gt;<br>
    &lt;/tr&gt;<br>
    &lt;input type="hidden" name="parent_id" value="&lt;?=$parent_id?&gt;"&gt;<br>
    &lt;/form&gt;<br>
    &lt;/table&gt;<br>
    &lt;?php<br>
    }<br>
    <br>
    -----（略）-----<br>
    <br>
    // ----------------------------------------------<br>
    // タイトルの冒頭に返信レベルカウンター「Re[n]:」を付加する<br>
    function<font color="#FF0000"> re_counter($str)</font></h4><br>
    {<br>
    　// 返信レベルカウンター用文字列の設定<br>
    　$str_re1 = "Re[";<br>
    　$str_re2 = "]:";<br>
    　// 返信レベルカウンターのパターンマッチ<br>
    　if(<font color="#FF0000">preg_match(MATCH_RE,$str,$arr)</font></h4>)<br>
    　{<br>
    　　// 返信レベルカウンターのレベル値を１だけ増分<br>
    　　<font color="#FF0000">$str_re_next = $str_re1 . ($arr[2] + 1) . 
    $str_re2;</font></h4><br>
    　　// 返信レベルカウンターの置換<br>
    　　<font color="#FF0000">$str = preg_replace(MATCH_RE,$str_re_next,$str);</font></h4><br>
    　}<br>
    　else<br>
    　// 返信レベルカウンターの文字列がない場合（最初の返信）<br>
    　{<br>
    　　<font color="#FF0000">$str = $str_re1 . "1" . $str_re2 
    . $str;</font></h4><br>
    　}<br>
    return $str;<br>
    }<br>
  </p>
<p>ユーザ定義関数re_counter()では，preg_match()関数で 返信レベルカウンターのパターンマッチを行います．パタンーンマッチ用の正規表現は「"/^(Re\[(\d+)\]:)/"」で，この文字列はsystem02d.php内で，定数「MATCH_RE」として定義しておきます．</p> 
  <p class="command-print">preg_match("/^(Re\[(\d+)\]:)/",元の文字列,配列)</p>
<p>preg_match()関数では，「( )」内のサブパターンに一致した文字列は，順次第３の引数の配列（ここでは$arr）に格納されます．サブパターン「Re[n]:」に一致した文字列は$arr[1]に格納され，サブパターン「n」に一致した数値は$arr[2]に格納されます．ここで，「n」は返信レベルを示す１桁以上の整数値です．「ｎ」を「n+1」に１個増分し，再度返信レベルカウンター「Re[n+1]:」の文字列を作成し，preg_replace()関数で置換します．</p> 
  <p class="command-print">preg_replace("/^(Re\[(\d+)\]:)/",置換文字列,元の文字列)</p>

<p>（３）返信用記事の保存</p>
<p>返信記事記入画面で，「送信」ボタンがクリックされると，RESPONSE_FILEファイル（ここではresponse02d.phpファイル）が起動され，POSTメソッドで$_POST['command']に「送信」が受信されます．状態は，「$status 
  = "after"」とします．また，親記事番号を受信します．受信データを新規の記事投稿の場合と同様ユーザ定義関数data_check()関数でチェックします．入力データが正しければ，新規記事入力の場合と同様SQLのinsert文で，記事データをデータベースに保存します．なお，ここでは，親記事番号も保存します．入力データが正しくなければ，返信記事入力画面をresponse_form_disp()関数で，再表示します．</p> 
  <p class="command-print">response02d.php<br>
    <br>
    -----(略) -----<br>
    <br>
    　// 「送信」の場合<br>
    　elseif(isset($_POST['command'])&&$_POST['command'] == "送信")<br>
    　{<br>
    　　<font color="#FF0000">$status = "after";</font></h4><br>
    　　// 親記事番号の受信<br>
    　<font color="#FF0000">　$parent_id = $_POST['parent_id'];</h4></font><br>
    <br>
    　　// 受信データのチェック<br>
    　　$str_error_message = <font color="#FF0000">data_check($str_name,$str_title,$str_message<br>
    　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　,$str_url,$str_pwd);</font></h4><br>
    　　if($str_error_message == "")<br>
    　　{<br>
    　　　// 現在日時の取得<br>
    　　　$str_date = date("Y-m-d H:i:s",time());<br>
    　　　// 「message_id」の生成<br>
    　　　// tbl_bbs2テーブルのmessage_idの最大値の取得<br>
    　　　$str_sql = "select max(message_id) as max_id from tbl_bbs2;";<br>
    　　　$rs = $mysqli->query($str_sql);<br>
    　　　$arr_record = array();<br>
    　　　$arr_record = $rs->fetch_assoc();<br>
    　　　$max_id = $arr_record['max_id'];<br>
    　　　if($max_id &gt; 0)<br>
    　　　{<br>
    　　　　$new_id = $max_id + 1;<br>
    　　　}<br>
    　　　else<br>
    　　　{<br>
    　　　　$new_id = 1;<br>
    　　　}<br>
    　　　// SQL文のためのエスケープ処理<br>
    　　　$str_name 　　= $mysqli->real_escape_string($str_name);<br>
    　　　$str_title 　　　= $mysqli->real_escape_string($str_title);<br>
    　　　$str_message = $mysqli->real_escape_string($str_message);<br>
    <br>
    　　　// パスワードの暗号化<br>
    　　　disp_var(2,$str_pwd,'$str_pwd');<br>
    　　　$enc_pwd = "";<br>
    　　　if($str_pwd != "")<br>
    　　　{<br>
    　　　　$enc_pwd = crypt($str_pwd,SALT);<br>
    　　　}<br>
    <br>
    　　　// データのテーブルへの保存<br>
    　　　<font color="#FF0000">$str_sql = "insert into tbl_bbs2 "<br>
    　　　　　　　　　　　　　　. "(message_id,name,title,message,date,url,pwd,parent_id)"<br>
    　　　　　　　　　　　　　　. "values("<br>
    　　　　　　　　　　　　　　. $new_id. ",'" . $str_name . "','" 
    . $str_title<br>
    　　　　　　　　　　　　　　. "','" . $str_message . "','" . $str_date 
    <br>
    　　　　　　　　　　　　　　. "','" . $str_url . "','" . $enc_pwd 
    <br>
    　　　　　　　　　　　　　　. "'," . $parent_id . ");";<br>
    　　　if(!mysql_query($str_sql,$db))</font></h4><br>
    　　　{<br>
    　　　　print "&lt;br&gt;ERROR_NO=" . mysql_errno($db) . ":"<br>
    　　　　　　　　　　　　　　　　　　　　. mysql_error($db) . "&lt;br&gt;}";<br>
    　　　}<br>
    <br>
    　　　// データのリセット<br>
    　　　$new_id = "";<br>
    　　　$str_name = "";<br>
    　　　$str_title = "";<br>
    　　　$str_message = "";<br>
    　　　$str_date = "";<br>
    　　　$str_url = "";<br>
    　　　$str_pwd = "";<br>
    <br>
    　　　// テーブルのデータの一覧取得（最後に「;」をつけない）<br>
    　　　$str_sql = "select * from tbl_bbs2 order by message_id desc";<br>
    <br>
    　　　// 第１ページ目の設定<br>
    　　　$page = 1;<br>
    <br>
    　　　// ページ単位表示<br>
    　　　page_disp($str_sql,$page,$page_size,$mysqli);<br>
    　　}<br>
    　　else<br>
    　　{<br>
    　　　print "&lt;span class='red'&gt;{$str_error_message}&lt;/span&gt;&lt;br&gt;\n";<br>
    　　　// 記事返信画面の表示<br>
    　　　<font color="#FF0000">response_form_disp($status,$parent_id,$str_name,$str_title<br>
    　　　　　　　　　　　　　　　　　　　　　,$str_message,$str_url,$str_pwd);</font></h4><br>
    　　}<br>
    　}</p>
 


system02d.php
     <pre class="brush:php;">
    &lt;?php
    const COMMON_BBS_FILE = "common_bbs2d.php";
    const MAIN_FILE = "main02d.php";
    const QUERY_FILE = "query03.php";
    const EDIT_FILE = "edit02c.php";
    const RESPONSE_FILE = "response02d.php";
    const MATCH_URL = "/^http(s?)\:\/\/[\w\.\-\/\?\&\+\=\:\@\%\#]+$/";
    const MATCH_PWD = "/^[a-zA-Z0-9]+$/";
    <font color="#FF0000">const MATCH_RE =  "/^(Re\[(\d+)\]:)/";</h4></font>
    const SALT = "bbs";
    ?&gt;</p>
</pre>
<p>main02d.phpファイルにアクセスし，返信したい記事の「返信」リンクをクリックします．</p>
 
		<img src="./files/1050213.png" width="600">


<p>タイトルの冒頭に，「Re[1]:」が挿入され，引用文の各行頭には「&gt; 」が挿入されて表示されます．返信記事を入力し，「送信」ボタンをクリックします．</p>
 
		<img src="./files/1050214.png" width="600">


<p>返信記事が投稿されます．</p>

		<img src="./files/1050215.png" width="600"> 


<h4>6.2.6　メールで返信可能なBBS</h4>
<p>投稿された記事に対して，メールでも返信可能なBBSを作成します．メールでも返信するかいなかは，ラジオボタンで選択可能とします．</p><p>（１）記事入力画面にメールアドレス記入欄を設けます．</p><p>common_bbs2d.phpファイル内のinput_form_disp()関数をメールアドレス入力欄を表示するように以下のように改造します．改造後のファイル名をcommon_bbs2e.phpとします．</p> 
 


common_bbs2e.php
     <pre class="brush:php;">
&lt;?php
// ユーザ定義関数

// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_mail_address,&$str_title,&$str_message
,&$str_url,&$str_pwd)
{
/*
$str_name ：投稿者氏名
$str_mail_address :メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
*/
global $str_charset;
 disp_var(1,$str_charset,'$str_charset');
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];
 $str_url = $_POST['url'];
 $str_pwd = $_POST['pwd'];
 $str_mail_address = $_POST['mail'];

// 文字列の前後の半角スペースを削除
$str_mail_adress = trim($str_mail_address);

// 文字列が空かいなかのチェック
if($str_name == "")
{
$str = "氏名を記入してください";
}
elseif($str_mail_address != "" 
&& !preg_match(MATCH_MAIL,$str_mail_address))
{
$str = "メールアドレスを正しく記入してください";
}
elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 elseif($str_url != "http://")
 {
  if(!preg_match(MATCH_URL,$str_url))
  {
   $str = "URLを正しく記入してください";
  }
 }
 elseif($str_url == "http://")
 {
  $str_url = "";
 }
 return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message,&$str_url,&$str_pwd)
{
/*
$str_name  ：投稿者氏名
$str_title  ：記事タイトル
$str_message ：記事本文
$str_url  ：関連URL
$str_pwd    ：パスワード
*/
 // 改行タグの改行コードへの変換
 $str_message = tag_entity_form($str_message);
 
 // URL欄の初期値設定
 if($str_url == "")
 {
  $str_url = "http://";
 }
?&gt;
<table border="0">
<form method="post" action='<?=THIS_FILE?>'>
<tr>
 <td> </td><td>BBS1</td>
</tr>
<tr>
 <td>氏名</td><td><input name="name" size="30"
             value="<?=$str_name?>"></td>
</tr>
<tr>
 <td>タイトル</td><td><input name="title" size="60"
               value="<?=$str_title?>"></td>
</tr>
<tr>
 <td>記事</td>
 <td><textarea name="message" 
        rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
 <td>URL</td><td><input name="url" size="60"
            value="<?=$str_url?>"></td>
</tr>
	<td>パスワード</td>
	<td><input type="password" name="pwd" size="8"
		class="hankaku" value="<?=$str_pwd?>"></td>
<tr>
 <td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// 返信フォームの表示
function response_form_disp($status,$parent_id,$str_name,$str_mail_address
,$str_title,$str_message,$str_url,$str_pwd
,$str_parent_mail_address,$mail_send)
{
/*
$parent_id ：親記事番号
$str_name ：投稿者氏名
$str_mail_address ：メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
$str_parent_mail_address ：親記事投稿者のメールアドレス
$mail_send ：メール送信フラグ("yes":メール送信する"no":しない)
*/

// 改行タグの改行コードへの変換
$str_message = tag_entity_form($str_message);

if($status == "before")
{
// タイトルの冒頭に「Re[n]:」を付加する
$str_title = re_counter($str_title);

// 記事本文の行頭に引用記号「> 」を挿入する
$arr_message = array();
$arr_message = explode("\n",$str_message);
$arr_message_new = array();
foreach($arr_message as $str_line)
{
$str_line = "&gt; " . $str_line;
array_push($arr_message_new,$str_line);
}
$str_message = implode("\n",$arr_message_new);
}

// URL欄の初期値設定
if($str_url == "")
{
$str_url = "http://";
}
?>
<table border="0">
<form method="post" action='<?=RESPONSE_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>&nbsp;</td>
<td>この記事を次の投稿者にメールでも送信
<input type="radio" name="mail_send" value="yes">する
<input type="radio" name="mail_send" value="no">しない<br>
&lt;?=$str_parent_mail_address?&gt;</td>
</tr>
<tr>
<td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
<input type="hidden" name="parent_id" value="<?=$parent_id?>">
<input type="hidden" name="parent_mail_address" 
value="<?=$str_parent_mail_address?>">
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// タイトルの冒頭に返信レベルカウンター「Re[n]:」を付加する
function re_counter($str)
{
// 返信レベルカウンター用文字列の設定
$str_re1 = "Re[";
$str_re2 = "]:";
// 返信レベルカウンターのパターンマッチ
if(preg_match(MATCH_RE,$str,$arr))
{
// 返信レベルカウンターのレベル値を１だけ増分
$str_re_next = $str_re1 . ($arr[2] + 1) . $str_re2;
// 返信レベルカウンターの置換
$str = preg_replace(MATCH_RE,$str_re_next,$str);
}
else
// 返信レベルカウンターの文字列がない場合（最初の返信）
{
$str = $str_re1 . "1" . $str_re2 . $str;
}
return $str;
}

// ----------------------------------------------
// 更新モードでの記事の表示
	function update_form_disp(&$message_id,&$str_name,&$str_title,&$str_message
	,&$str_date,&$str_update,&$str_url,&$str_pwd)
	{
	/*
	$str_name ：投稿者氏名
	$str_title ：記事タイトル
	$str_message ：記事本文
	$str_url ：関連URL
	$str_pwd ：パスワード
	*/
	// 改行タグの改行コードへの変換
	$str_message = tag_entity_form($str_message);

	// URL欄の初期値設定
	if($str_url == "")
	{
		$str_url = "http://";
	}
?>
<table border="0">
<form method="post" action='<?=EDIT_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>記事番号</td><td><?=$message_id?></td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>投稿日</td><td>&lt;?=$str_date?&gt;</td>
</tr>
<tr>
<td class='xs'>前回更新日</td><td>&lt;?=$str_update?&gt;</td>
</tr>
<tr>
<td> </td>
<td><input type="submit" name="command" value="送信">
<input type="submit" name="command" value="キャンセル"></td>
</tr>
<input type="hidden" name="id" value="<?=$message_id?>">
<input type="hidden" name="date" value="<?=$str_date?>">
<input type="hidden" name="update" value="<?=$str_update?>">
</form>
</table>
&lt;?php
}

	// ----------------------------------------------
	// 入力文字列の整形処理
	function input_str_convert($str)
	{
	 if($str != "")
	  {
	   // 文字列の前後の半角スペースを削除
	   $str = trim($str);
	   // 半角カタカナを全角カタカナに変換
	   // V: 濁点付きの文字を１文字に変換
	   // K: 半角カタカナを全角カタカナに変換
	   $str = mb_convert_kana($str,'KV');
	  }
	  return $str;
	}

	// -----------------------------------------------
	// 1個の記事本文の表示
	function message_disp(&$arr_message)
	{
	/*
	$arr_message['id'] ：記事番号
	$arr_message['name'] ：投稿者氏名
	$arr_message['mail'] ：投稿者メールアドレス
	$arr_message['title'] ：記事タイトル
	$arr_message['message'] ：記事本文
	$arr_message['date'] ：投稿日時
	$arr_message['url'] ：関連URL
	*/
	 $str_url = $arr_message['url'];

	// 「削除」用URL
	$str_url_del = EDIT_FILE . "?id=" . $arr_message['id'] . "&command=del";

	// 「更新」用URL
	$str_url_update = EDIT_FILE . "?id=" . $arr_message['id']. "&command=update";

	// 「返信」用URL
	$str_url_response = RESPONSE_FILE . "?id=" . $arr_message['id']
	. "&command=response";
	
	// 「メール」用URL
	$str_url_mail = "mailto:" . $arr_message['mail'];
?&gt;
<table class="bd_w1 bd_solid bd_b
padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
<td>No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
<span class="fbold">［&lt;?=$arr_message['name']?&gt;］ </span>
<span class="696969">&lt;?=$arr_message['date']?&gt;</span></td>
<td class='ar'><a href="<?=$str_url_mail?>">メール</a>
<a href="<?=$str_url_response?>">返信</a></td>
</tr>
<tr class="b_w xs">
<td colspan=2>&lt;?=$arr_message['message']?&gt;
&lt;?php
 if($str_url != "")
 {
?&gt;
<br>URL: <a href="<?=$str_url?>"><?=$str_url?></a></td>
&lt;?php
 }
?&gt;
</tr>
</table>
<table class="bd_w0 w600">
<tr class="xs">
	<td class="ar">
		<a href="<?=$str_url_del?>">削除</a>
		<a href="<?=$str_url_update?>">更新</a></td>
	</td>
</tr>
</table>
&lt;?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/

  if($str_sql != "" && $page > 0)
  {   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page > 0 && $page <= $total_page)
  {
    // ページ数の値が正しい場合
   // オフセットの設定
    $offset = ($page - 1) * $page_size;
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "<p class='ac'>";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
     $arr_message['url'] = $arr_record['url'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "<br>\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "</p>";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{

 // URLエンコード
  $str_sql_encoded = rawurlencode($str_sql);
  // URL文字列生成
  $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
           . "&page=" ;
  // ページナビゲータ表示
  print "<table class='bd_w0'>\n";
  print "<tr>\n";
  print "<td class='al w250'>";
  
 if($page > 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);

   print "[<a href=" . $str_url_before . ">前の" 
         . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[前の{$page_size}ページ]</span>";
  }
  
 print "</td>\n";
  print "<td class='ac w100'>\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "</td>\n";
  print "<td class='ar w250'>\n";

 if($page < $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[<a href=" . $str_url_next . ">次の"    
       . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[次の{$page_size}ページ]</span>";
  }
  print "</td>\n";
  print "</tr>\n";
  print "</table>\n";
  }
  
  // -----------------------------------------------
// 1個の記事本文の表示（確認用）
function message_show(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
$arr_message['url'] ：関連URL
*/
 $str_url = $arr_message['url'];

 $str_url_del = EDIT_FILE . "?id=" . $arr_message['id']
        . "&command=del";
?>
<table class="bd_w1 bd_solid bd_b
       padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
 <td>No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
   <span class="fbold">［&lt;?=$arr_message['name']?&gt;］ </span>
   <span class="696969">&lt;?=$arr_message['date']?&gt;</span></td>
</tr>
<tr class="b_w xs">
 <td>&lt;?=$arr_message['message']?&gt;
&lt;?php
 if($str_url != "")
 {
?&gt;
<br>URL: <a href="<?=$str_url?>"><?=$str_url?></a></td>
&lt;?php
 }
?&gt;
</tr>
</table>
&lt;?php
}
  
?&gt;
</pre>
</p>
<p>（２）受信メールアドレスのチェック</p><p>受信したメールアドレスデータが，メールアドレスとして正しい文字列かどうか，セキュリティ対策上チェックする必要があります．メールアドレス文字列$str_mail_addressは，Perl互換の正規表現として，たとえば以下の正規表現に一致する必要があります．</p> 
  <p class="command-print">preg_match("/^[\w\d\-\.]+\@[\w\d\-\.]+$/",$str_mail_address)</p>

<p>サンプルスクリプトでは，一致すべき正規表現パターンを定数MATCH_MAILとして，インクルードファイルsystem02e.php内に定義して使用することとします．</p> 
  


sysytem02e.php
    <pre class="brush:php;">
    &lt;?php
    define(COMMON_BBS_FILE,"common_bbs2e.php");
    define(MAIN_FILE,"main02e.php");
    define(QUERY_FILE,"query02.php");
    define(EDIT_FILE,"edit02e.php");
    define(RESPONSE_FILE,"response02e.php");
    define(MATCH_URL,"/^http(s?)\:\/\/[\w\.\-\/\?\&amp;\+\=\:\@\%\#]+$/");
    define(MATCH_PWD,"/^[0-9a-zA-Z]+$/");
    define(MATCH_RE, "/^(Re\[(\d+)\]:)/");
  <font color="#000000">define(MATCH_MAIL,"/^[\w\d\-\.]+\@[\w\d\-\.]+$/");</h4></font>
    define(SALT,"bbs");
    ?&gt;
</pre>
  </p>
<p>この定数MATCH_MAILを使用して，インクルードファイルcommon_bbs2e.phpの中の受信データチェック用のユーザ定義関数「data_check()」を以下のように改造します．
</p> 
  
common_bbs2e.php
    <pre class="brush:php;">
    &lt;?php
// ユーザ定義関数

// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_mail_address,&$str_title,&$str_message
,&$str_url,&$str_pwd)
{
/*
$str_name ：投稿者氏名
$str_mail_address :メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
*/
global $str_charset;
 disp_var(1,$str_charset,'$str_charset');
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];
 $str_url = $_POST['url'];
 $str_pwd = $_POST['pwd'];
 $str_mail_address = $_POST['mail'];

// 文字列の前後の半角スペースを削除
$str_mail_adress = trim($str_mail_address);

// 文字列が空かいなかのチェック
if($str_name == "")
{
$str = "氏名を記入してください";
}
elseif($str_mail_address != "" 
&& !preg_match(MATCH_MAIL,$str_mail_address))
{
$str = "メールアドレスを正しく記入してください";
}
elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 elseif($str_url != "http://")
 {
  if(!preg_match(MATCH_URL,$str_url))
  {
   $str = "URLを正しく記入してください";
  }
 }
 elseif($str_url == "http://")
 {
  $str_url = "";
 }
 return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message,&$str_url,&$str_pwd)
{
/*
$str_name  ：投稿者氏名
$str_title  ：記事タイトル
$str_message ：記事本文
$str_url  ：関連URL
$str_pwd    ：パスワード
*/
 // 改行タグの改行コードへの変換
 $str_message = tag_entity_form($str_message);
 
 // URL欄の初期値設定
 if($str_url == "")
 {
  $str_url = "http://";
 }
?&gt;
<table border="0">
<form method="post" action='<?=THIS_FILE?>'>
<tr>
 <td> </td><td>BBS1</td>
</tr>
<tr>
 <td>氏名</td><td><input name="name" size="30"
             value="<?=$str_name?>"></td>
</tr>
<tr>
 <td>タイトル</td><td><input name="title" size="60"
               value="<?=$str_title?>"></td>
</tr>
<tr>
 <td>記事</td>
 <td><textarea name="message" 
        rows="5" cols="60">&lt;?=$str_message?&gt;</textarea></td>
</tr>
<tr>
 <td>URL</td><td><input name="url" size="60"
            value="<?=$str_url?>"></td>
</tr>
	<td>パスワード</td>
	<td><input type="password" name="pwd" size="8"
		class="hankaku" value="<?=$str_pwd?>"></td>
</tr>
<tr>
 <td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// 返信フォームの表示
function response_form_disp($status,$parent_id,$str_name,$str_mail_address
,$str_title,$str_message,$str_url,$str_pwd
,$str_parent_mail_address,$mail_send)
{
/*
$parent_id ：親記事番号
$str_name ：投稿者氏名
$str_mail_address ：メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
$str_parent_mail_address ：親記事投稿者のメールアドレス
$mail_send ：メール送信フラグ("yes":メール送信する"no":しない)
*/

// 改行タグの改行コードへの変換
$str_message = tag_entity_form($str_message);

if($status == "before")
{
// タイトルの冒頭に「Re[n]:」を付加する
$str_title = re_counter($str_title);

// 記事本文の行頭に引用記号「&gt; 」を挿入する
$arr_message = array();
$arr_message = explode("\n",$str_message);
$arr_message_new = array();
foreach($arr_message as $str_line)
{
$str_line = "&gt; " . $str_line;
array_push($arr_message_new,$str_line);
}
$str_message = implode("\n",$arr_message_new);
}

// URL欄の初期値設定
if($str_url == "")
{
$str_url = "http://";
}
?&gt;
<table border="0">
<form method="post" action='<?=RESPONSE_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>&nbsp;</td>
<td>この記事を次の投稿者にメールでも送信
<input type="radio" name="mail_send" value="yes">する
<input type="radio" name="mail_send" value="no">しない<br>
&lt;?=$str_parent_mail_address?&gt;</td>
</tr>
<tr>
<td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
<input type="hidden" name="parent_id" value="<?=$parent_id?>">
<input type="hidden" name="parent_mail_address" 
value="<?=$str_parent_mail_address?>">
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// タイトルの冒頭に返信レベルカウンター「Re[n]:」を付加する
function re_counter($str)
{
// 返信レベルカウンター用文字列の設定
$str_re1 = "Re[";
$str_re2 = "]:";
// 返信レベルカウンターのパターンマッチ
if(preg_match(MATCH_RE,$str,$arr))
{
// 返信レベルカウンターのレベル値を１だけ増分
$str_re_next = $str_re1 . ($arr[2] + 1) . $str_re2;
// 返信レベルカウンターの置換
$str = preg_replace(MATCH_RE,$str_re_next,$str);
}
else
// 返信レベルカウンターの文字列がない場合（最初の返信）
{
$str = $str_re1 . "1" . $str_re2 . $str;
}
return $str;
}

// ----------------------------------------------
// 更新モードでの記事の表示
	function update_form_disp(&$message_id,&$str_name,&$str_title,&$str_message
	,&$str_date,&$str_update,&$str_url,&$str_pwd)
	{
	/*
	$str_name ：投稿者氏名
	$str_title ：記事タイトル
	$str_message ：記事本文
	$str_url ：関連URL
	$str_pwd ：パスワード
	*/
	// 改行タグの改行コードへの変換
	$str_message = tag_entity_form($str_message);

	// URL欄の初期値設定
	if($str_url == "")
	{
		$str_url = "http://";
	}
?&gt;
<table border="0">
<form method="post" action='<?=EDIT_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>記事番号</td><td><?=$message_id?></td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60">&lt;?=$str_message?z&gt;</textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>投稿日</td><td>&lt;?=$str_date?&gt;</td>
</tr>
<tr>
<td class='xs'>前回更新日</td><td>&lt;?=$str_update?&gt;</td>
</tr>
<tr>
<td> </td>
<td><input type="submit" name="command" value="送信">
<input type="submit" name="command" value="キャンセル"></td>
</tr>
<input type="hidden" name="id" value="<?=$message_id?>">
<input type="hidden" name="date" value="<?=$str_date?>">
<input type="hidden" name="update" value="<?=$str_update?>">
</form>
</table>
&lt;?php
}

	// ----------------------------------------------
	// 入力文字列の整形処理
	function input_str_convert($str)
	{
	 if($str != "")
	  {
	   // 文字列の前後の半角スペースを削除
	   $str = trim($str);
	   // 半角カタカナを全角カタカナに変換
	   // V: 濁点付きの文字を１文字に変換
	   // K: 半角カタカナを全角カタカナに変換
	   $str = mb_convert_kana($str,'KV');
	  }
	  return $str;
	}

	// -----------------------------------------------
	// 1個の記事本文の表示
	function message_disp(&$arr_message)
	{
	/*
	$arr_message['id'] ：記事番号
	$arr_message['name'] ：投稿者氏名
	$arr_message['mail'] ：投稿者メールアドレス
	$arr_message['title'] ：記事タイトル
	$arr_message['message'] ：記事本文
	$arr_message['date'] ：投稿日時
	$arr_message['url'] ：関連URL
	*/
	 $str_url = $arr_message['url'];

	// 「削除」用URL
	$str_url_del = EDIT_FILE . "?id=" . $arr_message['id'] . "&command=del";

	// 「更新」用URL
	$str_url_update = EDIT_FILE . "?id=" . $arr_message['id']. "&command=update";

	// 「返信」用URL
	$str_url_response = RESPONSE_FILE . "?id=" . $arr_message['id']
	. "&command=response";
	
	// 「メール」用URL
	$str_url_mail = "mailto:" . $arr_message['mail'];
?&gt;
<table class="bd_w1 bd_solid bd_b
padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
<td>No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
<span class="fbold">［&lt;?=$arr_message['name']?&gt;］ </span>
<span class="696969">&lt;?=$arr_message['date']?&gt;</span></td>
<td class='ar'><a href="<?=$str_url_mail?>">メール</a>
<a href="<?=$str_url_response?>">返信</a></td>
</tr>
<tr class="b_w xs">
<td colspan=2>&lt;?=$arr_message['message']?&gt;
&lt;?php
 if($str_url != "")
 {
?&gt;
<br>URL: <a href="<?=$str_url?>">&lt;?=$str_url?&gt;</a></td>
&lt;?php
 }
?&gt;
</tr>
</table>
<table class="bd_w0 w600">
<tr class="xs">
	<td class="ar">
		<a href="<?=$str_url_del?>">削除</a>
		<a href="<?=$str_url_update?>">更新</a></td>
	</td>
</tr>
</table>
&lt;?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/

  if($str_sql != "" && $page > 0)
  {   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page > 0 && $page <= $total_page)
  {
    // ページ数の値が正しい場合
   // オフセットの設定
    $offset = ($page - 1) * $page_size;
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "<p class='ac'>";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
     $arr_message['url'] = $arr_record['url'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "<br>\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "</p>";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{

 // URLエンコード
  $str_sql_encoded = rawurlencode($str_sql);
  // URL文字列生成
  $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
           . "&page=" ;
  // ページナビゲータ表示
  print "<table class='bd_w0'>\n";
  print "<tr>\n";
  print "<td class='al w250'>";
  
 if($page > 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);

   print "[<a href=" . $str_url_before . ">前の" 
         . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[前の{$page_size}ページ]</span>";
  }
  
 print "</td>\n";
  print "<td class='ac w100'>\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "</td>\n";
  print "<td class='ar w250'>\n";

 if($page < $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[<a href=" . $str_url_next . ">次の"    
       . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[次の{$page_size}ページ]</span>";
  }
  print "</td>\n";
  print "</tr>\n";
  print "</table>\n";
  }
  
  // -----------------------------------------------
// 1個の記事本文の表示（確認用）
function message_show(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
$arr_message['url'] ：関連URL
*/
 $str_url = $arr_message['url'];

 $str_url_del = EDIT_FILE . "?id=" . $arr_message['id']
        . "&command=del";
?&gt;
<table class="bd_w1 bd_solid bd_b
       padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
 <td>No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
   <span class="fbold">［&lt;?=$arr_message['name']?&gt;］ </span>
   <span class="696969">&lt;?=$arr_message['date']?&gt;</span></td>
</tr>
<tr class="b_w xs">
 <td>&lt;?=$arr_message['message']?&gt;
&lt;?php
 if($str_url != "")
 {
?&gt;
<br>URL: <a href="<?=$str_url?>"><?=$str_url?></a></td>
&lt;?php
 }
?&gt;
</tr>
</table>
&lt;?php
}
  
?&gt;
</pre>
  </p>
<p>（３）受信データの保存</p><p>受信データの保存時も，メールアドレスを保存するように，main02d.phpを改造し，main02e.phpとします．</p> 
  
main02e.php
    <pre class="brush:php;">
    &lt;?php
include "system02e.php";
include "common.php";
define(THIS_FILE,MAIN_FILE);
include COMMON_BBS_FILE;
$str_charset = "UTF-8";
// ページサイズ
$page_size = 5;
?&gt;
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" >
<title>BBS1:記事検索</title>
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="common.css">
</head>
<body class="b_ffff99">
&lt;?php
 // データベースへの接続と選択
 // データベースサーバへの接続・データベースの選択
 $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli-&gt;query($str_sql); 

?&gt;
<!-- 「記事入力」，「全記事表示」のハイパーリンクの表示 -->
<p class="ac">
<a href="<?=MAIN_FILE?>">記事入力</a> ｜ 
<a href="<?=MAIN_FILE?>?page=all">全記事表示</a><br><br>

<!-- 検索キーワード入力部の表示 -->
<form action="<?=QUERY_FILE?>" method="post">
<input type="text" name="keyword">
<input type="submit" name="command" value="検索">
</form>
</p>&lt;?php

 // 全記事表示（page=all）
 if($_GET['page'] == 'all' && $_POST['command'] != "送信")
 {
  // テーブルのデータの一覧取得（最後に「;」をつけない）
  $str_sql = "select * from tbl_bbs2 order by message_id desc";

  // 第１ページ目の設定
  $page = 1;

  // ページ単位表示
  page_disp($str_sql,$page,$page_size,$mysqli);

  $mysqli->close();
 }
 // ページ番号を受信した場合
 elseif($_GET['page'] > 0)
 {
  // ページ番号
  $page = $_GET['page'];
  // SQL文
  $str_sql = $_GET['sql'];

  // ページ単位表示
  page_disp($str_sql,$page,$page_size,$mysqli);

 }
 // 「送信」の場合
 if($_POST['command'] == "送信")
 {
  // 受信データが「空」でないかどうかチェック
  $str_error_message = data_check($str_name,$str_mail_address,$str_title,$str_message
                  ,$str_url,$str_pwd);
  if($str_error_message == "")
  {
   // 現在日時の取得
   $str_date = date("Y-m-d H:i:s",time());
   // 「message_id」の生成
   // tbl_bbs2テーブルのmessage_idの最大値の取得
   $str_sql = "select max(message_id) as max_id from tbl_bbs2;";
   $rs = $mysqli->query($str_sql);
   $arr_record = array();
   $arr_record = $rs->fetch_assoc();
   $max_id = $arr_record['max_id'];
   if($max_id > 0)
   {
    $new_id = $max_id + 1;
   }
   else
   {
    $new_id = 1;
   }

   $str_name = $mysqli->real_escape_string($str_name);
   $str_title = $mysqli->real_escape_string($str_title);
   $str_message = $mysqli->real_escape_string($str_message);
	$str_pwd = $mysqli->real_escape_string($str_pwd);

	 // パスワードの暗号化
	$enc_pwd = "";
	if($str_pwd != "")
	{ 
		$enc_pwd = crypt($str_pwd,SALT);
	}
  // データのテーブルへの保存
  $str_sql = "insert into tbl_bbs2 "
       . "(message_id,name,mail,title,message,date,url,pwd)"
       . "values("
       . $new_id. ",'" . $str_name . "','" . $str_mail_address . "','" . $str_title
       . "','" . $str_message . "','" . $str_date 
       . "','" . $str_url . "','" . $enc_pwd . "');";
       
  $mysqli->query($str_sql);

  // データのリセット
  $new_id = "";
  $str_name = "";
  $str_title = "";
  $str_message = "";
  $str_date = "";
  $str_url = "";

   // テーブルのデータの一覧取得（最後に「;」をつけない）
   $str_sql = "select * from tbl_bbs2 order by message_id desc";

   // 第１ページ目の設定
   $page = 1;

   // ページ単位表示
   page_disp($str_sql,$page,$page_size,$mysqli);

   $mysqli->close();
  }
  else
  {
   print "<p align=center>";
   print "<font style='color:red'>{$str_error_message}</font><br>\n";
   print "</p>";
  }
 }
 print "<p class='ac'>";

 // 入力フォームの表示
 input_form_disp($str_name,$str_mail_address,$str_title,$str_message, $str_url, $str_pwd);
 print "</p>";
?&gt;
</body>
</html>
</pre>
  </p>

<p>（４）個々の記事に，メール用リンクを表示</p><p>記事の一覧表示において，個々の記事にその記事の投稿者のメールアドレスにメールを送信するためのメール用リンクを表示するようにします．インクルードファイルcommon_bbs02e.phpファイル内のmessage_disp()関数を以下のように改造します．</p> 
 
common_bbs02e.php
    <pre class="brush:php;">
    &lt;?php
// ユーザ定義関数

// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_mail_address,&$str_title,&$str_message
,&$str_url,&$str_pwd)
{
/*
$str_name ：投稿者氏名
$str_mail_address :メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
*/
global $str_charset;
 disp_var(1,$str_charset,'$str_charset');
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];
 $str_url = $_POST['url'];
 $str_pwd = $_POST['pwd'];
 $str_mail_address = $_POST['mail'];

// 文字列の前後の半角スペースを削除
$str_mail_adress = trim($str_mail_address);

// 文字列が空かいなかのチェック
if($str_name == "")
{
$str = "氏名を記入してください";
}
elseif($str_mail_address != "" 
&& !preg_match(MATCH_MAIL,$str_mail_address))
{
$str = "メールアドレスを正しく記入してください";
}
elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 elseif($str_url != "http://")
 {
  if(!preg_match(MATCH_URL,$str_url))
  {
   $str = "URLを正しく記入してください";
  }
 }
 elseif($str_url == "http://")
 {
  $str_url = "";
 }
 return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message,&$str_url,&$str_pwd)
{
/*
$str_name  ：投稿者氏名
$str_title  ：記事タイトル
$str_message ：記事本文
$str_url  ：関連URL
$str_pwd    ：パスワード
*/
 // 改行タグの改行コードへの変換
 $str_message = tag_entity_form($str_message);
 
 // URL欄の初期値設定
 if($str_url == "")
 {
  $str_url = "http://";
 }
?&gt;
<table border="0">
<form method="post" action='<?=THIS_FILE?>'>
<tr>
 <td> </td><td>BBS1</td>
</tr>
<tr>
 <td>氏名</td><td><input name="name" size="30"
             value="<?=$str_name?>"></td>
</tr>
<tr>
 <td>タイトル</td><td><input name="title" size="60"
               value="<?=$str_title?>"></td>
</tr>
<tr>
 <td>記事</td>
 <td><textarea name="message" 
        rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
 <td>URL</td><td><input name="url" size="60"
            value="<?=$str_url?>"></td>
</tr>
	<td>パスワード</td>
	<td><input type="password" name="pwd" size="8"
		class="hankaku" value="<?=$str_pwd?>"></td>
</tr>
<tr>
 <td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// 返信フォームの表示
function response_form_disp($status,$parent_id,$str_name,$str_mail_address
,$str_title,$str_message,$str_url,$str_pwd
,$str_parent_mail_address,$mail_send)
{
/*
$parent_id ：親記事番号
$str_name ：投稿者氏名
$str_mail_address ：メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
$str_parent_mail_address ：親記事投稿者のメールアドレス
$mail_send ：メール送信フラグ("yes":メール送信する"no":しない)
*/

// 改行タグの改行コードへの変換
$str_message = tag_entity_form($str_message);

if($status == "before")
{
// タイトルの冒頭に「Re[n]:」を付加する
$str_title = re_counter($str_title);

// 記事本文の行頭に引用記号「> 」を挿入する
$arr_message = array();
$arr_message = explode("\n",$str_message);
$arr_message_new = array();
foreach($arr_message as $str_line)
{
$str_line = "&gt; " . $str_line;
array_push($arr_message_new,$str_line);
}
$str_message = implode("\n",$arr_message_new);
}

// URL欄の初期値設定
if($str_url == "")
{
$str_url = "http://";
}
?&gt;
<table border="0">
<form method="post" action='<?=RESPONSE_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>&nbsp;</td>
<td>この記事を次の投稿者にメールでも送信
<input type="radio" name="mail_send" value="yes">する
<input type="radio" name="mail_send" value="no">しない<br>
&lt;?=$str_parent_mail_address?&gt;</td>
</tr>
<tr>
<td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
<input type="hidden" name="parent_id" value="<?=$parent_id?>">
<input type="hidden" name="parent_mail_address" 
value="<?=$str_parent_mail_address?>">
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// タイトルの冒頭に返信レベルカウンター「Re[n]:」を付加する
function re_counter($str)
{
// 返信レベルカウンター用文字列の設定
$str_re1 = "Re[";
$str_re2 = "]:";
// 返信レベルカウンターのパターンマッチ
if(preg_match(MATCH_RE,$str,$arr))
{
// 返信レベルカウンターのレベル値を１だけ増分
$str_re_next = $str_re1 . ($arr[2] + 1) . $str_re2;
// 返信レベルカウンターの置換
$str = preg_replace(MATCH_RE,$str_re_next,$str);
}
else
// 返信レベルカウンターの文字列がない場合（最初の返信）
{
$str = $str_re1 . "1" . $str_re2 . $str;
}
return $str;
}

// ----------------------------------------------
// 更新モードでの記事の表示
	function update_form_disp(&$message_id,&$str_name,&$str_title,&$str_message
	,&$str_date,&$str_update,&$str_url,&$str_pwd)
	{
	/*
	$str_name ：投稿者氏名
	$str_title ：記事タイトル
	$str_message ：記事本文
	$str_url ：関連URL
	$str_pwd ：パスワード
	*/
	// 改行タグの改行コードへの変換
	$str_message = tag_entity_form($str_message);

	// URL欄の初期値設定
	if($str_url == "")
	{
		$str_url = "http://";
	}
?&gt;
<table border="0">
<form method="post" action='<?=EDIT_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>記事番号</td><td>&lt;?=$message_id?&gt;</td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60">&lt;?=$str_message?&gt;</textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>投稿日</td><td>&lt;?=$str_date?&gt;</td>
</tr>
<tr>
<td class='xs'>前回更新日</td><td>&lt;?=$str_update?&gt;</td>
</tr>
<tr>
<td> </td>
<td><input type="submit" name="command" value="送信">
<input type="submit" name="command" value="キャンセル"></td>
</tr>
<input type="hidden" name="id" value="<?=$message_id?>">
<input type="hidden" name="date" value="<?=$str_date?>">
<input type="hidden" name="update" value="<?=$str_update?>">
</form>
</table>
&lt;?php
}

	// ----------------------------------------------
	// 入力文字列の整形処理
	function input_str_convert($str)
	{
	 if($str != "")
	  {
	   // 文字列の前後の半角スペースを削除
	   $str = trim($str);
	   // 半角カタカナを全角カタカナに変換
	   // V: 濁点付きの文字を１文字に変換
	   // K: 半角カタカナを全角カタカナに変換
	   $str = mb_convert_kana($str,'KV');
	  }
	  return $str;
	}

	// -----------------------------------------------
	// 1個の記事本文の表示
	function message_disp(&$arr_message)
	{
	/*
	$arr_message['id'] ：記事番号
	$arr_message['name'] ：投稿者氏名
	$arr_message['mail'] ：投稿者メールアドレス
	$arr_message['title'] ：記事タイトル
	$arr_message['message'] ：記事本文
	$arr_message['date'] ：投稿日時
	$arr_message['url'] ：関連URL
	*/
	 $str_url = $arr_message['url'];

	// 「削除」用URL
	$str_url_del = EDIT_FILE . "?id=" . $arr_message['id'] . "&command=del";

	// 「更新」用URL
	$str_url_update = EDIT_FILE . "?id=" . $arr_message['id']. "&command=update";

	// 「返信」用URL
	$str_url_response = RESPONSE_FILE . "?id=" . $arr_message['id']
	. "&command=response";
	
	// 「メール」用URL
	$str_url_mail = "mailto:" . $arr_message['mail'];
?&gt;
<table class="bd_w1 bd_solid bd_b
padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
<td>No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
<span class="fbold">［&lt;?=$arr_message['name']?&gt;］ </span>
<span class="696969">&lt;?=$arr_message['date']?&gt;</span></td>
<td class='ar'><a href="<?=$str_url_mail?>">メール</a>
<a href="<?=$str_url_response?>">返信</a></td>
</tr>
<tr class="b_w xs">
<td colspan=2>&lt;?=$arr_message['message']?&gt;
<?php
 if($str_url != "")
 {
?>
<br>URL: <a href="<?=$str_url?>"><?=$str_url?></a></td>
<?php
 }
?&gt;
</tr>
</table>
<table class="bd_w0 w600">
<tr class="xs">
	<td class="ar">
		<a href="<?=$str_url_del?>">削除</a>
		<a href="<?=$str_url_update?>">更新</a></td>
	</td>
</tr>
</table>
&lt;?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/

  if($str_sql != "" && $page > 0)
  {   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page > 0 && $page <= $total_page)
  {
    // ページ数の値が正しい場合
   // オフセットの設定
    $offset = ($page - 1) * $page_size;
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "<p class='ac'>";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
     $arr_message['url'] = $arr_record['url'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "<br>\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "</p>";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{

 // URLエンコード
  $str_sql_encoded = rawurlencode($str_sql);
  // URL文字列生成
  $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
           . "&page=" ;
  // ページナビゲータ表示
  print "<table class='bd_w0'>\n";
  print "<tr>\n";
  print "<td class='al w250'>";
  
 if($page > 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);

   print "[<a href=" . $str_url_before . ">前の" 
         . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[前の{$page_size}ページ]</span>";
  }
  
 print "</td>\n";
  print "<td class='ac w100'>\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "</td>\n";
  print "<td class='ar w250'>\n";

 if($page < $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[<a href=" . $str_url_next . ">次の"    
       . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[次の{$page_size}ページ]</span>";
  }
  print "</td>\n";
  print "</tr>\n";
  print "</table>\n";
  }
  
  // -----------------------------------------------
// 1個の記事本文の表示（確認用）
function message_show(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
$arr_message['url'] ：関連URL
*/
 $str_url = $arr_message['url'];

 $str_url_del = EDIT_FILE . "?id=" . $arr_message['id']
        . "&command=del";
?&gt;
<table class="bd_w1 bd_solid bd_b
       padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
 <td>No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
   <span class="fbold">［&lt;?=$arr_message['name']?&gt;］ </span>
   <span class="696969">&lt;?=$arr_message['date']?&gt;</span></td>
</tr>
<tr class="b_w xs">
 <td>&lt;?=$arr_message['message']?&gt;
&lt;?php
 if($str_url != "")
 {
?&gt;
<br>URL: <a href="<?=$str_url?>">&lt;?=$str_url?&gt;</a></td>
&lt;?php
 }
?&gt;
</tr>
</table>
&lt;?php
}
  
?&gt;
</pre>
</p>
<p>（５）返信記事入力画面でメール送信を選択できるようにする</p><p>返信記事入力画面で，ラジオボタンによりメール送信を選択できるようにします．そのために，インクルードファイルcommon_bbs02e.phpファイル内のresponse_form_disp()関数を以下のように改造します．</p> 
 
common_bbs02e.php
    <pre class="brush:php;">
    <?php
// ユーザ定義関数

// ----------------------------------------------
// 受信データのチェック
function data_check(&$str_name,&$str_mail_address,&$str_title,&$str_message
,&$str_url,&$str_pwd)
{
/*
$str_name ：投稿者氏名
$str_mail_address :メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
*/
global $str_charset;
 disp_var(1,$str_charset,'$str_charset');
 // データの受信
 $str_name = $_POST['name'];
 $str_title = $_POST['title'];
 $str_message = $_POST['message'];
 $str_url = $_POST['url'];
 $str_pwd = $_POST['pwd'];
 $str_mail_address = $_POST['mail'];

// 文字列の前後の半角スペースを削除
$str_mail_adress = trim($str_mail_address);

// 文字列が空かいなかのチェック
if($str_name == "")
{
$str = "氏名を記入してください";
}
elseif($str_mail_address != "" 
&& !preg_match(MATCH_MAIL,$str_mail_address))
{
$str = "メールアドレスを正しく記入してください";
}
elseif($str_title == "")
 {
  $str = "タイトルを記入してください";
 }
 elseif($str_message == "")
 {
  $str = "本文を記入してください";
 }
 elseif($str_url != "http://")
 {
  if(!preg_match(MATCH_URL,$str_url))
  {
   $str = "URLを正しく記入してください";
  }
 }
 elseif($str_url == "http://")
 {
  $str_url = "";
 }
 return $str;
}

// ----------------------------------------------
// 入力フォームの表示
function input_form_disp(&$str_name,&$str_title,&$str_message,&$str_url,&$str_pwd)
{
/*
$str_name  ：投稿者氏名
$str_title  ：記事タイトル
$str_message ：記事本文
$str_url  ：関連URL
$str_pwd    ：パスワード
*/
 // 改行タグの改行コードへの変換
 $str_message = tag_entity_form($str_message);
 
 // URL欄の初期値設定
 if($str_url == "")
 {
  $str_url = "http://";
 }
?>
<table border="0">
<form method="post" action='<?=THIS_FILE?>'>
<tr>
 <td> </td><td>BBS1</td>
</tr>
<tr>
 <td>氏名</td><td><input name="name" size="30"
             value="<?=$str_name?>"></td>
</tr>
<tr>
 <td>タイトル</td><td><input name="title" size="60"
               value="<?=$str_title?>"></td>
</tr>
<tr>
 <td>記事</td>
 <td><textarea name="message" 
        rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
 <td>URL</td><td><input name="url" size="60"
            value="<?=$str_url?>"></td>
</tr>
	<td>パスワード</td>
	<td><input type="password" name="pwd" size="8"
		class="hankaku" value="<?=$str_pwd?>"></td>
</tr>
<tr>
 <td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// 返信フォームの表示
function response_form_disp($status,$parent_id,$str_name,$str_mail_address
,$str_title,$str_message,$str_url,$str_pwd
,$str_parent_mail_address,$mail_send)
{
/*
$parent_id ：親記事番号
$str_name ：投稿者氏名
$str_mail_address ：メールアドレス
$str_title ：記事タイトル
$str_message ：記事本文
$str_url ：関連URL
$str_pwd ：パスワード
$str_parent_mail_address ：親記事投稿者のメールアドレス
$mail_send ：メール送信フラグ("yes":メール送信する"no":しない)
*/

// 改行タグの改行コードへの変換
$str_message = tag_entity_form($str_message);

if($status == "before")
{
// タイトルの冒頭に「Re[n]:」を付加する
$str_title = re_counter($str_title);

// 記事本文の行頭に引用記号「> 」を挿入する
$arr_message = array();
$arr_message = explode("\n",$str_message);
$arr_message_new = array();
foreach($arr_message as $str_line)
{
$str_line = "&gt; " . $str_line;
array_push($arr_message_new,$str_line);
}
$str_message = implode("\n",$arr_message_new);
}

// URL欄の初期値設定
if($str_url == "")
{
$str_url = "http://";
}
?>
<table border="0">
<form method="post" action='<?=RESPONSE_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>&nbsp;</td>
<td>この記事を次の投稿者にメールでも送信
<input type="radio" name="mail_send" value="yes">する
<input type="radio" name="mail_send" value="no">しない<br>
&lt;?=$str_parent_mail_address?&gt;</td>
</tr>
<tr>
<td> </td><td><input type=submit name="command" value="送信"></td>
</tr>
<input type="hidden" name="parent_id" value="<?=$parent_id?>">
<input type="hidden" name="parent_mail_address" 
value="<?=$str_parent_mail_address?>">
</form>
</table>
&lt;?php
}

// ----------------------------------------------
// タイトルの冒頭に返信レベルカウンター「Re[n]:」を付加する
function re_counter($str)
{
// 返信レベルカウンター用文字列の設定
$str_re1 = "Re[";
$str_re2 = "]:";
// 返信レベルカウンターのパターンマッチ
if(preg_match(MATCH_RE,$str,$arr))
{
// 返信レベルカウンターのレベル値を１だけ増分
$str_re_next = $str_re1 . ($arr[2] + 1) . $str_re2;
// 返信レベルカウンターの置換
$str = preg_replace(MATCH_RE,$str_re_next,$str);
}
else
// 返信レベルカウンターの文字列がない場合（最初の返信）
{
$str = $str_re1 . "1" . $str_re2 . $str;
}
return $str;
}

// ----------------------------------------------
// 更新モードでの記事の表示
	function update_form_disp(&$message_id,&$str_name,&$str_title,&$str_message
	,&$str_date,&$str_update,&$str_url,&$str_pwd)
	{
	/*
	$str_name ：投稿者氏名
	$str_title ：記事タイトル
	$str_message ：記事本文
	$str_url ：関連URL
	$str_pwd ：パスワード
	*/
	// 改行タグの改行コードへの変換
	$str_message = tag_entity_form($str_message);

	// URL欄の初期値設定
	if($str_url == "")
	{
		$str_url = "http://";
	}
?&gt;
<table border="0">
<form method="post" action='<?=EDIT_FILE?>'>
<tr>
<td> </td><td>BBS1</td>
</tr>
<tr>
<td>記事番号</td><td>&lt;?=$message_id?&gt;</td>
</tr>
<tr>
<td>氏名</td><td><input name="name" size="30"
value="<?=$str_name?>"></td>
</tr>
<tr>
<td>タイトル</td><td><input name="title" size="60"
value="<?=$str_title?>"></td>
</tr>
<tr>
<td>記事</td>
<td><textarea name="message" 
rows="5" cols="60"><?=$str_message?></textarea></td>
</tr>
<tr>
<td>URL</td><td><input name="url" size="60"
value="<?=$str_url?>"></td>
</tr>
<tr>
<td>パスワード</td>
<td><input type="password" name="pwd" size="8"
class="hankaku" value="<?=$str_pwd?>">(半角英数字)</td>
</tr>
<tr>
<td>投稿日</td><td>&lt;?=$str_date?&gt;</td>
</tr>
<tr>
<td class='xs'>前回更新日</td><td>&lt;?=$str_update?&gt;</td>
</tr>
<tr>
<td> </td>
<td><input type="submit" name="command" value="送信">
<input type="submit" name="command" value="キャンセル"></td>
</tr>
<input type="hidden" name="id" value="<?=$message_id?>">
<input type="hidden" name="date" value="<?=$str_date?>">
<input type="hidden" name="update" value="<?=$str_update?>">
</form>
</table>
&lt;?php
}

	// ----------------------------------------------
	// 入力文字列の整形処理
	function input_str_convert($str)
	{
	 if($str != "")
	  {
	   // 文字列の前後の半角スペースを削除
	   $str = trim($str);
	   // 半角カタカナを全角カタカナに変換
	   // V: 濁点付きの文字を１文字に変換
	   // K: 半角カタカナを全角カタカナに変換
	   $str = mb_convert_kana($str,'KV');
	  }
	  return $str;
	}

	// -----------------------------------------------
	// 1個の記事本文の表示
	function message_disp(&$arr_message)
	{
	/*
	$arr_message['id'] ：記事番号
	$arr_message['name'] ：投稿者氏名
	$arr_message['mail'] ：投稿者メールアドレス
	$arr_message['title'] ：記事タイトル
	$arr_message['message'] ：記事本文
	$arr_message['date'] ：投稿日時
	$arr_message['url'] ：関連URL
	*/
	 $str_url = $arr_message['url'];

	// 「削除」用URL
	$str_url_del = EDIT_FILE . "?id=" . $arr_message['id'] . "&command=del";

	// 「更新」用URL
	$str_url_update = EDIT_FILE . "?id=" . $arr_message['id']. "&command=update";

	// 「返信」用URL
	$str_url_response = RESPONSE_FILE . "?id=" . $arr_message['id']
	. "&command=response";
	
	// 「メール」用URL
	$str_url_mail = "mailto:" . $arr_message['mail'];
?&gt;
<table class="bd_w1 bd_solid bd_b
padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
<td>No.&lt;?=$arr_message['id']?&gt; &lt;?=$arr_message['title']?&gt;
<span class="fbold">［&lt;?=$arr_message['name']?&gt;］ </span>
<span class="696969">&lt;?=$arr_message['date']?&gt;</span></td>
<td class='ar'><a href="<?=$str_url_mail?>">メール</a>
<a href="<?=$str_url_response?>">返信</a></td>
</tr>
<tr class="b_w xs">
<td colspan=2>&lt;?=$arr_message['message']?&gt;
&lt;?php
 if($str_url != "")
 {
?&gt;
<br>URL: <a href="<?=$str_url?>">&lt;?=$str_url?&gt;</a></td>
&lt;?php
 }
?&gt;
</tr>
</table>
<table class="bd_w0 w600">
<tr class="xs">
	<td class="ar">
		<a href="<?=$str_url_del?>">削除</a>
		<a href="<?=$str_url_update?>">更新</a></td>
	</td>
</tr>
</table>
&lt;?php
}

// ----------------------------------------------
// ページ単位表示
function page_disp($str_sql,$page,$page_size,$mysqli)
{
/*
$str_sql SQL文
$page ページ番号
$page_size ページサイズ
$db データベース接続リソース
*/

  if($str_sql != "" && $page > 0)
  {   
   // limit句なしでSQL文の実行
   $rs0 = $mysqli->query($str_sql . ";");
   // 全レコード数
   $total_record = $rs0->num_rows;
   // 全ページ数
   $total_page = ceil($total_record / $page_size);
   
  if($page > 0 && $page <= $total_page)
  {
    // ページ数の値が正しい場合
   // オフセットの設定
    $offset = ($page - 1) * $page_size;
    // SQL文にlimit句追加
    $str_sql_limit = $str_sql . " limit " 
             . $offset ."," . $page_size . ";";
    // 指定ページのみ抽出
    $rs = $mysqli->query($str_sql_limit);

   // ページの表示
    print "<p class='ac'>";
    // ページナビゲータの表示
    // ページナビゲータの表示
    page_navigater_disp($str_sql,$page,$total_page,$page_size);
  
    // ページ内全記事の表示
    while($arr_record = $rs->fetch_assoc())
    {
     // 記事データの配列への格納
     $arr_message = array();
     $arr_message['id'] = $arr_record['message_id'];
     $arr_message['name'] = $arr_record['name'];
     $arr_message['title'] = $arr_record['title'];
     $arr_message['message'] = $arr_record['message'];
     $arr_message['date'] = $arr_record['date'];
     $arr_message['url'] = $arr_record['url'];
  
    // 1個の記事本文の表示
     message_disp($arr_message);
     print "<br>\n";
    }
    
   // ページナビゲータの表示
     page_navigater_disp($str_sql,$page,$total_page,$page_size);
     print "</p>";
  
    //結果セットを破棄し，接続を閉じる
    mysqli_free_result($rs);
   }
   //結果セットを破棄し，接続を閉じる
   mysqli_free_result($rs0);
  }
}

// -----------------------------------------------
//
function page_navigater_disp($str_sql,$page,$total_page,$page_size)
{

 // URLエンコード
  $str_sql_encoded = rawurlencode($str_sql);
  // URL文字列生成
  $str_url = THIS_FILE . "?sql=" . $str_sql_encoded
           . "&page=" ;
  // ページナビゲータ表示
  print "<table class='bd_w0'>\n";
  print "<tr>\n";
  print "<td class='al w250'>";
  
 if($page > 1)
  {
   // URL文字列に前のページ番号追加
   $str_url_before = $str_url . ($page - 1);

   print "[<a href=" . $str_url_before . ">前の" 
         . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[前の{$page_size}ページ]</span>";
  }
  
 print "</td>\n";
  print "<td class='ac w100'>\n";
  // 「現在ページ／全ページ数」の表示
  print $page . "／" . $total_page . "    ";
  print "</td>\n";
  print "<td class='ar w250'>\n";

 if($page < $total_page)
  {
   // URL文字列に次ののページ番号追加
   $str_url_next = $str_url . ($page + 1);
   
   print "[<a href=" . $str_url_next . ">次の"    
       . $page_size . "ページ</a>]\n";
  }
  else
  {
   print "<span class='silver'>[次の{$page_size}ページ]</span>";
  }
  print "</td>\n";
  print "</tr>\n";
  print "</table>\n";
  }
  
  // -----------------------------------------------
// 1個の記事本文の表示（確認用）
function message_show(&$arr_message)
{
/*
$arr_message['id'] ：記事番号
$arr_message['name'] ：投稿者氏名
$arr_message['title'] ：記事タイトル
$arr_message['message'] ：記事本文
$arr_message['date'] ：投稿日時
$arr_message['url'] ：関連URL
*/
 $str_url = $arr_message['url'];

 $str_url_del = EDIT_FILE . "?id=" . $arr_message['id']
        . "&command=del";
?&gt;
<table class="bd_w1 bd_solid bd_b
       padding3 bd_spacing0 bd_collapse w600">
<tr class="b_dcdcdc xs">
 <td>No.<?=$arr_message['id']?> <?=$arr_message['title']?>
   <span class="fbold">［<?=$arr_message['name']?>］ </span>
   <span class="696969"><?=$arr_message['date']?></span></td>
</tr>
<tr class="b_w xs">
 <td>&lt;?=$arr_message['message']?&gt;
&lt;?php
 if($str_url != "")
 {
?&gt;
<br>URL: <a href="<?=$str_url?>">&lt;?=$str_url?&gt;</a></td>
&lt;?php
 }
?&gt;
</tr>
</table>
&lt;?php
}
  
?&gt;
</pre>
</p>
<p>（６）メールの送信</p><p>返信記事入力画面でメール送信を「する」がオンの場合，メールを自動送信するようにします．</p> 
  <p class="caution-print">Windows OSの場合，メールは以下のphp.iniで設定されるメールサーバからメールが送信されます．<br>
    <br>
    c:\WINDOWS\php.ini 内の設定<br>
    <br>
    [mail function]<br>
    ; For Win32 only.<br>
  <font color="#FF0000">SMTP = smtp.yc.musashi-tech.ac.jp</h4></font><br>
    smtp_port = 25<br>
    <br>
    ; For Win32 only.<br>
    <font color="#FF0000">sendmail_from = bbs_admin@yc.musashi-tech.ac.jp<br>
    </h4></font></p>
  
<p>response02e.phpで「送信」ボタンがクリックされた場合の処理を以下のように改造します．</p> 
  


response02e.php
    <pre class="brush:php;">
    &lt;?php
include "system02e.php";
include "common.php";
define(THIS_FILE,EDIT_FILE);
include COMMON_BBS_FILE;
$str_charset = "UTF-8";
// ページサイズ
$page_size = 5;
?&gt;
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" >
<title>BBS2</title>
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="common.css">
</head>
<body class="b_ffff99">
&lt;?php
 // データベースへの接続と選択
// データベースサーバへの接続・データベースの選択
 $mysqli = new mysqli($db_host, $db_user, $db_passwd, $db_name);
 
 //クライアント文字コードの通知（文字化け防止）
 $str_sql = "set names utf8;";
 $rs = $mysqli->query($str_sql); 
?&gt;
<!-- 「記事入力」，「全記事表示」のハイパーリンクの表示 -->
<p class="ac">
<a href="<?=MAIN_FILE?>">記事入力</a> ｜ 
<a href="<?=MAIN_FILE?>?page=all">全記事表示</a><br><br>
</p>
&lt;?php

// 「返信」リンクをクリックした場合
if($_GET['command'] == "response")
{
$status = "before";

// データの受信
$parent_id = $_GET['id'];
// 検索用SQL文
$str_sql = "select * from tbl_bbs2 "
. "where message_id = {$parent_id} ;";
$rs = $mysqli->query($str_sql);
// 検索されたレコード数の取得
$select_rows = $rs->num_rows;
if($select_rows > 0)
{
// 検索結果リソースの連想配列への格納
$arr_record = $rs->fetch_assoc();

// 記事データの変数への格納
$str_title = $arr_record['title'];
$str_message = $arr_record['message'];
$str_parent_mail_address = $arr_record['mail'];

// 記事返信画面の表示
//response_form_disp($status,$parent_id,$str_name,$str_title
//,$str_message,$str_url,$str_pwd);
$str_name = "";
$str_mail_address = "";
$str_pwd = "";
$str_url = "";
$mail_send = "";

response_form_disp($status,$parent_id,$str_name,$str_mail_address,
$str_title,$str_message,$str_url,$str_pwd,$str_parent_mail_address,$mail_send);

}
else
{
print "記事番号が間違っています．<br><br>\n";
print "<input type='button' value='戻る' "
. "onClick='history.back()'><br>\n";
}
}

// 「送信」の場合
elseif($_POST['command'] == "送信")
{
$status = "after";
// 親記事番号の受信
$parent_id = $_POST['parent_id'];
$str_parent_mail_address = $_POST['parent_mail_address'];
$mail_send = $_POST['mail_send'];

// 受信データのチェック
$str_error_message = data_check($str_name,$str_title,$str_message
,$str_url,$str_pwd);
if($str_error_message == "")
{
// 現在日時の取得
$str_date = date("Y-m-d H:i:s",time());
// 「message_id」の生成
// tbl_bbs2テーブルのmessage_idの最大値の取得
$str_sql = "select max(message_id) as max_id from tbl_bbs2;";
$rs = $mysqli->query($str_sql);
$arr_record = array();
$arr_record = $rs->fetch_assoc();
$max_id = $arr_record['max_id'];
if($max_id > 0)
{
$new_id = $max_id + 1;
}
else
{
$new_id = 1;
}
// SQL文のためのエスケープ処理
$str_name = $mysqli->real_escape_string($str_name);
$str_title = $mysqli->real_escape_string($str_title);
$str_message = $mysqli->real_escape_string($str_message);

// パスワードの暗号化
disp_var(2,$str_pwd,'$str_pwd');
$enc_pwd = "";
if($str_pwd != "")
{
$enc_pwd = crypt($str_pwd,SALT);
}

// データのテーブルへの保存
$str_sql = "insert into tbl_bbs2 "
. "(message_id,name,title,message,date,url,pwd,parent_id)"
. "values("
. $new_id. ",'" . $str_name . "','" . $str_title
. "','" . $str_message . "','" . $str_date 
. "','" . $str_url . "','" . $enc_pwd 
. "'," . $parent_id . ");";
if(!mysql_query($str_sql,$db))
{
print "<br>ERROR_NO=" . mysql_errno($db) . ":"
. mysql_error($db) . "<br>}";
}

// メール送信
if(MAIL_SEND && $mail_send == "yes")
{
mb_language('Japanese');
$mail_to = $str_parent_mail_address;
$str_subject = $str_title;
$mail_from = "From: " . $str_mail_address;
// メール送信
mb_send_mail($mail_to,$str_subject,$str_message,$mail_from);
}

// データのリセット
$new_id = "";
$str_name = "";
$str_title = "";
$str_message = "";
$str_date = "";
$str_url = "";
$str_pwd = "";

// テーブルのデータの一覧取得（最後に「;」をつけない）
$str_sql = "select * from tbl_bbs2 order by message_id desc";

// 第１ページ目の設定
$page = 1;

// ページ単位表示
page_disp($str_sql,$page,$page_size,$mysqli);
}
else
{
print "<span class='red'>{$str_error_message}</span><br>\n";
// 記事返信画面の表示
response_form_disp($status,$parent_id,$str_name,$str_title
,$str_message,$str_url,$str_pwd);
}
}

 
?>
</pre>
  </p>
<p>たとえば，返信記事入力画面には以下のようにメール送信選択のラジオボタンが表示されます．</p>
 
		<img src="./files/1050216.png" width="600">


</body></html>
